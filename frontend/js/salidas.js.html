// ==========================================
// L√ìGICA DE SALIDAS (CORREGIDA Y LIMPIA)
// ==========================================

// --- 0. INICIALIZACI√ìN (¬°NUEVO!) ---
// Esta funci√≥n se llamar√° autom√°ticamente cada vez que cargues la vista
function iniciarVistaSalidas() {
  console.log("üöÄ Iniciando vista de Salidas limpia...");
  
  // 1. Limpiar Carrito
  COLA_SALIDAS = [];
  renderizarColaSalida();
  
  // 2. Limpiar Formulario
  reiniciarFormularioSalidas();
  
  // 3. Resetear Selector de Producto (Para que no quede el anterior)
  var selProd = document.getElementById("sal_producto");
  if(selProd) selProd.selectedIndex = 0;
  
  // 4. Asegurar que la tabla de lotes est√© oculta
  var divDisp = document.getElementById("div-disponibilidad");
  if(divDisp) { divDisp.innerHTML = ""; divDisp.style.display = "none"; }
}

// --- A. FUNCIONES DEL CARRITO ---

function agregarColaSalida() {
  var item = construirItemSalida(); 
  if (!item) return; 

  var existente = COLA_SALIDAS.find(function(i) {
    return i.lote === item.lote && i.ubicacion_id === item.ubicacion_id;
  });

  if (existente) {
     mostrarToast("Nota: Se sumar√° a la cantidad existente.", "info");
  }

  COLA_SALIDAS.push(item);
  renderizarColaSalida();
  mostrarToast("Agregado al pedido ‚úÖ", "success");
  
  // Limpiamos SOLO los campos de detalle, pero NO el producto seleccionado
  // As√≠ el usuario puede seguir agregando m√°s lotes del mismo producto si quiere
  limpiarCamposSalidaParcial(); 
  
  // Refrescamos la tabla para que se actualice el "Stock Disp." restando lo que acabamos de agregar
  aplicarFIFO(); 
}

function eliminarSal(index) {
    COLA_SALIDAS.splice(index, 1);
    renderizarColaSalida();
    mostrarToast("Item eliminado.", "info");
    if(typeof aplicarFIFO === 'function') aplicarFIFO();
}

function renderizarColaSalida() {
  if(typeof renderColaGenerica === 'function') {
     renderColaGenerica(COLA_SALIDAS, "area-cola-salidas", "tablaColaSalidaBody", "contadorColaSal", "sal");
  }
}

// --- B. PROCESAR PEDIDO ---

function procesarSalidas() {
  if (COLA_SALIDAS.length === 0) {
     return Swal.fire('Pedido Vac√≠o', 'Agrega productos a la lista antes de finalizar.', 'warning');
  }
  abrirModalGenerico('modalLogistica');
}

// --- C. CONFIRMACI√ìN FINAL ---

function confirmarPedidoCompleto() {
  var nombreEl = document.getElementById("log_nombre");
  var nombre = nombreEl ? nombreEl.value.trim() : "";
  
  if (!nombre) return mostrarToast("Falta nombre del cliente", "error");

  if (COLA_SALIDAS.length === 0) {
      return Swal.fire("Error", "El pedido est√° vac√≠o.", "error");
  }

  var btn = document.querySelector(".btn-finish-order") || event.target;
  var txtOriginal = btn.innerText;
  btn.disabled = true;
  btn.innerText = "Procesando...";

  var datosLogistica = {
    idCliente: document.getElementById("log_cliente_select").value || "nuevo",
    nombreCliente: nombre,
    empresa: document.getElementById("log_empresa").value,
    direccion: document.getElementById("log_direccion").value,
    telefono: document.getElementById("log_telefono").value,
    email: document.getElementById("log_email").value,
    tipoEnvio: document.getElementById("log_tipo_envio").value,
    paqueteria: document.getElementById("log_paqueteria").value,
    guia: document.getElementById("log_guia").value,
    costoEnvio: document.getElementById("log_costo").value || 0,
  };
  
  var chkGuardar = document.getElementById("log_guardar_cliente");
  var guardarCli = chkGuardar ? chkGuardar.checked : false;

  if(typeof mostrarCargando === 'function') mostrarCargando("Guardando pedido...");

google.script.run
    .withSuccessHandler(function(res) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      
      if(typeof res === 'string') { try { res = JSON.parse(res); } catch(e){} }

      if (res && res.success) {
          Swal.fire({ 
              title: '¬°Pedido Enviado!', 
              text: 'ID: ' + res.idPedido, 
              icon: 'success' 
          });
          
          // NUEVO: Registrar en Bit√°cora el nuevo pedido
          logActividad("NUEVO PEDIDO", `Cre√≥ el pedido ${res.idPedido} para el cliente: ${nombre} (${COLA_SALIDAS.length} partidas)`);
          
          COLA_SALIDAS = []; 
          renderizarColaSalida();
          limpiarFormularioSalidaTotal();
          cerrarModalGenerico("modalLogistica");
          reiniciarFormularioSalidas(); // Limpieza total
          
          if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
          if(typeof recargarSelectores === 'function') recargarSelectores();
      } else {
          Swal.fire("Error", (res && res.error) ? res.error : "Error desconocido.", "error");
      }
      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    
    .withFailureHandler(function(err) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      console.error(err);
      Swal.fire("Error de Conexi√≥n", err.message, "error");
      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    .procesarPedidoCompleto(datosLogistica, COLA_SALIDAS, guardarCli);
}

// --- D. UTILIDADES Y L√ìGICA DE LIMPIEZA ---

function reiniciarFormularioSalidas() {
  var selProdSearch = document.getElementById("sal_producto_search");
  if(selProdSearch) selProdSearch.value = ""; 
  
  var selProd = document.getElementById("sal_producto");
  if(selProd) selProd.value = ""; 
  
  var divDisp = document.getElementById("div-disponibilidad");
  if(divDisp) { divDisp.innerHTML = ""; divDisp.style.display = "none"; }
  
  limpiarCamposSalidaParcial();
}

function alSeleccionarCliente() {
  var sel = document.getElementById("log_cliente_select");
  var idCliente = sel ? sel.value : "";
  if(typeof LISTA_CLIENTES === 'undefined') return;

  if(!idCliente || idCliente === "") {
     ["log_nombre", "log_empresa", "log_direccion", "log_telefono", "log_email"].forEach(function(id) {
         var el = document.getElementById(id); if(el) el.value = "";
     });
     return;
  }
  var cliente = LISTA_CLIENTES.find(function(c) { return String(c.id) === String(idCliente); });
  if (cliente) {
     if(document.getElementById("log_nombre")) document.getElementById("log_nombre").value = cliente.nombre || "";
     if(document.getElementById("log_empresa")) document.getElementById("log_empresa").value = cliente.empresa || "";
     if(document.getElementById("log_direccion")) document.getElementById("log_direccion").value = cliente.direccion || "";
     if(document.getElementById("log_telefono")) document.getElementById("log_telefono").value = cliente.telefono || "";
     if(document.getElementById("log_email")) document.getElementById("log_email").value = cliente.email || "";
  }
}

function construirItemSalida() {
  var calculo = calcularTotalSalida();
  if (calculo.total == 0) { mostrarToast("Cantidad incorrecta", "error"); return null; }
  
  var elLote = document.getElementById("sal_lote");
  var lote = elLote ? elLote.value.trim() : "";
  if (!lote) { mostrarToast("Selecciona un Lote primero", "warning"); return null; }

  var inputCant = document.getElementById("sal_cantidad");
  var maxPzas = parseFloat(inputCant.getAttribute("data-max-pzas")) || 999999;
  var pzas = parseFloat(inputCant.value);
  
  if (pzas - maxPzas > 0) { mostrarToast("‚ö†Ô∏è Stock insuficiente", "error"); return null; }

  return {
    producto_id: document.getElementById("sal_producto").value,
    // AHORA LEE EL NOMBRE DEL NUEVO BUSCADOR
    nombre_producto: document.getElementById("sal_producto_search").value, 
    presentacion_id: document.getElementById("sal_presentacion").value,
    nombre_presentacion: getTextoSelect("sal_presentacion"),
    ubicacion_id: document.getElementById("sal_ubicacion").value,
    nombre_ubicacion: getTextoSelect("sal_ubicacion"),
    volumen_L: calculo.total,
    unidad_medida: calculo.unidad,
    piezas: pzas,
    lote: lote,
    caducidad: inputCant.getAttribute("data-caducidad") || "---"
  };
}

function calcularTotalSalida() {
  if (typeof calcTotalGenerico === 'function') {
      var total = calcTotalGenerico("sal_presentacion", "sal_cantidad");

      // Buscamos la unidad real en la memoria
      var unidad = "L";
      var selProd = document.getElementById("sal_producto");
      if(window.CACHE_CATALOGOS && selProd && selProd.value) {
          var prodData = window.CACHE_CATALOGOS.productos.find(x => x.id === selProd.value);
          if(prodData && prodData.unidad) {
              let uLower = prodData.unidad.trim().toLowerCase();
              if(uLower === 'unid' || uLower === 'pza' || uLower === 'pieza' || uLower === 'unidad') unidad = 'Pza';
              else if(uLower === 'kg' || uLower === 'kilo') unidad = 'Kg';
          }
      }

      var elTotal = document.getElementById("sal_infoTotal");
      if (elTotal) {
         if(unidad === 'Pza') {
             elTotal.innerText = Math.round(total) + " " + unidad; // Sin decimales
         } else {
             elTotal.innerText = total.toFixed(2) + " " + unidad; // Con decimales
         }
      }
      return { total: total, unidad: unidad };
  }
  return { total: 0, unidad: "L" };
}

function limpiarCamposSalidaParcial() {
  var inputCant = document.getElementById("sal_cantidad");
  if(inputCant) { inputCant.value = ""; inputCant.placeholder = "Cantidad"; inputCant.removeAttribute("data-max-pzas"); }
  
  // MAGIA: En vez de forzar un "0 L", llamamos a la calculadora para que respete la unidad actual
  if(typeof calcularTotalSalida === 'function') {
      calcularTotalSalida();
  } else {
      var elTotal = document.getElementById("sal_infoTotal");
      if(elTotal) elTotal.innerText = "0";
  }
  
  var elLote = document.getElementById("sal_lote"); 
  if(elLote) { elLote.value = ""; elLote.readOnly = false; elLote.style.backgroundColor = "white"; }
  
  var elPres = document.getElementById("sal_presentacion"); 
  if(elPres) { elPres.value = ""; elPres.disabled = false; }
  
  var elUbic = document.getElementById("sal_ubicacion"); 
  if(elUbic) { elUbic.value = ""; elUbic.disabled = false; }
}

function limpiarFormularioSalidaTotal() {
  var ids = ["log_nombre", "log_empresa", "log_direccion", "log_telefono", "log_email", "log_paqueteria", "log_costo", "log_guia"];
  ids.forEach(function(id) { var el = document.getElementById(id); if(el) el.value = ""; });
  var selCli = document.getElementById("log_cliente_select"); if(selCli) selCli.value = "";
  var chk = document.getElementById("log_guardar_cliente"); if(chk) chk.checked = false;
  limpiarCamposSalidaParcial();
}

// --- E. L√ìGICA FIFO (B√öSQUEDA) ---

function aplicarFIFO() {
  var selectProd = document.getElementById("sal_producto");
  var prodId = selectProd ? selectProd.value : null;
  
  // 1. Limpiamos SOLO los campos de abajo, pero NO el producto seleccionado
  limpiarCamposSalidaParcial(); 

  // 2. Si no hay producto (o dice 'Selecciona...'), borramos tabla y salimos
  if (!prodId || prodId === "") {
      var div = document.getElementById("div-disponibilidad");
      if(div) { div.innerHTML = ""; div.style.display = "none"; }
      return;
  }

  // 3. Cargamos datos
  if(typeof mostrarCargando === 'function') mostrarCargando("Buscando stock...");

  google.script.run
    .withSuccessHandler(function(jsonResp) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      
      var resultado;
      try { resultado = JSON.parse(jsonResp); } catch (e) { console.error(e); return; }
      
      if (!resultado.success) { renderizarTablaDisponibilidad([]); return; }
      renderizarTablaDisponibilidad(resultado.lista_completa);
    })
    .withFailureHandler(function(err){
       if(typeof ocultarCargando === 'function') ocultarCargando();
       mostrarError(err);
    })
    .obtenerSugerenciaFIFO(prodId, COLA_SALIDAS);
}

function renderizarTablaDisponibilidad(lista) {
  var div = document.getElementById("div-disponibilidad");
  if (!div) return;
  
  div.innerHTML = ""; 
  div.style.display = "block";

  // 1. Detectar unidad del producto seleccionado para la tabla
  var unidad = "L";
  var selProd = document.getElementById("sal_producto");
  if(window.CACHE_CATALOGOS && selProd && selProd.value) {
      var prodData = window.CACHE_CATALOGOS.productos.find(x => x.id === selProd.value);
      if (prodData && prodData.unidad) {
          let uLower = prodData.unidad.trim().toLowerCase();
          if(uLower === 'unid' || uLower === 'unidad' || uLower === 'pza' || uLower === 'pieza') unidad = 'Pza';
          else if (uLower === 'kg' || uLower === 'kilo') unidad = 'Kg';
      }
  }
  
  var table = document.createElement("table");
  table.style.cssText = "width:100%; font-size:0.85rem; border-collapse:collapse; border:1px solid #eee; background:white; border-radius:8px;";
  
  var thead = document.createElement("tr"); thead.style.background = "#f1f3f5";
  ["Lote", "Caducidad", "Ubic", "Stock Disp."].forEach(function(t) {
      var th = document.createElement("th"); th.innerText = t; th.style.padding = "8px"; th.style.textAlign = "left"; thead.appendChild(th);
  });
  table.appendChild(thead);
  
  var filasAgregadas = 0;

  if (lista && lista.length) { 
      lista.forEach(function(l, idx) {
          var stockNum = parseFloat(l.stock);
          
          if (stockNum > 0.001) {
             var tr = document.createElement("tr");
             tr.id = "fila-lote-" + idx; tr.style.cursor = "pointer"; tr.style.borderBottom = "1px solid #eee";
             tr.style.opacity = "1";
             tr.style.pointerEvents = "auto";

             var fechaCad = l.caducidad || "---";
             tr.onclick = function() { seleccionarLote(l.lote, l.presentacion_id, l.ubicacion_id, l.stock, idx, fechaCad); };
             
             // 2. Formatear la cantidad a mostrar (sin decimales si es Pza)
             var stockDisplay = (unidad === 'Pza') ? Math.round(stockNum) : stockNum.toFixed(2);

             tr.innerHTML = `<td style="padding:8px; font-weight:bold;">${l.lote}</td><td style="padding:8px; color:#d35400;">${fechaCad}</td><td style="padding:8px;">${l.nombre_ubicacion||l.ubicacion_id}</td><td style="padding:8px; text-align:right; color:#27ae60; font-weight:bold;">${stockDisplay} ${unidad}</td>`;
             table.appendChild(tr);
             filasAgregadas++;
          }
      });
  } 
  
  if (filasAgregadas === 0) { 
      table.innerHTML += '<tr><td colspan="4" style="text-align:center; padding:15px; color:#888;">‚ö†Ô∏è No hay stock disponible.</td></tr>'; 
  }
  div.appendChild(table);
}

function seleccionarLote(lote, presId, ubicId, stockMax, indiceFila, caducidad) {
  var elLote = document.getElementById("sal_lote");
  if(elLote) { elLote.value = lote; elLote.readOnly = true; elLote.style.backgroundColor = "#fff5f5"; }
  
  var elPres = document.getElementById("sal_presentacion");
  var volUnitario = 0;
  if(elPres) {
      elPres.value = presId; elPres.disabled = true; // Se bloquea visualmente
      var opt = elPres.options[elPres.selectedIndex];
      if(opt) volUnitario = (typeof parseDecimalFlexible === "function")
          ? parseDecimalFlexible(opt.getAttribute("data-volumen"))
          : (parseFloat(opt.getAttribute("data-volumen")) || 0);
         
         // FALLBACK ANTI-ERRORES
         if (isNaN(volUnitario) || volUnitario === 0) {
             if (opt.text) {
                 var match = opt.text.match(/[\d\.]+/);
                 if (match) {
                     volUnitario = parseFloat(match[0]);
                     if (opt.text.toLowerCase().includes("ml")) volUnitario /= 1000;
                 }
             }
         }
         if (isNaN(volUnitario) || volUnitario === 0) volUnitario = 1;
      }
  }
  
  var elUbic = document.getElementById("sal_ubicacion");
  if(elUbic) { elUbic.value = ubicId; elUbic.disabled = true; }

  var inputCant = document.getElementById("sal_cantidad");
  if (inputCant) {
      inputCant.value = "";
      
      var maxPiezas = 999999;
      if (volUnitario > 0) {
          maxPiezas = Math.floor(stockMax / volUnitario);
      }
      
      inputCant.placeholder = "M√°x: " + maxPiezas + " pzas";
      inputCant.setAttribute("data-max-pzas", maxPiezas);
      inputCant.setAttribute("data-caducidad", caducidad);
      inputCant.focus();
  }
  
  var filas = document.querySelectorAll('[id^="fila-lote-"]');
  filas.forEach(function(f) { f.style.backgroundColor = "transparent"; });
  var activa = document.getElementById("fila-lote-" + indiceFila);
  if (activa) activa.style.backgroundColor = "#e8f0fe"; 
  
  // Refrescar c√°lculo a cero
  if (typeof calcularTotalSalida === 'function') calcularTotalSalida();
}

// INICIALIZAR AL CARGAR
// Esto asegura que la pantalla se limpie si vienes de otra pesta√±a
iniciarVistaSalidas();
