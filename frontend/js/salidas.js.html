// ==========================================
// LÓGICA DE SALIDAS (CON AUTO-LIMPIEZA)
// ==========================================

// --- A. FUNCIONES DEL CARRITO ---

function agregarColaSalida() {
  var item = construirItemSalida(); 
  if (!item) return; 

  // Verificamos duplicados
  var existente = COLA_SALIDAS.find(function(i) {
    return i.lote === item.lote && i.ubicacion_id === item.ubicacion_id;
  });

  if (existente) {
     mostrarToast("Nota: Se sumará a la cantidad existente.", "info");
  }

  COLA_SALIDAS.push(item);
  renderizarColaSalida();
  mostrarToast("Agregado al pedido ✅", "success");
  
  // === CAMBIO CLAVE: REINICIAR FORMULARIO COMPLETO ===
  // Al agregar, limpiamos todo para que el usuario elija el siguiente producto
  reiniciarFormularioSalidas();
}

function eliminarSal(index) {
    COLA_SALIDAS.splice(index, 1);
    renderizarColaSalida();
    mostrarToast("Item eliminado.", "info");
    // Al eliminar, no necesitamos refrescar la tabla porque el formulario ya se reseteó
}

function renderizarColaSalida() {
  if(typeof renderColaGenerica === 'function') {
     renderColaGenerica(COLA_SALIDAS, "area-cola-salidas", "tablaColaSalidaBody", "contadorColaSal", "sal");
  }
}

// --- B. PROCESAR PEDIDO ---

function procesarSalidas() {
  if (COLA_SALIDAS.length === 0) {
     return Swal.fire('Pedido Vacío', 'Agrega productos a la lista antes de finalizar.', 'warning');
  }
  abrirModalGenerico('modalLogistica');
}

// --- C. CONFIRMACIÓN FINAL ---

function confirmarPedidoCompleto() {
  var nombreEl = document.getElementById("log_nombre");
  var nombre = nombreEl ? nombreEl.value.trim() : "";
  
  if (!nombre) return mostrarToast("Falta nombre del cliente", "error");

  if (COLA_SALIDAS.length === 0) {
      return Swal.fire("Error", "El pedido está vacío.", "error");
  }

  var btn = document.querySelector(".btn-finish-order") || event.target;
  var txtOriginal = btn.innerText;
  btn.disabled = true;
  btn.innerText = "Procesando...";

  var datosLogistica = {
    idCliente: document.getElementById("log_cliente_select").value || "nuevo",
    nombreCliente: nombre,
    empresa: document.getElementById("log_empresa").value,
    direccion: document.getElementById("log_direccion").value,
    telefono: document.getElementById("log_telefono").value,
    email: document.getElementById("log_email").value,
    tipoEnvio: document.getElementById("log_tipo_envio").value,
    paqueteria: document.getElementById("log_paqueteria").value,
    guia: document.getElementById("log_guia").value,
    costoEnvio: document.getElementById("log_costo").value || 0,
  };
  
  var chkGuardar = document.getElementById("log_guardar_cliente");
  var guardarCli = chkGuardar ? chkGuardar.checked : false;

  google.script.run
    .withSuccessHandler(function(res) {
      if(typeof res === 'string') { try { res = JSON.parse(res); } catch(e){} }

      if (res && res.success) {
          Swal.fire({ 
              title: '¡Pedido Enviado!', 
              text: 'ID: ' + res.idPedido, 
              icon: 'success' 
          });
          
          // Limpieza Total
          COLA_SALIDAS = []; 
          renderizarColaSalida();
          limpiarFormularioSalidaTotal();
          cerrarModalGenerico("modalLogistica");
          
          // Aseguramos que la pantalla de atrás también esté limpia
          reiniciarFormularioSalidas();
          
          if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
      } else {
          Swal.fire("Error", (res && res.error) ? res.error : "Error desconocido.", "error");
      }
      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    .withFailureHandler(function(err) {
      console.error(err);
      Swal.fire("Error de Conexión", err.message, "error");
      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    .procesarPedidoCompleto(datosLogistica, COLA_SALIDAS, guardarCli);
}

// --- D. UTILIDADES Y LÓGICA DE LIMPIEZA ---

function reiniciarFormularioSalidas() {
  // 1. Resetea el selector de producto
  var selProd = document.getElementById("sal_producto");
  if(selProd) selProd.value = ""; 
  
  // 2. Oculta y vacía la tabla de lotes (ESTO SOLUCIONA TU PROBLEMA)
  var divDisp = document.getElementById("div-disponibilidad");
  if(divDisp) { 
      divDisp.innerHTML = ""; 
      divDisp.style.display = "none"; 
  }
  
  // 3. Limpia los inputs restantes
  limpiarCamposSalidaParcial();
}

function alSeleccionarCliente() {
  var sel = document.getElementById("log_cliente_select");
  var idCliente = sel ? sel.value : "";
  if(typeof LISTA_CLIENTES === 'undefined') return;

  if(!idCliente || idCliente === "") {
     ["log_nombre", "log_empresa", "log_direccion", "log_telefono", "log_email"].forEach(function(id) {
         var el = document.getElementById(id); if(el) el.value = "";
     });
     return;
  }
  var cliente = LISTA_CLIENTES.find(function(c) { return String(c.id) === String(idCliente); });
  if (cliente) {
     if(document.getElementById("log_nombre")) document.getElementById("log_nombre").value = cliente.nombre || "";
     if(document.getElementById("log_empresa")) document.getElementById("log_empresa").value = cliente.empresa || "";
     if(document.getElementById("log_direccion")) document.getElementById("log_direccion").value = cliente.direccion || "";
     if(document.getElementById("log_telefono")) document.getElementById("log_telefono").value = cliente.telefono || "";
     if(document.getElementById("log_email")) document.getElementById("log_email").value = cliente.email || "";
  }
}

function construirItemSalida() {
  var volTotal = calcularTotalSalida(); 
  var esInvalido = (volTotal == 0); 
  if (esInvalido) { mostrarToast("Cantidad incorrecta (0 L)", "error"); return null; }
  
  var elLote = document.getElementById("sal_lote");
  var lote = elLote ? elLote.value.trim() : "";
  if (!lote) { mostrarToast("Selecciona un Lote primero", "warning"); return null; }

  var inputCant = document.getElementById("sal_cantidad");
  var maxPzas = parseFloat(inputCant.getAttribute("data-max-pzas")) || 999999;
  var pzas = parseFloat(inputCant.value);
  
  if (pzas - maxPzas > 0) { mostrarToast("⚠️ Stock insuficiente", "error"); return null; }

  return {
    producto_id: document.getElementById("sal_producto").value,
    nombre_producto: getTextoSelect("sal_producto"),
    presentacion_id: document.getElementById("sal_presentacion").value,
    nombre_presentacion: getTextoSelect("sal_presentacion"),
    ubicacion_id: document.getElementById("sal_ubicacion").value,
    nombre_ubicacion: getTextoSelect("sal_ubicacion"),
    volumen_L: volTotal,
    piezas: pzas,
    lote: lote,
    caducidad: inputCant.getAttribute("data-caducidad") || "---"
  };
}

function calcularTotalSalida() {
  if (typeof calcTotalGenerico === 'function') {
      var total = calcTotalGenerico("sal_presentacion", "sal_cantidad");
      var elTotal = document.getElementById("sal_infoTotal");
      if (elTotal) elTotal.innerText = total.toFixed(2) + " L";
      return total;
  }
  return 0;
}

function limpiarCamposSalidaParcial() {
  var inputCant = document.getElementById("sal_cantidad");
  if(inputCant) { inputCant.value = ""; inputCant.placeholder = "Cantidad"; inputCant.removeAttribute("data-max-pzas"); }
  document.getElementById("sal_infoTotal").innerText = "0 L";
  
  var elLote = document.getElementById("sal_lote"); 
  if(elLote) { elLote.value = ""; elLote.readOnly = false; elLote.style.backgroundColor = "white"; }
  
  var elPres = document.getElementById("sal_presentacion"); 
  if(elPres) { elPres.value = ""; elPres.disabled = false; }
  var elUbic = document.getElementById("sal_ubicacion"); 
  if(elUbic) { elUbic.value = ""; elUbic.disabled = false; }
}

function limpiarFormularioSalidaTotal() {
  var ids = ["log_nombre", "log_empresa", "log_direccion", "log_telefono", "log_email", "log_paqueteria", "log_costo", "log_guia"];
  ids.forEach(function(id) { var el = document.getElementById(id); if(el) el.value = ""; });
  var selCli = document.getElementById("log_cliente_select"); if(selCli) selCli.value = "";
  var chk = document.getElementById("log_guardar_cliente"); if(chk) chk.checked = false;
  limpiarCamposSalidaParcial();
}

// --- E. LÓGICA FIFO ---

function aplicarFIFO() {
  var selectProd = document.getElementById("sal_producto");
  var prodId = selectProd ? selectProd.value : null;
  
  // ARREGLO IMPORTANTE: Si no hay producto, BORRAMOS la tabla inmediatamente
  if (!prodId || prodId === "") {
      var div = document.getElementById("div-disponibilidad");
      if(div) { div.innerHTML = ""; div.style.display = "none"; }
      return;
  }

  google.script.run
    .withSuccessHandler(function(jsonResp) {
      var resultado;
      try { resultado = JSON.parse(jsonResp); } catch (e) { console.error(e); return; }
      
      if (!resultado.success) { renderizarTablaDisponibilidad([]); return; }
      renderizarTablaDisponibilidad(resultado.lista_completa);
    })
    .withFailureHandler(mostrarError)
    .obtenerSugerenciaFIFO(prodId, COLA_SALIDAS);
}

function renderizarTablaDisponibilidad(lista) {
  var div = document.getElementById("div-disponibilidad");
  if (!div) return;
  
  // Si la lista está vacía, ocultamos todo
  if (!lista || lista.length === 0) {
      div.innerHTML = ""; 
      div.style.display = "none";
      return;
  }

  div.innerHTML = ""; 
  div.style.display = "block";
  
  var table = document.createElement("table");
  table.style.cssText = "width:100%; font-size:0.85rem; border-collapse:collapse; border:1px solid #eee; background:white; border-radius:8px;";
  
  var thead = document.createElement("tr"); thead.style.background = "#f1f3f5";
  ["Lote", "Caducidad", "Ubic", "Stock Disp."].forEach(function(t) {
      var th = document.createElement("th"); th.innerText = t; th.style.padding = "8px"; th.style.textAlign = "left"; thead.appendChild(th);
  });
  table.appendChild(thead);
  
  lista.forEach(function(l, idx) {
      var tr = document.createElement("tr");
      tr.id = "fila-lote-" + idx; tr.style.cursor = "pointer"; tr.style.borderBottom = "1px solid #eee";
      
      var stockNum = parseFloat(l.stock);
      
      if (stockNum > 0.001) {
         tr.style.opacity = "1";
         tr.style.pointerEvents = "auto";
      } else {
         tr.style.opacity = "0.5";
         tr.style.pointerEvents = "none";
         l.stock = "0.00";
      }

      var fechaCad = l.caducidad || "---";
      tr.onclick = function() { seleccionarLote(l.lote, l.presentacion_id, l.ubicacion_id, l.stock, idx, fechaCad); };
      
      tr.innerHTML = `<td style="padding:8px; font-weight:bold;">${l.lote}</td><td style="padding:8px; color:#d35400;">${fechaCad}</td><td style="padding:8px;">${l.nombre_ubicacion||l.ubicacion_id}</td><td style="padding:8px; text-align:right; color:#27ae60;">${l.stock} L</td>`;
      table.appendChild(tr);
  });
  div.appendChild(table);
}

function seleccionarLote(lote, presId, ubicId, stockMax, indiceFila, caducidad) {
  var elLote = document.getElementById("sal_lote");
  if(elLote) { elLote.value = lote; elLote.readOnly = true; elLote.style.backgroundColor = "#fff5f5"; }
  
  var elPres = document.getElementById("sal_presentacion");
  var volUnitario = 0;
  if(elPres) {
      elPres.value = presId; elPres.disabled = true;
      var opt = elPres.options[elPres.selectedIndex];
      if(opt) volUnitario = parseFloat(opt.getAttribute("data-volumen")) || 0;
  }
  
  var elUbic = document.getElementById("sal_ubicacion");
  if(elUbic) { elUbic.value = ubicId; elUbic.disabled = true; }

  var inputCant = document.getElementById("sal_cantidad");
  if (inputCant) {
      inputCant.value = "";
      
      var maxPiezas = 9999;
      if (volUnitario > 0) {
          var calculo = Math.floor(stockMax / volUnitario);
          maxPiezas = Math.max(0, calculo);
      }
      
      inputCant.placeholder = "Máx: " + maxPiezas + " pzas";
      inputCant.setAttribute("data-max-pzas", maxPiezas);
      inputCant.setAttribute("data-caducidad", caducidad);
      inputCant.focus();
  }
  
  var filas = document.querySelectorAll('[id^="fila-lote-"]');
  filas.forEach(function(f) { f.style.backgroundColor = "transparent"; });
  var activa = document.getElementById("fila-lote-" + indiceFila);
  if (activa) activa.style.backgroundColor = "#e8f0fe"; 
}