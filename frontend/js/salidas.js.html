// ==========================================
// 5. L√ìGICA DE SALIDAS (FIFO + CHECKOUT)
// ==========================================

function calcularTotalSalida() {
  if (typeof calcTotalGenerico === 'function') {
      const total = calcTotalGenerico("sal_presentacion", "sal_cantidad");
      const elTotal = document.getElementById("sal_infoTotal");
      if (elTotal) elTotal.innerText = total + " L";
      return total;
  }
  return 0;
}

function aplicarFIFO() {
  const selectProd = document.getElementById("sal_producto");
  const prodId = selectProd ? selectProd.value : null;

  // Validaci√≥n robusta
  if (!prodId || prodId === "") return;

  mostrarToast("üîç Analizando lotes y caducidades...", "info");
  
  limpiarCamposSalidaParcial();

  google.script.run
    .withSuccessHandler(function(respuestaTexto) {
      let resultado;
      try {
        resultado = JSON.parse(respuestaTexto);
      } catch (e) {
        console.error(e);
        return;
      }
      
      if (!resultado.success) {
        mostrarToast(resultado.error, "error");
        return;
      }

      // 1. Renderizar tabla (Versi√≥n DOM segura)
      renderizarTablaDisponibilidad(resultado.lista_completa);
      
      // 2. Autoseleccionar FIFO
      const mejor = resultado.mejor_candidato;
      if (mejor) {
          // Seleccionamos la fila 0 por defecto
          seleccionarLote(mejor.lote, mejor.presentacion_id, mejor.ubicacion_id, mejor.stock_real, 0); 
          mostrarToast("Sugerido: " + mejor.lote, "success");
      } else {
          mostrarToast("Sin stock disponible", "warning");
      }
    })
    .withFailureHandler(mostrarError)
    .obtenerSugerenciaFIFO(prodId, (typeof COLA_SALIDAS !== 'undefined') ? COLA_SALIDAS : []);
}

function seleccionarLote(lote, presId, ubicId, stockMax, indiceFila) {
  // Llenar campos
  const elLote = document.getElementById("sal_lote");
  if(elLote) {
      elLote.value = lote;
      elLote.readOnly = true; // Bloquear
      elLote.style.backgroundColor = "#e9ecef";
  }
  
  const elPres = document.getElementById("sal_presentacion");
  if(elPres) {
      elPres.value = presId;
      elPres.disabled = true; // Bloquear
  }
  
  const elUbic = document.getElementById("sal_ubicacion");
  if(elUbic) {
      elUbic.value = ubicId;
      elUbic.disabled = true; // Bloquear
  }

  const inputCant = document.getElementById("sal_cantidad");
  if (inputCant) {
      inputCant.value = "";
      inputCant.placeholder = "M√°x: " + Number(stockMax).toFixed(2) + " L";
      inputCant.setAttribute("data-max-stock", stockMax);
      inputCant.focus();
  }
  
  const elInfo = document.getElementById("sal_infoTotal");
  if(elInfo) elInfo.innerText = "0 L";

  iluminarFilaTabla(indiceFila);
}

// --- VERSI√ìN SEGURA: Sin HTML strings para evitar errores de parser ---
function renderizarTablaDisponibilidad(lista) {
  const div = document.getElementById("div-disponibilidad");
  if (!div) return;
  div.innerHTML = ""; // Limpiar contenido previo
  div.style.display = "block";
  
  // Mensaje de ayuda
  const msg = document.createElement("div");
  msg.style.cssText = "margin-bottom:5px; font-size:0.8rem; color:#666;";
  msg.innerText = "‚ÑπÔ∏è Haz clic en una fila para cambiar de lote.";
  div.appendChild(msg);

  // Crear Tabla
  const table = document.createElement("table");
  table.style.cssText = "width:100%; font-size:0.85rem; border-collapse:collapse; border:1px solid #eee;";
  
  // Encabezados
  const thead = document.createElement("tr");
  thead.style.background = "#f8f9fa";
  
  ["Lote", "Caducidad", "Ubic", "Stock"].forEach(function(titulo) {
      const th = document.createElement("th");
      th.innerText = titulo;
      th.style.padding = "8px";
      th.style.textAlign = "left";
      thead.appendChild(th);
  });
  table.appendChild(thead);
  
  // Filas
  if (lista && lista.length) { // Verificamos que tenga elementos
      lista.forEach(function(l, idx) {
          const tr = document.createElement("tr");
          tr.id = "fila-lote-" + idx;
          tr.style.cursor = "pointer";
          tr.style.borderBottom = "1px solid #eee";
          
          // Evento Clic seguro
          tr.addEventListener("click", function() {
             seleccionarLote(l.lote, l.presentacion_id, l.ubicacion_id, l.stock, idx);
          });
          
          // Celda Lote
          const td1 = document.createElement("td");
          td1.innerText = l.lote;
          td1.style.padding = "8px";
          td1.style.fontWeight = "bold";
          tr.appendChild(td1);
          
          // Celda Caducidad
          const td2 = document.createElement("td");
          td2.innerText = l.fecha_caducidad || l.caducidad || "---";
          td2.style.padding = "8px";
          td2.style.color = "#d35400";
          tr.appendChild(td2);
          
          // Celda Ubic
          const td3 = document.createElement("td");
          td3.innerText = l.nombre_ubicacion || l.ubicacion_id;
          td3.style.padding = "8px";
          tr.appendChild(td3);
          
          // Celda Stock
          const td4 = document.createElement("td");
          td4.innerText = l.stock + " L";
          td4.style.padding = "8px";
          td4.style.textAlign = "right";
          td4.style.color = "#27ae60";
          tr.appendChild(td4);
          
          table.appendChild(tr);
      });
  } else {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 4;
      td.innerText = "Sin stock disponible";
      td.style.padding = "10px";
      td.style.textAlign = "center";
      tr.appendChild(td);
      table.appendChild(tr);
  }
  
  div.appendChild(table);
}

function iluminarFilaTabla(indice) {
  // Limpiar estilos
  const filas = document.querySelectorAll('[id^="fila-lote-"]');
  filas.forEach(function(f) { f.style.backgroundColor = "transparent"; });
  
  // Iluminar activa
  const activa = document.getElementById("fila-lote-" + indice);
  if (activa) activa.style.backgroundColor = "#e8f0fe";
}

function agregarColaSalida() {
  const vol = calcularTotalSalida();
  
  // Validacion segura sin simbolo menor que
  if (!(vol > 0)) return mostrarToast("Cantidad incorrecta", "error");
  
  const elLote = document.getElementById("sal_lote");
  const lote = elLote ? elLote.value.trim() : "";
  
  if (!lote) return mostrarToast("Falta Lote", "error");

  const item = {
    producto_id: document.getElementById("sal_producto").value,
    nombre_producto: getTextoSelect("sal_producto"),
    presentacion_id: document.getElementById("sal_presentacion").value,
    nombre_presentacion: getTextoSelect("sal_presentacion"),
    ubicacion_id: document.getElementById("sal_ubicacion").value,
    nombre_ubicacion: getTextoSelect("sal_ubicacion"),
    volumen_L: vol,
    piezas: document.getElementById("sal_cantidad").value,
    lote: lote,
  };
  
  if(typeof COLA_SALIDAS !== 'undefined') {
      COLA_SALIDAS.push(item);
      renderizarColaSalida();
  }
  
  limpiarCamposSalidaParcial();
  mostrarToast("Agregado al pedido", "success");
}

function limpiarCamposSalidaParcial() {
  const inputCant = document.getElementById("sal_cantidad");
  if(inputCant) {
      inputCant.value = "";
      inputCant.placeholder = "Cantidad";
      inputCant.removeAttribute("data-max-stock");
  }
  
  const elInfo = document.getElementById("sal_infoTotal");
  if(elInfo) elInfo.innerText = "0 L";
  
  const elLote = document.getElementById("sal_lote");
  if(elLote) {
      elLote.value = "";
      elLote.readOnly = false;
      elLote.style.backgroundColor = "white";
  }

  const elPres = document.getElementById("sal_presentacion");
  if(elPres) {
      elPres.value = "";
      elPres.disabled = false;
  }
  
  const elUbic = document.getElementById("sal_ubicacion");
  if(elUbic) {
      elUbic.value = "";
      elUbic.disabled = false;
  }
  
  const div = document.getElementById("div-disponibilidad");
  if(div) div.style.display = "none";
}

function renderizarColaSalida() {
  if(typeof COLA_SALIDAS !== 'undefined' && typeof renderColaGenerica === 'function') {
     renderColaGenerica(COLA_SALIDAS, "area-cola-salidas", "tablaColaSalidaBody", "contadorColaSal", "sal");
  }
}

function getTextoSelect(id) {
  const s = document.getElementById(id);
  // Validacion segura sin simbolo menor que
  if (s && s.selectedIndex !== -1) {
      return s.options[s.selectedIndex].text;
  }
  return "";
}

// --- AUTO-CONEXI√ìN DE EMERGENCIA ---
// Si core.js carg√≥ antes y no encontr√≥ aplicarFIFO, esto lo arregla ahora que s√≠ existe.
(function() {
  const sel = document.getElementById("sal_producto");
  if (sel) {
      // Removemos listeners previos clonando
      const nuevo = sel.cloneNode(true);
      sel.parentNode.replaceChild(nuevo, sel);
      nuevo.addEventListener("change", aplicarFIFO);
      console.log("‚úÖ Evento FIFO conectado desde Salidas.");
  }
})();