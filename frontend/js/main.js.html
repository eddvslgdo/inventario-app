function initApp() {
  cambiarVista('vista-operacion');
  
  // Obtenemos el usuario guardado en sesiÃ³n
  const userEmail = localStorage.getItem("inventario_email");

  // 1. Averiguamos el entorno actual antes de cargar los catÃ¡logos
  google.script.run.withSuccessHandler(mode => {
     updateEnvButton(mode);
     recargarSelectores(); 
  }).getCurrentEnvironment();

  google.script.run.withSuccessHandler((canToggle) => {
    const btn = document.getElementById('btn-env-switch');
    if (!btn) return;
    btn.style.display = canToggle ? 'inline-flex' : 'none';
  }).canToggleEnvironment(userEmail); // AÃ±adimos userEmail aquÃ­
}

function mostrarPantallaLogin() {
    document.getElementById("vista-login").style.display = "flex";
    document.getElementById("app-principal").style.display = "none";
    reiniciarLogin();
    if (typeof ocultarCargando === "function") ocultarCargando();
}

function reiniciarLogin() {
    document.getElementById("input-correo").style.display = "block";
    document.getElementById("input-pin-admin").style.display = "none";
    document.getElementById("input-pin-admin").value = "";
    document.getElementById("btn-login").innerText = "Continuar";
    document.getElementById("btn-login-back").style.display = "none";
    document.getElementById("login-subtitle").innerText = "Ingresa tu correo asignado";
}

function procesarLogin() {
  const email = document.getElementById("input-correo").value.trim();
  const pinField = document.getElementById("input-pin-admin");
  const pin = pinField.value.trim();
  
  if (!email) return Swal.fire("AtenciÃ³n", "Ingresa un correo", "warning");
  
  // Si el campo de la contraseÃ±a ya estÃ¡ visible y estÃ¡ vacÃ­o...
  if (pinField.style.display === "block" && !pin) {
     return Swal.fire("AtenciÃ³n", "Por favor ingresa tu PIN de Administrador", "warning");
  }
  
const btn = document.getElementById("btn-login");
  // Aplicamos las clases de animaciÃ³n y quitamos los puntos (el CSS los pondrÃ¡ solos)
  btn.innerText = "Verificando"; 
  btn.classList.add("loading-dots", "btn-pulsing");
  btn.disabled = true;
  
  ejecutarAutenticacion(email, pin, false);
}

function ejecutarAutenticacion(email, pin, esAutomatico) {
  if (!esAutomatico && typeof mostrarCargando === "function") mostrarCargando("Verificando credenciales...");
  
  google.script.run
    .withSuccessHandler(res => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       const btn = document.getElementById("btn-login");
       if (btn) { 
           btn.innerText = "Continuar"; 
           btn.classList.remove("loading-dots", "btn-pulsing"); 
           btn.disabled = false; 
       }

       if (res.requiresPin) {
          document.getElementById("input-correo").style.display = "none";
          document.getElementById("input-pin-admin").style.display = "block";
          document.getElementById("input-pin-admin").focus();
          document.getElementById("btn-login-back").style.display = "block";
          document.getElementById("btn-login").innerText = "Ingresar";
          document.getElementById("login-subtitle").innerText = "ğŸ”’ Ingresa tu PIN de Administrador";
          return; 
       }

       if (res.success) {
          localStorage.setItem("inventario_email", email);
          if (pin) localStorage.setItem("inventario_pin", pin);
          
          document.getElementById('lbl-usuario-actual').innerText = res.nombre;
          document.getElementById("vista-login").style.display = "none";
          document.getElementById("app-principal").style.display = "block";
          
          if (!esAutomatico) mostrarToast(`Hola, ${res.nombre} ğŸ‘‹`, "success");
          configurarInterfazPorPermisos(res);
       
       // NUEVO FLUJO DE REGISTRO
       } else if (res.notFound) {
          Swal.fire({
             title: 'Usuario no registrado',
             text: `El correo "${email}" no tiene acceso. Â¿Deseas solicitar registro en el sistema?`,
             icon: 'question',
             showCancelButton: true,
             confirmButtonColor: '#007aff',
             cancelButtonColor: '#64748b',
             confirmButtonText: 'SÃ­, registrarme'
          }).then((result) => {
             if (result.isConfirmed) {
                mostrarCargando("Creando usuario...");
                google.script.run
                  .withSuccessHandler(regRes => {
                     ocultarCargando();
                     if (regRes.success) {
                        Swal.fire("Â¡Registro Exitoso!", "Tu usuario ha sido creado. Inicia sesiÃ³n ahora para ver el estatus de tu cuenta.", "success");
                     } else {
                        Swal.fire("Error", regRes.error, "error");
                     }
                  })
                  .withFailureHandler(err => {
                     ocultarCargando();
                     Swal.fire("Error", err.message, "error");
                  })
                  .registrarUsuarioPendiente(email);
             }
          });
          localStorage.removeItem("inventario_email");
          localStorage.removeItem("inventario_pin");
       } else {
          localStorage.removeItem("inventario_email");
          localStorage.removeItem("inventario_pin");
          mostrarPantallaLogin();
          if (!esAutomatico) Swal.fire("Acceso Denegado", res.error, "error");
       }
    })
    .withFailureHandler(err => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       localStorage.removeItem("inventario_email");
       localStorage.removeItem("inventario_pin");
       const btn = document.getElementById("btn-login");
       if (btn) { 
           btn.innerText = "Continuar"; 
           btn.classList.remove("loading-dots", "btn-pulsing"); 
           btn.disabled = false; 
       }
       Swal.fire("Error de ConexiÃ³n", "No se pudo verificar el acceso.", "error");
    })
    .procesarLoginEmail(email, pin);
}

function configurarInterfazPorPermisos(info) {
  // 1. Mostrar Botones Exclusivos SOLO si es Admin
  const btnEnv = document.getElementById('btn-env-switch');
  const btnAdmin = document.getElementById('nav-admin');
  
  if (btnEnv) btnEnv.style.display = info.esAdmin ? 'block' : 'none';
  if (btnAdmin) btnAdmin.style.display = info.esAdmin ? 'inline-block' : 'none';
  
  // 2. Encender o APAGAR botones de MenÃº Operativos (AQUÃ ESTABA EL ERROR)
  // Ahora forzamos explÃ­citamente a que se oculten si no tienen permiso
  document.getElementById('nav-entradas').style.display = info.permisos.entradas ? 'inline-block' : 'none';
  document.getElementById('nav-salidas').style.display = info.permisos.salidas ? 'inline-block' : 'none';
  document.getElementById('nav-ubicaciones').style.display = info.permisos.ubicaciones ? 'inline-block' : 'none';
  document.getElementById('nav-productos').style.display = info.permisos.productos ? 'inline-block' : 'none';
  document.getElementById('nav-pedidos').style.display = info.permisos.envios ? 'inline-block' : 'none';
  document.getElementById('nav-bajas').style.display = info.permisos.bajas ? 'inline-block' : 'none';
  
  // 3. Forzar redirecciÃ³n a la primera vista que tenga habilitada
  if (info.permisos.entradas) cambiarVista('vista-operacion');
  else if (info.permisos.envios) cambiarVista('vista-pedidos');
  else if (info.permisos.salidas) cambiarVista('vista-salidas');
  else if (info.permisos.productos) cambiarVista('vista-productos');
else if (info.permisos.ubicaciones) cambiarVista('vista-ubicaciones');
  else if (info.permisos.bajas) cambiarVista('vista-bajas');
  else {
      // NUEVO: Candado extra - Si no tiene NINGÃšN permiso, le mostramos la pantalla de "Cuenta en revisiÃ³n"
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      let vistaRevision = document.getElementById('vista-sin-permisos');
      if (vistaRevision) vistaRevision.style.display = 'flex';
      
      Swal.fire("En espera de autorizaciÃ³n", "Un Administrador debe otorgarte permisos para operar el sistema.", "info");
  }
  // 4. Arrancar datos
  updateEnvButton(info.entorno);
  recargarSelectores();
}

// CERRAR SESIÃ“N (Regresa al Login inmediatamente)
// CERRAR SESIÃ“N (Regresa al Login inmediatamente sin recargar la pÃ¡gina)
function cerrarSesion() {
  // 1. Borramos la memoria del dispositivo
  localStorage.removeItem("inventario_email");
  localStorage.removeItem("inventario_pin");
  
  // 2. Ocultamos la app y mostramos el Login dinÃ¡micamente
  document.getElementById("app-principal").style.display = "none";
  document.getElementById("vista-login").style.display = "flex";
  
  // 3. Limpiamos los campos visualmente
  reiniciarLogin();
  document.getElementById("input-correo").value = "";
}
// ==========================================
// FIX: FUNCIONES DE ENTORNO REPARADAS
// ==========================================

function toggleEnvironment() {
   const btn = document.getElementById('btn-env-switch');
   const isProd = btn.innerText.includes('PRODUCCIÃ“N');
   const newMode = isProd ? 'TEST' : 'PROD';
   
   // NUEVO: Obtenemos el usuario de la memoria del navegador
   const userEmail = localStorage.getItem("inventario_email"); 
   
   Swal.fire({
      title: 'Cambiando entorno...',
      text: 'Conectando con la base de datos...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
   });
   
   google.script.run.withSuccessHandler(mode => {
      updateEnvButton(mode);
      recargarSelectores();
      if(document.getElementById('vista-productos').style.display !== 'none') cargarDashboardProductos();
      if(document.getElementById('vista-ubicaciones').style.display !== 'none') cargarDashboardUbicaciones();
      if(document.getElementById('vista-pedidos').style.display !== 'none') cargarDashboardPedidos();
      if(document.getElementById('vista-bajas').style.display !== 'none') cargarCaducados();
      
      Swal.fire('Â¡Cambiado!', `EstÃ¡s en la base de:\n${mode === 'PROD' ? 'ğŸŸ¢ PRODUCCIÃ“N' : 'ğŸ§ª PRUEBAS'}`, 'success');
   }).withFailureHandler((err) => {
      Swal.fire('Sin permiso', err.message || 'No autorizado para cambiar entorno.', 'error');
   }).switchEnvironment(newMode, userEmail); // NUEVO: Pasamos el userEmail al backend
}

function updateEnvButton(mode) {
   const btn = document.getElementById('btn-env-switch');
   if(!btn) return;
   if(mode === 'TEST') {
      btn.style.background = '#f39c12'; 
      btn.innerHTML = 'ğŸ§ª MODO: PRUEBAS';
   } else {
      btn.style.background = '#2ecc71'; 
      btn.innerHTML = 'ğŸŸ¢ MODO: PRODUCCIÃ“N';
   }
}

// ==========================================
// MÃ“DULO DE NOTIFICACIONES Y PERFIL
// ==========================================

window.toggleMenuUsuario = function() {
   let panel = document.getElementById("panel-notificaciones");
   panel.style.display = panel.style.display === "none" ? "block" : "none";
};

// Cierra el menÃº si haces clic afuera
document.addEventListener('click', function(event) {
    let panel = document.getElementById("panel-notificaciones");
    let boton = document.querySelector("button[onclick='toggleMenuUsuario()']");
    if (panel && panel.style.display === "block") {
        if (!panel.contains(event.target) && !boton.contains(event.target)) {
            panel.style.display = "none";
        }
    }
});

function actualizarNotificaciones() {
   if(typeof LISTA_PEDIDOS_CACHE === 'undefined' || !LISTA_PEDIDOS_CACHE) return;
   
   let pedidosPendientes = [];
   let pedidosSinGuia = [];

   // Analizamos el cachÃ© de pedidos sin hacer llamadas extra al servidor
   LISTA_PEDIDOS_CACHE.forEach(p => {
      let st = p.estatus || "Pendiente";
      if (st === "Pendiente") pedidosPendientes.push(p);
      
      let enProceso = st.includes('Enviado') || st.includes('Camino') || st.includes('Proceso');
      if (enProceso && (!p.guia || p.guia === "---" || p.guia.trim() === "")) {
         pedidosSinGuia.push(p);
      }
   });

   let totalNotif = pedidosPendientes.length + pedidosSinGuia.length;
   let badge = document.getElementById("badge-notif");
   if (badge) {
       badge.innerText = totalNotif;
       badge.style.display = totalNotif > 0 ? "inline-block" : "none";
   }

   let listaHtml = "";
   if (totalNotif === 0) {
       listaHtml = "<div style='padding: 20px; text-align: center; color: #94a3b8; font-size: 0.9rem;'>No hay tareas pendientes ğŸ‰</div>";
   } else {
       if (pedidosPendientes.length > 0) {
           listaHtml += `<div style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'" onclick="cambiarVista('vista-pedidos'); filtrarEstado('Pendiente', null); toggleMenuUsuario();">
                            <div style="font-weight: bold; color: #d97706; font-size: 0.95rem;">â³ ${pedidosPendientes.length} Pedido(s) Pendiente(s)</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top:3px;">Falta procesar su envÃ­o o entrega. Toca para verlos.</div>
                         </div>`;
       }
       if (pedidosSinGuia.length > 0) {
           listaHtml += `<div style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'" onclick="cambiarVista('vista-pedidos'); filtrarEstado('Enviado', null); toggleMenuUsuario();">
                            <div style="font-weight: bold; color: #dc2626; font-size: 0.95rem;">ğŸ« ${pedidosSinGuia.length} EnvÃ­o(s) sin GuÃ­a</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top:3px;">EstÃ¡n en ruta pero les falta el # de rastreo.</div>
                         </div>`;
       }
   }
   
   let panelLista = document.getElementById("lista-notificaciones");
   if(panelLista) panelLista.innerHTML = listaHtml;
}