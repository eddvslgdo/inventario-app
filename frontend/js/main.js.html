function initApp() {
  cambiarVista('vista-operacion');
  
  // 1. Averiguamos el entorno actual antes de cargar los catÃ¡logos
  google.script.run.withSuccessHandler(mode => {
     updateEnvButton(mode);
     recargarSelectores(); 
  }).getCurrentEnvironment();
}

function toggleEnvironment() {
   const btn = document.getElementById('btn-env-switch');
   const isProd = btn.innerText.includes('PRODUCCIÃ“N');
   const newMode = isProd ? 'TEST' : 'PROD';
   
   Swal.fire({
      title: 'Cambiando entorno...',
      text: 'Conectando con la base de datos...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
   });
   
   google.script.run.withSuccessHandler(mode => {
      updateEnvButton(mode);
      
      // Recargamos TODO para limpiar la cachÃ© de la vista anterior
      recargarSelectores();
      if(document.getElementById('vista-productos').style.display !== 'none') cargarDashboardProductos();
      if(document.getElementById('vista-ubicaciones').style.display !== 'none') cargarDashboardUbicaciones();
      if(document.getElementById('vista-pedidos').style.display !== 'none') cargarDashboardPedidos();
      if(document.getElementById('vista-bajas').style.display !== 'none') cargarCaducados();
      
      Swal.fire('Â¡Cambiado!', `Ahora estÃ¡s trabajando en la base de datos de:\n${mode === 'PROD' ? 'ðŸŸ¢ PRODUCCIÃ“N' : 'ðŸ§ª PRUEBAS'}`, 'success');
   }).switchEnvironment(newMode);
}

function updateEnvButton(mode) {
   const btn = document.getElementById('btn-env-switch');
   if(!btn) return;
   if(mode === 'TEST') {
      btn.style.background = '#f39c12'; 
      btn.innerHTML = 'ðŸ§ª MODO: PRUEBAS';
   } else {
      btn.style.background = '#2ecc71'; 
      btn.innerHTML = 'ðŸŸ¢ MODO: PRODUCCIÃ“N';
   }
}