// =========================================================
// VARIABLES GLOBALES DE SESI√ìN
// =========================================================
window.heartbeatInterval = null;
window.teniaPermisoEscritura = true; 

// Estado interno para no depender de leer el DOM
window.APP_STATE = {
   env: "PROD" 
};

// =========================================================
// INICIALIZACI√ìN DE LA APLICACI√ìN
// =========================================================
function initApp() {
  cambiarVista('vista-operacion');
  
  // Volvemos a localStorage para estabilidad
  const userEmail = localStorage.getItem("inventario_email");

  google.script.run.withSuccessHandler(mode => {
     window.APP_STATE.env = mode;
     updateEnvButton(mode);
     recargarSelectores(); 
  }).getCurrentEnvironment();

  if(userEmail) {
      google.script.run.withSuccessHandler((canToggle) => {
        const btn = document.getElementById('btn-env-switch');
        if (btn) btn.style.display = canToggle ? 'inline-flex' : 'none';
      }).canToggleEnvironment(userEmail); 
  }
}

// =========================================================
// FLUJO DE LOGIN
// =========================================================
function mostrarPantallaLogin() {
    document.getElementById("vista-login").style.display = "flex";
    document.getElementById("app-principal").style.display = "none";
    reiniciarLogin();
    if (typeof ocultarCargando === "function") ocultarCargando();
}

function reiniciarLogin() {
    document.getElementById("input-correo").style.display = "block";
    document.getElementById("input-pin-admin").style.display = "none";
    document.getElementById("input-pin-admin").value = "";
    document.getElementById("btn-login").innerText = "Continuar";
    document.getElementById("btn-login-back").style.display = "none";
    document.getElementById("login-subtitle").innerText = "Ingresa tu usuario asignado";
}

function procesarLogin() {
  const email = document.getElementById("input-correo").value.trim();
  const pinField = document.getElementById("input-pin-admin");
  const pin = pinField.value.trim();
  
  if (!email) return Swal.fire("Atenci√≥n", "Ingresa un correo", "warning");
  if (pinField.style.display === "block" && !pin) return Swal.fire("Atenci√≥n", "Ingresa tu PIN", "warning");
  
  const btn = document.getElementById("btn-login");
  btn.innerText = "Verificando"; 
  btn.classList.add("loading-dots", "btn-pulsing");
  btn.disabled = true;
  
  ejecutarAutenticacion(email, pin, false);
}

function ejecutarAutenticacion(email, pin, esAutomatico) {
  if (!esAutomatico && typeof mostrarCargando === "function") mostrarCargando("Verificando credenciales...");
  
  google.script.run
    .withSuccessHandler(res => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       const btn = document.getElementById("btn-login");
       if (btn) { btn.innerText = "Continuar"; btn.classList.remove("loading-dots", "btn-pulsing"); btn.disabled = false; }

       if (res.requiresPin) {
          document.getElementById("input-correo").style.display = "none";
          document.getElementById("input-pin-admin").style.display = "block";
          document.getElementById("input-pin-admin").focus();
          document.getElementById("btn-login-back").style.display = "block";
          document.getElementById("btn-login").innerText = "Ingresar";
          document.getElementById("login-subtitle").innerText = "üîí Ingresa tu PIN de Administrador";
          return; 
       }

       if (res.success) {
          // GUARDAMOS TODO EN LOCAL STORAGE
          localStorage.setItem("inventario_email", email);
          localStorage.setItem("inventario_rol", res.esAdmin ? "admin" : "user");
          
          document.getElementById('lbl-usuario-actual').innerText = res.nombre;
          document.getElementById("vista-login").style.display = "none";
          document.getElementById("app-principal").style.display = "block";
          
          configurarInterfazPorPermisos(res);
          if (!esAutomatico) mostrarToast(`Hola, ${res.nombre} üëã`, "success");
          
          iniciarLatido(); 

       } else if (res.notFound) {
          Swal.fire({
             title: 'Usuario no registrado',
             text: `El correo "${email}" no tiene acceso.`,
             icon: 'question',
             showCancelButton: true,
             confirmButtonText: 'S√≠, solicitar registro'
          }).then((result) => {
             if (result.isConfirmed) {
                mostrarCargando("Creando usuario...");
                google.script.run
                  .withSuccessHandler(regRes => { ocultarCargando(); Swal.fire("¬°Registro Exitoso!", "Cuenta en revisi√≥n.", "success"); })
                  .registrarUsuarioPendiente(email);
             }
          });
          localStorage.removeItem("inventario_email");
       } else {
          localStorage.removeItem("inventario_email");
          mostrarPantallaLogin();
          if (!esAutomatico) Swal.fire("Acceso Denegado", res.error, "error");
       }
    })
    .withFailureHandler(err => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       localStorage.clear();
       mostrarPantallaLogin();
       Swal.fire("Error de Conexi√≥n", "Fallo al verificar el acceso.", "error");
    })
    .procesarLoginEmail(email, pin);
}

// =========================================================
// SISTEMA DE JERARQU√çA Y BLOQUEO (EL LATIDO)
// =========================================================
function iniciarLatido() {
   if (window.heartbeatInterval) clearInterval(window.heartbeatInterval);
   
   window.heartbeatInterval = setInterval(function() {
      const email = localStorage.getItem("inventario_email");
      const rol = localStorage.getItem("inventario_rol") || "user"; 
      const env = window.APP_STATE.env; 
      const vistaActual = obtenerVistaActiva();
      
      if (!email) return;

      google.script.run
        .withSuccessHandler(function(estado) {
           // Si el servidor estaba ocupado escribiendo datos de otro usuario, ignoramos este tick
           if (estado && estado.ignorarPing) return;

           if (!estado || !estado.sigueActivo) {
              clearInterval(window.heartbeatInterval);
              cerrarSesion();
              return Swal.fire('Sesi√≥n Finalizada', 'Tu sesi√≥n expir√≥ o fue cerrada remotamente.', 'warning');
           }
           
if (rol === "admin" && vistaActual === "vista-admin" && typeof renderizarTablaUsuariosEnLinea === 'function') {
               // ¬°AQU√ç FALTABA PASARLE EL ESCRITOR ACTUAL! üëá
               renderizarTablaUsuariosEnLinea(estado.listaUsuarios, estado.escritorActual);
           }
           
           
           // TRANSICIONES DE ESTADO (Escritura vs Solo Lectura)
           if (estado.tengoPermiso) {
               if (!window.teniaPermisoEscritura) {
                   window.teniaPermisoEscritura = true;
                   desbloquearInterfaz();
                   mostrarToast("‚ú® Permisos restaurados. Tienes el control.", "success");
               }
           } else {
               if (window.teniaPermisoEscritura) {
                   window.teniaPermisoEscritura = false;
                   mostrarToast("üëÅÔ∏è Modo Solo Lectura activado.", "warning");
               }
               // Siempre actualizamos el banner por si el l√≠der cambi√≥ (Ej: De Eduardo a Yair)
               bloquearInterfaz(estado.escritorActual);
           }
        })
        .pingSesion(email, rol, env, vistaActual);
   }, 8000); 
}

function obtenerVistaActiva() {
    let vistaActiva = "desconocida";
    document.querySelectorAll('.vista').forEach(v => {
        if (v.style.display !== 'none' && v.style.display !== '') vistaActiva = v.id;
    });
    return vistaActiva;
}

function bloquearInterfaz(escritor) {
    // 1. Seleccionamos inputs, selects y TODOS los botones de la interfaz
    document.querySelectorAll('.vista input, .vista select, .vista button, .modal-content input, .modal-content select, .modal-content button').forEach(el => {
        
        const id = (el.id || '').toLowerCase();
        const onclickStr = (el.getAttribute('onclick') || '').toLowerCase();
        const textStr = (el.innerText || '').toLowerCase();

        // REGLA A: Dejamos vivos los campos de b√∫squeda y filtros
        const esBuscador = id.includes('buscador') || id.includes('filtro') || id.includes('search');
        
        // REGLA B: Dejamos vivos los botones inofensivos (Cerrar, Cancelar, Navegar, Ver detalles)
        const esInofensivo = 
            onclickStr.includes('cerrar') || 
            onclickStr.includes('cancelar') || 
            onclickStr.includes('verdetalle') || 
            onclickStr.includes('toggle') || 
            onclickStr.includes('filtrar') || 
            textStr.includes('cerrar') || 
            textStr.includes('cancelar') || 
            textStr.includes('gestionar') || 
            textStr.includes('ver ‚ñº') ||
            el.classList.contains('nav-btn') || 
            el.classList.contains('filter-tab') ||
            textStr === 'x' || textStr === '√ó'; // Botones de "tache" en modales

        // Si NO es buscador y NO es inofensivo -> LO BLOQUEAMOS
        if (!esBuscador && !esInofensivo) {
            el.disabled = true;
            el.style.opacity = '0.5';
            el.style.cursor = 'not-allowed';
        }
    });

    // 2. Dibujar el Banner de manera no invasiva
    let banner = document.getElementById("banner-solo-lectura");
    if (!banner) {
        banner = document.createElement("div");
        banner.id = "banner-solo-lectura";
        
        // CORRECCI√ìN: Bajamos el z-index a 900. 
        // As√≠ el men√∫ queda protegido, pero si abres un Modal (z-index 1000+), el modal tapar√° el banner.
        banner.style.cssText = "background:#fee2e2; color:#dc2626; text-align:center; padding:8px; font-weight:bold; font-size:0.85rem; border-bottom:2px solid #fca5a5; position:sticky; top:0; z-index:900;";
        
        const navBar = document.querySelector('.nav-bar');
        if (navBar && navBar.parentNode) {
            navBar.parentNode.insertBefore(banner, navBar.nextSibling);
        } else {
            document.getElementById("app-principal").prepend(banner);
        }
    }
    banner.innerHTML = `üëÅÔ∏è MODO SOLO LECTURA. <span style="font-weight:normal;">(<strong>${escritor}</strong> tiene el control temporal)</span>`;
    banner.style.display = "block";
}

function desbloquearInterfaz() {
    // Reactivamos todo y regresamos el cursor a la normalidad
    document.querySelectorAll('.vista input, .vista select, .vista button, .modal-content input, .modal-content select, .modal-content button').forEach(el => {
        el.disabled = false;
        el.style.opacity = '1';
        el.style.cursor = 'pointer'; 
    });
    
    let banner = document.getElementById("banner-solo-lectura");
    if (banner) banner.style.display = "none";
}

// =========================================================
// CONFIGURACI√ìN DE LA INTERFAZ Y ENTORNOS
// =========================================================
function configurarInterfazPorPermisos(info) {
  const btnEnv = document.getElementById('btn-env-switch');
  const btnAdmin = document.getElementById('nav-admin');
  
  if (btnEnv) btnEnv.style.display = info.esAdmin ? 'block' : 'none';
  if (btnAdmin) btnAdmin.style.display = info.esAdmin ? 'inline-block' : 'none';
  
  document.getElementById('nav-entradas').style.display = info.permisos.entradas ? 'inline-block' : 'none';
  document.getElementById('nav-salidas').style.display = info.permisos.salidas ? 'inline-block' : 'none';
  document.getElementById('nav-ubicaciones').style.display = info.permisos.ubicaciones ? 'inline-block' : 'none';
  document.getElementById('nav-productos').style.display = info.permisos.productos ? 'inline-block' : 'none';
  document.getElementById('nav-pedidos').style.display = info.permisos.envios ? 'inline-block' : 'none';
  document.getElementById('nav-bajas').style.display = info.permisos.bajas ? 'inline-block' : 'none';
  
  if (info.permisos.entradas) cambiarVista('vista-operacion');
  else if (info.permisos.envios) cambiarVista('vista-pedidos');
  else if (info.permisos.salidas) cambiarVista('vista-salidas');
  else if (info.permisos.productos) cambiarVista('vista-productos');
  else if (info.permisos.ubicaciones) cambiarVista('vista-ubicaciones');
  else if (info.permisos.bajas) cambiarVista('vista-bajas');
  else {
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      let vistaRevision = document.getElementById('vista-sin-permisos');
      if (vistaRevision) vistaRevision.style.display = 'flex';
      Swal.fire("En espera de autorizaci√≥n", "Un Administrador debe otorgarte permisos para operar el sistema.", "info");
  }
  
  window.APP_STATE.env = info.entorno;
  updateEnvButton(info.entorno);
  recargarSelectores();

  if (info.permisos.envios && typeof api !== 'undefined') {
      api.obtenerHistorialPedidos(function(lista) {
          window.LISTA_PEDIDOS_CACHE = lista || [];
          if(typeof actualizarNotificaciones === 'function') actualizarNotificaciones();
      }, function(err) { console.warn("Error background notificaciones", err); });
  }
}

function toggleEnvironment() {
   const btn = document.getElementById('btn-env-switch');
   const isProd = btn.innerText.includes('PRODUCCI√ìN');
   const newMode = isProd ? 'TEST' : 'PROD';
   const userEmail = localStorage.getItem("inventario_email"); 
   
   Swal.fire({ title: 'Cambiando entorno...', text: 'Conectando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
   
   google.script.run.withSuccessHandler(mode => {
      window.APP_STATE.env = mode;
      updateEnvButton(mode);
      recargarSelectores();
      if(document.getElementById('vista-productos').style.display !== 'none') cargarDashboardProductos();
      if(document.getElementById('vista-ubicaciones').style.display !== 'none') cargarDashboardUbicaciones();
      if(document.getElementById('vista-pedidos').style.display !== 'none') cargarDashboardPedidos();
      if(document.getElementById('vista-bajas').style.display !== 'none') cargarCaducados();
      Swal.fire('¬°Cambiado!', `Est√°s en:\n${mode === 'PROD' ? 'üü¢ PRODUCCI√ìN' : 'üß™ PRUEBAS'}`, 'success');
   }).withFailureHandler((err) => {
      Swal.fire('Sin permiso', err.message, 'error');
   }).switchEnvironment(newMode, userEmail); 
}

function updateEnvButton(mode) {
   const btn = document.getElementById('btn-env-switch');
   if(!btn) return;
   if(mode === 'TEST') {
      btn.style.background = '#f39c12'; btn.innerHTML = 'üß™ MODO: PRUEBAS';
   } else {
      btn.style.background = '#2ecc71'; btn.innerHTML = 'üü¢ MODO: PRODUCCI√ìN';
   }
}

function cerrarSesion() {
   if (window.heartbeatInterval) clearInterval(window.heartbeatInterval);
   const email = localStorage.getItem("inventario_email");
   if(email) google.script.run.registrarCierreSesion(email);
   localStorage.clear();
   document.getElementById("app-principal").style.display = "none";
   document.getElementById("vista-login").style.display = "flex";
   reiniciarLogin();
   document.getElementById("input-correo").value = "";
}

// =========================================================
// CAMPANA DE NOTIFICACIONES Y OTROS
// =========================================================
window.toggleMenuUsuario = function() {
   let panel = document.getElementById("panel-notificaciones");
   panel.style.display = panel.style.display === "none" ? "block" : "none";
};

document.addEventListener('click', function(event) {
    let panel = document.getElementById("panel-notificaciones");
    let boton = document.querySelector("button[onclick='toggleMenuUsuario()']");
    if (panel && panel.style.display === "block") {
        if (!panel.contains(event.target) && !boton.contains(event.target)) panel.style.display = "none";
    }
});

function actualizarNotificaciones() {
   if(typeof LISTA_PEDIDOS_CACHE === 'undefined' || !LISTA_PEDIDOS_CACHE) return;
   
   let pedidosPendientes = [];
   let pedidosSinGuia = [];

   LISTA_PEDIDOS_CACHE.forEach(p => {
      let st = p.estatus || "Pendiente";
      if (st === "Pendiente") pedidosPendientes.push(p);
      
      let enProceso = st.includes('Enviado') || st.includes('Camino') || st.includes('Proceso');
      if (enProceso && (!p.guia || p.guia === "---" || p.guia.trim() === "")) {
         pedidosSinGuia.push(p);
      }
   });

   let totalNotif = pedidosPendientes.length + pedidosSinGuia.length;
   let badge = document.getElementById("badge-notif");
   if (badge) {
       badge.innerText = totalNotif;
       badge.style.display = totalNotif > 0 ? "inline-block" : "none";
   }

   let listaHtml = "";
   if (totalNotif === 0) {
       listaHtml = "<div style='padding: 20px; text-align: center; color: #94a3b8; font-size: 0.9rem;'>No hay tareas pendientes üéâ</div>";
   } else {
       if (pedidosPendientes.length > 0) {
           listaHtml += `<div style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'" onclick="cambiarVista('vista-pedidos'); filtrarEstado('Pendiente', null); toggleMenuUsuario();">
                            <div style="font-weight: bold; color: #d97706; font-size: 0.95rem;">‚è≥ ${pedidosPendientes.length} Pedido(s) Pendiente(s)</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top:3px;">Falta procesar su env√≠o o entrega.</div>
                         </div>`;
       }
       if (pedidosSinGuia.length > 0) {
           listaHtml += `<div style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'" onclick="cambiarVista('vista-pedidos'); filtrarEstado('Enviado', null); toggleMenuUsuario();">
                            <div style="font-weight: bold; color: #dc2626; font-size: 0.95rem;">üé´ ${pedidosSinGuia.length} Env√≠o(s) sin Gu√≠a</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top:3px;">Est√°n en ruta pero les falta el # de rastreo.</div>
                         </div>`;
       }
   }
   let panelLista = document.getElementById("lista-notificaciones");
   if(panelLista) panelLista.innerHTML = listaHtml;
}

window.liberarSistemaRemoto = function() {
   Swal.fire({
      title: '¬øForzar Liberaci√≥n?',
      text: 'Esto cerrar√° la sesi√≥n de cualquier usuario que est√© operando el sistema actualmente.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      confirmButtonText: 'S√≠, liberar ahora'
   }).then((result) => {
      if (result.isConfirmed) {
         mostrarCargando("Liberando sistema...");
         google.script.run
           .withSuccessHandler(() => {
              ocultarCargando();
              Swal.fire('¬°Liberado!', 'El sistema est√° libre y accesible nuevamente.', 'success');
           })
           .withFailureHandler((err) => {
              ocultarCargando();
              Swal.fire('Error', err.message, 'error');
           })
           .LIBERAR_SISTEMA();
      }
   });
};

// =========================================================
// MONITOR EN VIVO DE USUARIOS CONECTADOS (PANEL ADMIN)
// =========================================================
window.renderizarTablaUsuariosEnLinea = function(listaUsuarios, escritorActual) {
    const tbody = document.getElementById("tablaUsuariosEnLineaBody");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!listaUsuarios || listaUsuarios.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #94a3b8; padding: 10px;">No hay otros usuarios conectados.</td></tr>`;
        return;
    }

    // Ordenar para que el administrador actual siempre salga arriba
    listaUsuarios.sort((a, b) => {
        if (a.rol === 'admin' && b.rol !== 'admin') return -1;
        if (a.rol !== 'admin' && b.rol === 'admin') return 1;
        return 0;
    });

    listaUsuarios.forEach(u => {
        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid #e2e8f0";

        let nombreCorto = String(u.email).split('@')[0];

        // 1. Identificar si es el escritor
        let esEscritor = (nombreCorto === escritorActual || u.email === escritorActual);
        
        let badgeEstado = "";
        if (u.env === "TEST") {
            badgeEstado = `<span style="background: #fef3c7; color: #b45309; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 0.70rem;">üß™ Pruebas (Aislado)</span>`;
        } else if (esEscritor) {
            badgeEstado = `<span style="background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.70rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">‚úçÔ∏è ESCRITOR</span>`;
        } else {
            badgeEstado = `<span style="background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.70rem;">üëÅÔ∏è LECTOR</span>`;
        }

        // 2. Etiqueta del entorno
        let badgeEnv = u.env === 'PROD' 
            ? `<span style="color: #10b981; font-weight: 800; font-size: 0.8rem;">PROD</span>` 
            : `<span style="color: #f59e0b; font-weight: 800; font-size: 0.8rem;">TEST</span>`;

        // 3. Formatear la vista en la que est√°n navegando
        let vistaLimpia = (u.vista || "Cargando...").replace("vista-", "");
        let iconoVista = "üîç";
        if (vistaLimpia === "operacion") { vistaLimpia = "Entradas"; iconoVista = "üì¶"; }
        if (vistaLimpia === "salidas") iconoVista = "üöö";
        if (vistaLimpia === "ubicaciones") iconoVista = "üìç";
        if (vistaLimpia === "productos") iconoVista = "üìä";
        if (vistaLimpia === "pedidos") { vistaLimpia = "Env√≠os"; iconoVista = "üì¶"; }
        if (vistaLimpia === "admin") iconoVista = "‚öôÔ∏è";

        // Ensamblar la fila
        tr.innerHTML = `
            <td style="padding: 8px 12px; font-weight: 600; color: #1e293b;">
               ${nombreCorto} 
               ${u.rol === 'admin' ? '<span title="Administrador" style="font-size:0.7rem; margin-left:4px;">‚≠ê</span>' : ''}
            </td>
            <td style="padding: 8px 12px; text-align: center;">${badgeEnv}</td>
            <td style="padding: 8px 12px; color: #475569; font-size: 0.8rem;">${iconoVista} ${vistaLimpia.toUpperCase()}</td>
            <td style="padding: 8px 12px; text-align: right;">${badgeEstado}</td>
        `;
        tbody.appendChild(tr);
    });
};