function initApp() {
  cambiarVista('vista-operacion');
  
  // 1. Averiguamos el entorno actual antes de cargar los cat치logos
  google.script.run.withSuccessHandler(mode => {
     updateEnvButton(mode);
     recargarSelectores(); 
  }).getCurrentEnvironment();

  google.script.run.withSuccessHandler((canToggle) => {
    const btn = document.getElementById('btn-env-switch');
    if (!btn) return;
    btn.style.display = canToggle ? 'inline-flex' : 'none';
  }).canToggleEnvironment();
}

function mostrarPantallaLogin() {
    document.getElementById("vista-login").style.display = "flex";
    document.getElementById("app-principal").style.display = "none";
    reiniciarLogin();
    if (typeof ocultarCargando === "function") ocultarCargando();
}

function reiniciarLogin() {
    document.getElementById("input-correo").style.display = "block";
    document.getElementById("input-pin-admin").style.display = "none";
    document.getElementById("input-pin-admin").value = "";
    document.getElementById("btn-login").innerText = "Continuar";
    document.getElementById("btn-login-back").style.display = "none";
    document.getElementById("login-subtitle").innerText = "Ingresa tu correo asignado";
}

function procesarLogin() {
  const email = document.getElementById("input-correo").value.trim();
  const pinField = document.getElementById("input-pin-admin");
  const pin = pinField.value.trim();
  
  if (!email) return Swal.fire("Atenci칩n", "Ingresa un correo", "warning");
  
  // Si el campo de la contrase침a ya est치 visible y est치 vac칤o...
  if (pinField.style.display === "block" && !pin) {
     return Swal.fire("Atenci칩n", "Por favor ingresa tu PIN de Administrador", "warning");
  }
  
  const btn = document.getElementById("btn-login");
  btn.innerText = "Verificando...";
  btn.disabled = true;
  
  ejecutarAutenticacion(email, pin, false);
}

function ejecutarAutenticacion(email, pin, esAutomatico) {
  if (!esAutomatico && typeof mostrarCargando === "function") mostrarCargando("Verificando credenciales...");
  
  google.script.run
    .withSuccessHandler(res => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       const btn = document.getElementById("btn-login");
       if (btn) { btn.innerText = "Continuar"; btn.disabled = false; }

       // LA MAGIA DE LA CONTRASE칌A DE ADMIN
       if (res.requiresPin) {
          document.getElementById("input-correo").style.display = "none";
          document.getElementById("input-pin-admin").style.display = "block";
          document.getElementById("input-pin-admin").focus();
          document.getElementById("btn-login-back").style.display = "block";
          document.getElementById("btn-login").innerText = "Ingresar";
          document.getElementById("login-subtitle").innerText = "游 Ingresa tu PIN de Administrador";
          return; // Detenemos aqu칤, hasta que el usuario meta el PIN
       }

       if (res.success) {
          // GUARDAR EN MEMORIA (Para que ma침ana no le pida login)
          localStorage.setItem("inventario_email", email);
          if (pin) localStorage.setItem("inventario_pin", pin);
          
          document.getElementById("vista-login").style.display = "none";
          document.getElementById("app-principal").style.display = "block";
          
          if (!esAutomatico) mostrarToast(`Hola, ${res.nombre} 游녦`, "success");
          configurarInterfazPorPermisos(res);
       } else {
          // BORRAR MEMORIA SI FALLA
          localStorage.removeItem("inventario_email");
          localStorage.removeItem("inventario_pin");
          mostrarPantallaLogin();
          if (!esAutomatico) Swal.fire("Acceso Denegado", res.error, "error");
       }
    })
    .withFailureHandler(err => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       localStorage.removeItem("inventario_email");
       localStorage.removeItem("inventario_pin");
       const btn = document.getElementById("btn-login");
       if (btn) { btn.innerText = "Continuar"; btn.disabled = false; }
       Swal.fire("Error de Conexi칩n", "No se pudo verificar el acceso.", "error");
    })
    .procesarLoginEmail(email, pin);
}

function configurarInterfazPorPermisos(info) {
  // 1. Mostrar Botones Exclusivos SOLO si es Admin
  const btnEnv = document.getElementById('btn-env-switch');
  const btnAdmin = document.getElementById('nav-admin');
  
  if (btnEnv) btnEnv.style.display = info.esAdmin ? 'block' : 'none';
  if (btnAdmin) btnAdmin.style.display = info.esAdmin ? 'inline-block' : 'none';
  
  // 2. Encender o APAGAR botones de Men칰 Operativos (AQU칈 ESTABA EL ERROR)
  // Ahora forzamos expl칤citamente a que se oculten si no tienen permiso
  document.getElementById('nav-entradas').style.display = info.permisos.entradas ? 'inline-block' : 'none';
  document.getElementById('nav-salidas').style.display = info.permisos.salidas ? 'inline-block' : 'none';
  document.getElementById('nav-ubicaciones').style.display = info.permisos.ubicaciones ? 'inline-block' : 'none';
  document.getElementById('nav-productos').style.display = info.permisos.productos ? 'inline-block' : 'none';
  document.getElementById('nav-pedidos').style.display = info.permisos.envios ? 'inline-block' : 'none';
  document.getElementById('nav-bajas').style.display = info.permisos.bajas ? 'inline-block' : 'none';
  
  // 3. Forzar redirecci칩n a la primera vista que tenga habilitada
  if (info.permisos.entradas) cambiarVista('vista-operacion');
  else if (info.permisos.envios) cambiarVista('vista-pedidos');
  else if (info.permisos.salidas) cambiarVista('vista-salidas');
  else if (info.permisos.productos) cambiarVista('vista-productos');
  else if (info.permisos.ubicaciones) cambiarVista('vista-ubicaciones');
  else if (info.permisos.bajas) cambiarVista('vista-bajas');
  else {
      // Candado extra: Si entra alguien sin NING칔N permiso, ocultamos todo.
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      Swal.fire("Sin accesos", "Tu usuario no tiene permisos operativos asignados.", "warning");
  }

  // 4. Arrancar datos
  updateEnvButton(info.entorno);
  recargarSelectores();
}

// CERRAR SESI칍N (Regresa al Login inmediatamente)
// CERRAR SESI칍N (Regresa al Login inmediatamente sin recargar la p치gina)
function cerrarSesion() {
  // 1. Borramos la memoria del dispositivo
  localStorage.removeItem("inventario_email");
  localStorage.removeItem("inventario_pin");
  
  // 2. Ocultamos la app y mostramos el Login din치micamente
  document.getElementById("app-principal").style.display = "none";
  document.getElementById("vista-login").style.display = "flex";
  
  // 3. Limpiamos los campos visualmente
  reiniciarLogin();
  document.getElementById("input-correo").value = "";
}
// ==========================================
// FIX: FUNCIONES DE ENTORNO REPARADAS
// ==========================================

function toggleEnvironment() {
   const btn = document.getElementById('btn-env-switch');
   const isProd = btn.innerText.includes('PRODUCCI칍N');
   const newMode = isProd ? 'TEST' : 'PROD';
   
   Swal.fire({
      title: 'Cambiando entorno...',
      text: 'Conectando con la base de datos...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
   });
   
   google.script.run.withSuccessHandler(mode => {
      updateEnvButton(mode);
      recargarSelectores();
      if(document.getElementById('vista-productos').style.display !== 'none') cargarDashboardProductos();
      if(document.getElementById('vista-ubicaciones').style.display !== 'none') cargarDashboardUbicaciones();
      if(document.getElementById('vista-pedidos').style.display !== 'none') cargarDashboardPedidos();
      if(document.getElementById('vista-bajas').style.display !== 'none') cargarCaducados();
      
      Swal.fire('춰Cambiado!', `Est치s en la base de:\n${mode === 'PROD' ? '游릭 PRODUCCI칍N' : '游빍 PRUEBAS'}`, 'success');
         }).withFailureHandler((err) => {
      Swal.fire('Sin permiso', err.message || 'No autorizado para cambiar entorno.', 'error');
   }).switchEnvironment(newMode);
}

function updateEnvButton(mode) {
   const btn = document.getElementById('btn-env-switch');
   if(!btn) return;
   if(mode === 'TEST') {
      btn.style.background = '#f39c12'; 
      btn.innerHTML = '游빍 MODO: PRUEBAS';
   } else {
      btn.style.background = '#2ecc71'; 
      btn.innerHTML = '游릭 MODO: PRODUCCI칍N';
   }
}