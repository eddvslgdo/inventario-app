let heartbeatInterval; // Variable global para controlar el latido

function iniciarLatido() {
   // Limpiamos cualquier latido viejo por seguridad
   if (heartbeatInterval) clearInterval(heartbeatInterval);
   
   // Ejecutar cada 30 segundos (30000 milisegundos)
   heartbeatInterval = setInterval(function() {
      const email = localStorage.getItem("inventario_email");
      if (!email) return;
      
      google.script.run
        .withSuccessHandler(function(sigueActivo) {
           if (!sigueActivo) {
              // üö® SI EL SERVIDOR DICE QUE YA NO ESTAMOS ACTIVOS (Bot√≥n de p√°nico)
              clearInterval(heartbeatInterval);
              
              // Forzamos la salida borrando memoria
              localStorage.removeItem("inventario_email");
              localStorage.removeItem("inventario_pin");
              document.getElementById("app-principal").style.display = "none";
              document.getElementById("vista-login").style.display = "flex";
              reiniciarLogin();
              
              // Mostramos alerta de expulsi√≥n
              Swal.fire({
                 title: 'Sesi√≥n Finalizada',
                 text: 'Tu sesi√≥n ha expirado o el sistema fue reiniciado remotamente por un administrador.',
                 icon: 'warning',
                 confirmButtonColor: '#f59e0b'
              });
           }
        })
        .pingSesion(email);
   }, 10000);
}

function initApp() {
  cambiarVista('vista-operacion');
  
  // Obtenemos el usuario guardado en sesi√≥n
  const userEmail = localStorage.getItem("inventario_email");

  // 1. Averiguamos el entorno actual antes de cargar los cat√°logos
  google.script.run.withSuccessHandler(mode => {
     updateEnvButton(mode);
     recargarSelectores(); 
  }).getCurrentEnvironment();

  google.script.run.withSuccessHandler((canToggle) => {
    const btn = document.getElementById('btn-env-switch');
    if (!btn) return;
    btn.style.display = canToggle ? 'inline-flex' : 'none';
  }).canToggleEnvironment(userEmail); // A√±adimos userEmail aqu√≠
}

function mostrarPantallaLogin() {
    document.getElementById("vista-login").style.display = "flex";
    document.getElementById("app-principal").style.display = "none";
    reiniciarLogin();
    if (typeof ocultarCargando === "function") ocultarCargando();
}

function reiniciarLogin() {
    document.getElementById("input-correo").style.display = "block";
    document.getElementById("input-pin-admin").style.display = "none";
    document.getElementById("input-pin-admin").value = "";
    document.getElementById("btn-login").innerText = "Continuar";
    document.getElementById("btn-login-back").style.display = "none";
    document.getElementById("login-subtitle").innerText = "Ingresa tu correo asignado";
}

function procesarLogin() {
  const email = document.getElementById("input-correo").value.trim();
  const pinField = document.getElementById("input-pin-admin");
  const pin = pinField.value.trim();
  
  if (!email) return Swal.fire("Atenci√≥n", "Ingresa un correo", "warning");
  
  // Si el campo de la contrase√±a ya est√° visible y est√° vac√≠o...
  if (pinField.style.display === "block" && !pin) {
     return Swal.fire("Atenci√≥n", "Por favor ingresa tu PIN de Administrador", "warning");
  }
  
const btn = document.getElementById("btn-login");
  // Aplicamos las clases de animaci√≥n y quitamos los puntos (el CSS los pondr√° solos)
  btn.innerText = "Verificando"; 
  btn.classList.add("loading-dots", "btn-pulsing");
  btn.disabled = true;
  
  ejecutarAutenticacion(email, pin, false);
}

function ejecutarAutenticacion(email, pin, esAutomatico) {
  if (!esAutomatico && typeof mostrarCargando === "function") mostrarCargando("Verificando credenciales...");
  iniciarLatido();

  google.script.run
    .withSuccessHandler(res => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       const btn = document.getElementById("btn-login");
       if (btn) { 
           btn.innerText = "Continuar"; 
           btn.classList.remove("loading-dots", "btn-pulsing"); 
           btn.disabled = false; 
       }

       if (res.requiresPin) {
          document.getElementById("input-correo").style.display = "none";
          document.getElementById("input-pin-admin").style.display = "block";
          document.getElementById("input-pin-admin").focus();
          document.getElementById("btn-login-back").style.display = "block";
          document.getElementById("btn-login").innerText = "Ingresar";
          document.getElementById("login-subtitle").innerText = "üîí Ingresa tu PIN de Administrador";
          return; 
       }

if (res.success) {
          // --- BLOQUEO DE CONCURRENCIA TIPO SAP (CORREGIDO) ---
          if (res.bloqueado) {
             Swal.fire({
                title: '‚õî Sistema Ocupado',
                html: `El sistema est√° siendo operado actualmente por:<br><br><b style="color:#d63031; font-size:1.1rem;">${res.otrosUsuariosActivos.join('<br>')}</b><br><br>Por seguridad de los datos, no puedes acceder hasta que el otro usuario cierre su sesi√≥n.`,
                icon: 'error',
                confirmButtonColor: '#d63031',
                confirmButtonText: 'Entendido'
             });
             
             // Borramos cualquier rastro de entrada y lo dejamos afuera
             localStorage.removeItem("inventario_email");
             localStorage.removeItem("inventario_pin");
             reiniciarLogin();
             return; // Rompemos la ejecuci√≥n aqu√≠. NO entra a la app.
          }
          
          // --- SI NO HAY NADIE, LO DEJAMOS ENTRAR NORMAL ---
          localStorage.setItem("inventario_email", email);
          if (pin) localStorage.setItem("inventario_pin", pin);
          
          document.getElementById('lbl-usuario-actual').innerText = res.nombre;
          document.getElementById("vista-login").style.display = "none";
          document.getElementById("app-principal").style.display = "block";
          
          configurarInterfazPorPermisos(res);
          
          if (!esAutomatico) mostrarToast(`Hola, ${res.nombre} üëã`, "success");
       
       // --- FLUJO DE REGISTRO PARA NUEVOS ---
       } else if (res.notFound) {
          Swal.fire({
             title: 'Usuario no registrado',
             text: `El correo "${email}" no tiene acceso. ¬øDeseas solicitar registro en el sistema?`,
             icon: 'question',
             showCancelButton: true,
             confirmButtonColor: '#007aff',
             cancelButtonColor: '#64748b',
             confirmButtonText: 'S√≠, registrarme'
          }).then((result) => {
             if (result.isConfirmed) {
                mostrarCargando("Creando usuario...");
                google.script.run
                  .withSuccessHandler(regRes => {
                     ocultarCargando();
                     if (regRes.success) {
                        Swal.fire("¬°Registro Exitoso!", "Tu usuario ha sido creado. Inicia sesi√≥n ahora para ver el estatus de tu cuenta.", "success");
                     } else {
                        Swal.fire("Error", regRes.error, "error");
                     }
                  })
                  .withFailureHandler(err => {
                     ocultarCargando();
                     Swal.fire("Error", err.message, "error");
                  })
                  .registrarUsuarioPendiente(email);
             }
          });
          localStorage.removeItem("inventario_email");
          localStorage.removeItem("inventario_pin");
       } else {
          localStorage.removeItem("inventario_email");
          localStorage.removeItem("inventario_pin");
          mostrarPantallaLogin();
          if (!esAutomatico) Swal.fire("Acceso Denegado", res.error, "error");
       }
    })
    .withFailureHandler(err => {
       if (typeof ocultarCargando === "function") ocultarCargando();
       localStorage.removeItem("inventario_email");
       localStorage.removeItem("inventario_pin");
       const btn = document.getElementById("btn-login");
       if (btn) { 
           btn.innerText = "Continuar"; 
           btn.classList.remove("loading-dots", "btn-pulsing"); 
           btn.disabled = false; 
       }
       Swal.fire("Error de Conexi√≥n", "No se pudo verificar el acceso.", "error");
    })
    .procesarLoginEmail(email, pin);
}

function configurarInterfazPorPermisos(info) {
  // 1. Mostrar Botones Exclusivos SOLO si es Admin
  const btnEnv = document.getElementById('btn-env-switch');
  const btnAdmin = document.getElementById('nav-admin');
  
  if (btnEnv) btnEnv.style.display = info.esAdmin ? 'block' : 'none';
  if (btnAdmin) btnAdmin.style.display = info.esAdmin ? 'inline-block' : 'none';
  
  // 2. Encender o APAGAR botones de Men√∫ Operativos (AQU√ç ESTABA EL ERROR)
  // Ahora forzamos expl√≠citamente a que se oculten si no tienen permiso
  document.getElementById('nav-entradas').style.display = info.permisos.entradas ? 'inline-block' : 'none';
  document.getElementById('nav-salidas').style.display = info.permisos.salidas ? 'inline-block' : 'none';
  document.getElementById('nav-ubicaciones').style.display = info.permisos.ubicaciones ? 'inline-block' : 'none';
  document.getElementById('nav-productos').style.display = info.permisos.productos ? 'inline-block' : 'none';
  document.getElementById('nav-pedidos').style.display = info.permisos.envios ? 'inline-block' : 'none';
  document.getElementById('nav-bajas').style.display = info.permisos.bajas ? 'inline-block' : 'none';
  
  // 3. Forzar redirecci√≥n a la primera vista que tenga habilitada
  if (info.permisos.entradas) cambiarVista('vista-operacion');
  else if (info.permisos.envios) cambiarVista('vista-pedidos');
  else if (info.permisos.salidas) cambiarVista('vista-salidas');
  else if (info.permisos.productos) cambiarVista('vista-productos');
else if (info.permisos.ubicaciones) cambiarVista('vista-ubicaciones');
  else if (info.permisos.bajas) cambiarVista('vista-bajas');
  else {
      // NUEVO: Candado extra - Si no tiene NING√öN permiso, le mostramos la pantalla de "Cuenta en revisi√≥n"
      document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
      let vistaRevision = document.getElementById('vista-sin-permisos');
      if (vistaRevision) vistaRevision.style.display = 'flex';
      
      Swal.fire("En espera de autorizaci√≥n", "Un Administrador debe otorgarte permisos para operar el sistema.", "info");
  }
  // 4. Arrancar datos
  updateEnvButton(info.entorno);
  recargarSelectores();

  // 5. Cargar notificaciones (Campana) en segundo plano silenciosamente
  if (info.permisos.envios && typeof api !== 'undefined') {
      api.obtenerHistorialPedidos(function(lista) {
          window.LISTA_PEDIDOS_CACHE = lista || [];
          if(typeof actualizarNotificaciones === 'function') actualizarNotificaciones();
      }, function(err) {
          console.warn("No se carg√≥ la campana en 2do plano", err);
      });
  }
}

// CERRAR SESI√ìN (Regresa al Login inmediatamente)
function cerrarSesion() {
   if (heartbeatInterval) clearInterval(heartbeatInterval);
  const email = localStorage.getItem("inventario_email");
  if(email) {
     google.script.run.registrarCierreSesion(email);
  }

  // 1. Borramos la memoria del dispositivo
  localStorage.removeItem("inventario_email");
  localStorage.removeItem("inventario_pin");
  
  // 2. Ocultamos la app y mostramos el Login
  document.getElementById("app-principal").style.display = "none";
  document.getElementById("vista-login").style.display = "flex";
  
  // 3. Limpiamos los campos
  reiniciarLogin();
  document.getElementById("input-correo").value = "";
}
// ==========================================
// FIX: FUNCIONES DE ENTORNO REPARADAS
// ==========================================

function toggleEnvironment() {
   const btn = document.getElementById('btn-env-switch');
   const isProd = btn.innerText.includes('PRODUCCI√ìN');
   const newMode = isProd ? 'TEST' : 'PROD';
   
   // NUEVO: Obtenemos el usuario de la memoria del navegador
   const userEmail = localStorage.getItem("inventario_email"); 
   
   Swal.fire({
      title: 'Cambiando entorno...',
      text: 'Conectando con la base de datos...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
   });
   
   google.script.run.withSuccessHandler(mode => {
      updateEnvButton(mode);
      recargarSelectores();
      if(document.getElementById('vista-productos').style.display !== 'none') cargarDashboardProductos();
      if(document.getElementById('vista-ubicaciones').style.display !== 'none') cargarDashboardUbicaciones();
      if(document.getElementById('vista-pedidos').style.display !== 'none') cargarDashboardPedidos();
      if(document.getElementById('vista-bajas').style.display !== 'none') cargarCaducados();
      
      Swal.fire('¬°Cambiado!', `Est√°s en la base de:\n${mode === 'PROD' ? 'üü¢ PRODUCCI√ìN' : 'üß™ PRUEBAS'}`, 'success');
   }).withFailureHandler((err) => {
      Swal.fire('Sin permiso', err.message || 'No autorizado para cambiar entorno.', 'error');
   }).switchEnvironment(newMode, userEmail); // NUEVO: Pasamos el userEmail al backend
}

function updateEnvButton(mode) {
   const btn = document.getElementById('btn-env-switch');
   if(!btn) return;
   if(mode === 'TEST') {
      btn.style.background = '#f39c12'; 
      btn.innerHTML = 'üß™ MODO: PRUEBAS';
   } else {
      btn.style.background = '#2ecc71'; 
      btn.innerHTML = 'üü¢ MODO: PRODUCCI√ìN';
   }
}

// ==========================================
// M√ìDULO DE NOTIFICACIONES Y PERFIL
// ==========================================

window.toggleMenuUsuario = function() {
   let panel = document.getElementById("panel-notificaciones");
   panel.style.display = panel.style.display === "none" ? "block" : "none";
};

// Cierra el men√∫ si haces clic afuera
document.addEventListener('click', function(event) {
    let panel = document.getElementById("panel-notificaciones");
    let boton = document.querySelector("button[onclick='toggleMenuUsuario()']");
    if (panel && panel.style.display === "block") {
        if (!panel.contains(event.target) && !boton.contains(event.target)) {
            panel.style.display = "none";
        }
    }
});

function actualizarNotificaciones() {
   if(typeof LISTA_PEDIDOS_CACHE === 'undefined' || !LISTA_PEDIDOS_CACHE) return;
   
   let pedidosPendientes = [];
   let pedidosSinGuia = [];

   // Analizamos el cach√© de pedidos sin hacer llamadas extra al servidor
   LISTA_PEDIDOS_CACHE.forEach(p => {
      let st = p.estatus || "Pendiente";
      if (st === "Pendiente") pedidosPendientes.push(p);
      
      let enProceso = st.includes('Enviado') || st.includes('Camino') || st.includes('Proceso');
      if (enProceso && (!p.guia || p.guia === "---" || p.guia.trim() === "")) {
         pedidosSinGuia.push(p);
      }
   });

   let totalNotif = pedidosPendientes.length + pedidosSinGuia.length;
   let badge = document.getElementById("badge-notif");
   if (badge) {
       badge.innerText = totalNotif;
       badge.style.display = totalNotif > 0 ? "inline-block" : "none";
   }

   let listaHtml = "";
   if (totalNotif === 0) {
       listaHtml = "<div style='padding: 20px; text-align: center; color: #94a3b8; font-size: 0.9rem;'>No hay tareas pendientes üéâ</div>";
   } else {
       if (pedidosPendientes.length > 0) {
           listaHtml += `<div style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'" onclick="cambiarVista('vista-pedidos'); filtrarEstado('Pendiente', null); toggleMenuUsuario();">
                            <div style="font-weight: bold; color: #d97706; font-size: 0.95rem;">‚è≥ ${pedidosPendientes.length} Pedido(s) Pendiente(s)</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top:3px;">Falta procesar su env√≠o o entrega. Toca para verlos.</div>
                         </div>`;
       }
       if (pedidosSinGuia.length > 0) {
           listaHtml += `<div style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'" onclick="cambiarVista('vista-pedidos'); filtrarEstado('Enviado', null); toggleMenuUsuario();">
                            <div style="font-weight: bold; color: #dc2626; font-size: 0.95rem;">üé´ ${pedidosSinGuia.length} Env√≠o(s) sin Gu√≠a</div>
                            <div style="font-size: 0.8rem; color: #64748b; margin-top:3px;">Est√°n en ruta pero les falta el # de rastreo.</div>
                         </div>`;
       }
   }
   
   let panelLista = document.getElementById("lista-notificaciones");
   if(panelLista) panelLista.innerHTML = listaHtml;
}

// --- BOT√ìN DE P√ÅNICO REMOTO ---
window.liberarSistemaRemoto = function() {
   Swal.fire({
      title: '¬øForzar Liberaci√≥n?',
      text: 'Esto cerrar√° la sesi√≥n de cualquier usuario que est√© operando el sistema actualmente.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      confirmButtonText: 'S√≠, liberar ahora'
   }).then((result) => {
      if (result.isConfirmed) {
         mostrarCargando("Liberando sistema...");
         google.script.run
           .withSuccessHandler(() => {
              ocultarCargando();
              Swal.fire('¬°Liberado!', 'El sistema est√° libre y accesible nuevamente.', 'success');
           })
           .withFailureHandler((err) => {
              ocultarCargando();
              Swal.fire('Error', err.message, 'error');
           })
           .LIBERAR_SISTEMA();
      }
   });
};