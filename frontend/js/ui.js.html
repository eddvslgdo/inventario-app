// --- UTILIDADES DE INTERFAZ (UI) ---

function mostrarToast(mensaje, tipo) {
  if (!tipo) tipo = "info";
  const toast = document.getElementById("toast-container");
  if (!toast) return alert(mensaje);
  
  toast.className = "show " + tipo;
  toast.innerText = mensaje;
  
  setTimeout(function() {
    toast.className = toast.className.replace("show", "");
    setTimeout(function() {
      toast.className = "";
    }, 500);
  }, 3000);
}

function mostrarError(err) {
  console.error(err);
  var msg = (err && err.message) ? err.message : err;
  mostrarToast("Error: " + msg, "error");
}

function abrirModalGenerico(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = "flex";
}

function cerrarModalGenerico(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = "none";
}

function abrirModal() { 
  const u = document.getElementById("nuevaUnidad");
  if(u) u.disabled = false; // Desbloquea la unidad
  abrirModalGenerico("modalProducto"); 
}

function cerrarModal() { cerrarModalGenerico("modalProducto"); }

// --- CALCULADORA GLOBAL ---
function parseDecimalFlexible(valor) {
  if (valor === null || typeof valor === "undefined") return 0;
  if (typeof valor === "number") return isNaN(valor) ? 0 : valor;

  const normalizado = String(valor).trim().replace(",", ".");
  const n = parseFloat(normalizado);
  return isNaN(n) ? 0 : n;
}

function calcTotalGenerico(idPres, idCant) {
  const sel = document.getElementById(idPres);
  const inp = document.getElementById(idCant);
  
  if (!sel || !inp) return 0;
  
  // CAMBIO: Validaci√≥n segura sin usar los signos mayor/menor que
  if (sel.selectedIndex === -1 || sel.selectedIndex === 0) return 0; 
  
  const opt = sel.options[sel.selectedIndex];
  if (!opt) return 0;
  
  let dataVol = opt.getAttribute("data-volumen");
  
  // FALLBACK ANTI-ERRORES
  if (isNaN(volUnitario) || volUnitario === 0) {
     if (opt.text) {
         let match = opt.text.match(/[\d\.]+/);
         if (match) {
             volUnitario = parseFloat(match[0]);
             if(opt.text.toLowerCase().includes("ml")) volUnitario /= 1000;
         }
     }
  }
    let volUnitario = parseDecimalFlexible(dataVol);
  let cantidad = parseDecimalFlexible(inp.value);

  const total = (cantidad * volUnitario);
  return parseFloat(total.toFixed(2));
}

// --- RENDERIZADOR COMPACTO (FIXED LAYOUT) ---
// --- RENDERIZADOR COMPACTO (FIXED LAYOUT) ---
function renderColaGenerica(lista, idArea, idBody, idContador, tipo) {
  const area = document.getElementById(idArea);
  const tbody = document.getElementById(idBody);
  const contador = document.getElementById(idContador);
  
  if(contador) contador.innerText = lista.length;
  
  if (!lista || lista.length === 0) {
    if(area) area.style.display = "none";
    return;
  }
  
  if(area) area.style.display = "block";
  if(tbody) {
      tbody.innerHTML = "";
      
      for (var i = lista.length - 1; i >= 0; i--) {
          const item = lista[i];
          const idxOriginal = i;
          
          const tr = document.createElement("tr");
          tr.style.borderBottom = "1px solid #eee";
          
          const color = (tipo === "sal") ? "#d63031" : "#007aff"; 
          
          // COLUMNA 1: INFO (55%) - Ahora incluye la ubicaci√≥n
          const tdInfo = document.createElement("td");
          tdInfo.style.width = "55%"; 
          tdInfo.style.padding = "6px 2px"; 
          tdInfo.style.verticalAlign = "middle";
          tdInfo.style.overflow = "hidden"; 
          
          let infoHtml = `<div style="font-weight:600; font-size:0.85rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${item.nombre_producto}">${item.nombre_producto}</div>`;
          
          // Fila: Lote + Caducidad + Ubicaci√≥n (NUEVO)
          infoHtml += `<div style="display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin-top:4px;">`;
          infoHtml += `  <span style="font-size:0.75rem; font-family:monospace; color:${color}; background:#f5f5f5; padding:2px 4px; border-radius:3px;">${item.lote}</span>`;
          
          // MOSTRAR UBICACI√ìN (NUEVO)
          let nomUbic = item.nombre_ubicacion || item.ubicacion_id || "";
          if (nomUbic) {
             infoHtml += `  <span style="font-size:0.7rem; color:#64748b; background:#e2e8f0; padding:2px 4px; border-radius:3px;">üìç ${nomUbic}</span>`;
          }

          // MOSTRAR CADUCIDAD SI EXISTE (Aplica para Salidas)
          if (item.caducidad && item.caducidad !== "---") {
             infoHtml += `  <span style="font-size:0.7rem; color:#d35400;">üìÖ ${item.caducidad}</span>`;
          }
          infoHtml += `</div>`;
          
          tdInfo.innerHTML = infoHtml;
          tr.appendChild(tdInfo);
          
          // COLUMNA 2: CANTIDAD (30%) - Ajustada para que quepa bien el texto de Unidad
          const tdCant = document.createElement("td");
          tdCant.style.width = "30%";
          tdCant.style.padding = "4px 2px";
          tdCant.style.textAlign = "right";
          tdCant.style.verticalAlign = "middle";
          
          const uni = item.unidad_medida || "L";
          const volMostrar = (uni === "Pza") ? Math.round(item.volumen_L) : Number(item.volumen_L).toFixed(2);
          
          tdCant.innerHTML = `<div style="font-weight:bold; font-size:0.9rem; color:#334155;">${volMostrar} ${uni}</div><div style="font-size:0.75rem; color:#94a3b8;">(${item.piezas} pzas)</div>`;
          tr.appendChild(tdCant);
          
          // COLUMNA 3: ACCIONES (15%) - Solo dejamos el bot√≥n de Borrar
          const tdAx = document.createElement("td");
          tdAx.style.width = "15%";
          tdAx.style.padding = "4px 0";
          tdAx.style.textAlign = "right";
          tdAx.style.verticalAlign = "middle";
          
          const btnStyle = "border:none; background:#fee2e2; border-radius:6px; cursor:pointer; font-size:1.1rem; padding:4px 8px; margin:0; transition:all 0.2s;";
          
          const btnDel = document.createElement("button");
          btnDel.innerText = "üóëÔ∏è";
          btnDel.style.cssText = btnStyle + " color:#dc2626;";
          const fnBorrar = (tipo === "sal") ? "eliminarSal" : "eliminarEnt";
          btnDel.setAttribute("onclick", fnBorrar + "(" + idxOriginal + ")");
          tdAx.appendChild(btnDel);
          
          tr.appendChild(tdAx);
          tbody.appendChild(tr);
      }
  }
}

// --- CONTROL DEL SPINNER DE CARGA ---

function mostrarCargando(texto) {
  const loader = document.getElementById("global-loader");
  if (loader) {
    // Si pasamos texto, actualizamos el mensaje
    const p = loader.querySelector("p");
    if(p) p.innerText = texto || "Procesando...";
    
    loader.style.display = "flex";
  }
}

function ocultarCargando() {
  const loader = document.getElementById("global-loader");
  if (loader) {
    loader.style.display = "none";
  }
}


// --- HERRAMIENTA DE AUDITOR√çA ---
function logActividad(accion, detalle) {
  // Sacamos el correo del usuario que inici√≥ sesi√≥n
  const usuario = localStorage.getItem("inventario_email") || "Usuario Desconocido";
  // Se lo mandamos al backend silenciosamente
  google.script.run.registrarEnBitacora(usuario, accion, detalle);
}