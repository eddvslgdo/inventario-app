// ==========================================
// LÓGICA DE ENTRADAS (CON ANIMACIÓN EN MASIVA)
// ==========================================

function calcularTotalEntrada() {
  var total = 0;
  if (typeof calcTotalGenerico === 'function') {
      total = calcTotalGenerico("presentacion", "cantidad");
  } else {
      var p = document.getElementById("presentacion");
      var c = document.getElementById("cantidad");
      if(p && c) {
          var vol = parseFloat(p.options[p.selectedIndex].getAttribute("data-volumen") || 0);
          total = vol * (parseFloat(c.value) || 0);
      }
  }
  
  var el = document.getElementById("infoTotal");
  if(el) el.innerText = total.toFixed(2) + " L";
  return total;
}

function guardarEntradaDirecta() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  if(typeof mostrarCargando === 'function') mostrarCargando("Guardando entrada...");
  
  google.script.run
    .withSuccessHandler(function(response) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      mostrarToast("Entrada Guardada Correctamente ✅", "success");
      limpiarFormularioEntrada();
      if(typeof recargarSelectores === 'function') recargarSelectores();
    })
    .withFailureHandler(function(err) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      mostrarToast("Error: " + err.message, "error");
    })
    .registrarEntradaUnica(item);
}

function agregarColaEntrada() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  if(typeof COLA_ENTRADAS !== 'undefined') {
      COLA_ENTRADAS.push(item);
      renderizarColaEntrada();
  }
  
  var ids = ["cantidad", "lote"];
  ids.forEach(function(id) { var e = document.getElementById(id); if(e) e.value = ""; });
  
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  var lot = document.getElementById("lote");
  if(lot) lot.focus();
  
  mostrarToast("Agregado a la lista", "success");
}

function construirObjetoEntrada() {
  var vol = calcularTotalEntrada();

  if (!(vol > 0)) { 
    mostrarToast("Cantidad inválida (0 L)", "error");
    return null;
  }
  
  var elLote = document.getElementById("lote");
  var lote = elLote ? elLote.value.trim() : "";
  
  if (!lote || lote === "") {
    mostrarToast("Falta el Lote", "error");
    if(elLote) elLote.focus();
    return null;
  }
  
  var elElab = document.getElementById("elaboracion");
  var fab = (elElab && elElab.value) ? elElab.value : "";
  
  return {
    producto_id: document.getElementById("producto").value,
    nombre_producto: getTextoSelect("producto"),
    presentacion_id: document.getElementById("presentacion").value,
    nombre_presentacion: getTextoSelect("presentacion"),
    ubicacion_id: document.getElementById("ubicacion").value,
    volumen_L: vol,
    piezas: document.getElementById("cantidad").value,
    lote: lote,
    proveedor: document.getElementById("proveedor").value,
    fecha_elaboracion: fab,
    fecha_caducidad: "" 
  };
}

function limpiarFormularioEntrada() {
  var ids = ["cantidad", "lote", "proveedor", "elaboracion", "producto", "presentacion", "ubicacion"];
  ids.forEach(function(id) { var e = document.getElementById(id); if(e) e.value = ""; });
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
}

function procesarEntradas() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  
  // Preparamos el modal de confirmación
  var lbl = document.getElementById("lblCantMasiva");
  if(lbl) lbl.innerText = COLA_ENTRADAS.length + " partidas";
  abrirModalGenerico("modalConfirmarMasivo");
}

function renderizarColaEntrada() {
  if(typeof COLA_ENTRADAS !== 'undefined' && typeof renderColaGenerica === 'function') {
      renderColaGenerica(COLA_ENTRADAS, "area-cola-entradas", "tablaColaEntradaBody", "contadorColaEnt", "ent");
  }
}

// --- FUNCIÓN MODIFICADA CON ANIMACIÓN ---
function ejecutarGuardadoMasivo() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;

  // 1. Ocultar el modal de confirmación para que no estorbe
  cerrarModalGenerico("modalConfirmarMasivo");

  // 2. ACTIVAR LA PANTALLA DE CARGA (Overlay blanco con spinner)
  var loader = document.getElementById("global-loader");
  if(loader) loader.style.display = "flex";

  google.script.run
    .withSuccessHandler(function(response) {
       // 3. APAGAR PANTALLA DE CARGA
       if(loader) loader.style.display = "none";

       // Limpiar todo tras éxito
       COLA_ENTRADAS = []; 
       renderizarColaEntrada();
       mostrarToast("¡Carga Masiva Exitosa! ✅", "success");
       
       // Recargar dashboard si aplica
       if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
    })
    .withFailureHandler(function(err) {
       // 3. APAGAR PANTALLA DE CARGA (Incluso si falla)
       if(loader) loader.style.display = "none";
       
       mostrarToast("Error: " + err.message, "error");
       // Volvemos a abrir el modal por si quiere reintentar
       abrirModalGenerico("modalConfirmarMasivo");
    })
    .registrarEntradaMasiva(COLA_ENTRADAS);
}

console.log("✅ FRONTEND: Lógica de Entradas cargada correctamente");