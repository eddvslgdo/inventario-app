// ==========================================
// LÓGICA DE ENTRADAS (CLEAN VERSION)
// ==========================================

function calcularTotalEntrada() {
  var total = 0;
  // Intentamos usar la función genérica si existe
  if (typeof calcTotalGenerico === 'function') {
      total = calcTotalGenerico("presentacion", "cantidad");
  } else {
      // Fallback simple por si core.js no cargó
      var p = document.getElementById("presentacion");
      var c = document.getElementById("cantidad");
      if(p && c) {
          var vol = parseFloat(p.options[p.selectedIndex].getAttribute("data-volumen") || 0);
          total = vol * (parseFloat(c.value) || 0);
      }
  }
  
  var el = document.getElementById("infoTotal");
  if(el) el.innerText = total.toFixed(2) + " L";
  return total;
}

function guardarEntradaDirecta() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  // Loader visual
  if(typeof mostrarCargando === 'function') mostrarCargando("Guardando entrada...");
  
  api.registrarEntradaUnica(item, 
    function(response) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      mostrarToast("Entrada Guardada Correctamente ✅", "success");
      limpiarFormularioEntrada();
      if(typeof recargarSelectores === 'function') recargarSelectores();
    },
    function(err) {
      if(typeof ocultarCargando === 'function') ocultarCargando();
      mostrarError(err);
    }
  );
}

function agregarColaEntrada() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  if(typeof COLA_ENTRADAS !== 'undefined') {
      COLA_ENTRADAS.push(item);
      renderizarColaEntrada();
  }
  
  // Limpieza parcial
  var ids = ["cantidad", "lote"];
  ids.forEach(function(id) { var e = document.getElementById(id); if(e) e.value = ""; });
  
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  var lot = document.getElementById("lote");
  if(lot) lot.focus();
  
  mostrarToast("Agregado a la lista", "success");
}

function construirObjetoEntrada() {
  var vol = calcularTotalEntrada();

  // VALIDACIÓN SEGURA: Usamos lógica inversa para evitar símbolo menor que
  if (!(vol > 0)) { 
    mostrarToast("Cantidad inválida (0 L)", "error");
    return null;
  }
  
  var elLote = document.getElementById("lote");
  var lote = elLote ? elLote.value.trim() : "";
  
  if (!lote || lote === "") {
    mostrarToast("Falta el Lote", "error");
    if(elLote) elLote.focus();
    return null;
  }
  
  var elElab = document.getElementById("elaboracion");
  // Si hay fecha, la usamos. Si no, enviamos cadena vacía.
  var fab = (elElab && elElab.value) ? elElab.value : "";
  
  return {
    producto_id: document.getElementById("producto").value,
    nombre_producto: getTextoSelect("producto"),
    presentacion_id: document.getElementById("presentacion").value,
    nombre_presentacion: getTextoSelect("presentacion"),
    ubicacion_id: document.getElementById("ubicacion").value,
    volumen_L: vol,
    piezas: document.getElementById("cantidad").value,
    lote: lote,
    proveedor: document.getElementById("proveedor").value,
    
    // Enviamos la fecha tal cual. El Backend calculará la caducidad.
    fecha_elaboracion: fab,
    fecha_caducidad: "" 
  };
}

function limpiarFormularioEntrada() {
  var ids = ["cantidad", "lote", "proveedor", "elaboracion", "producto", "presentacion", "ubicacion"];
  ids.forEach(function(id) { var e = document.getElementById(id); if(e) e.value = ""; });
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
}

function procesarEntradas() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  TIPO_ACCION_MASIVA = "ENTRADA";
  var lbl = document.getElementById("lblCantMasiva");
  if(lbl) lbl.innerText = COLA_ENTRADAS.length + " partidas";
  abrirModalGenerico("modalConfirmarMasivo");
}

function renderizarColaEntrada() {
  if(typeof COLA_ENTRADAS !== 'undefined' && typeof renderColaGenerica === 'function') {
      renderColaGenerica(COLA_ENTRADAS, "area-cola-entradas", "tablaColaEntradaBody", "contadorColaEnt", "ent");
  }
}

function ejecutarGuardadoMasivo() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;

  // Visual feedback
  var btn = document.querySelector("#modalConfirmarMasivo button.btn-primary"); // Adjust selector if needed
  if(btn) { btn.innerText = "Saving..."; btn.disabled = true; }

  google.script.run
    .withSuccessHandler(function(response) {
       // Clear list and close modal on success
       COLA_ENTRADAS = []; 
       renderizarColaEntrada();
       cerrarModalGenerico("modalConfirmarMasivo");
       mostrarToast("Entries saved successfully ✅", "success");
       
       // Reset button
       if(btn) { btn.innerText = "Yes, Save"; btn.disabled = false; }
       
       // Reload data if needed
       if(typeof cargarDashboardEntradas === 'function') cargarDashboardEntradas();
    })
    .withFailureHandler(function(err) {
       mostrarToast("Error: " + err.message, "error");
       if(btn) { btn.innerText = "Yes, Save"; btn.disabled = false; }
    })
    .registrarEntradaMasiva(COLA_ENTRADAS); // Calls the backend function we fixed in V24
}

// Mensaje de confirmación en consola
console.log("✅ FRONTEND: Lógica de Entradas cargada correctamente");