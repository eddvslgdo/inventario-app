// ==========================================
// LÓGICA DE ENTRADAS (PRO)
// ==========================================

function calcularTotalEntrada() {
  var total = 0;
  var p = document.getElementById("presentacion");
  var c = document.getElementById("cantidad");
  
  if(p && c && p.selectedIndex >= 0) {
      var vol = parseFloat(p.options[p.selectedIndex].getAttribute("data-volumen") || 0);
      total = vol * (parseFloat(c.value) || 0);
  }
  
  // Buscar unidad real (L o Kg)
  var unidad = "L";
  var prodId = document.getElementById("producto").value;
  if(window.CACHE_CATALOGOS && prodId) {
      var prodData = window.CACHE_CATALOGOS.productos.find(x => x.id === prodId);
      if(prodData && prodData.unidad) unidad = prodData.unidad;
  }
  
  var el = document.getElementById("infoTotal");
  if(el) el.innerText = total.toFixed(2) + " " + unidad;
  return { total: total, unidad: unidad };
}

function guardarEntradaDirecta() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  Swal.fire({ title: 'Procesando...', text: 'Registrando entrada en almacén...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
  
  google.script.run
    .withSuccessHandler(function() {
      Swal.fire("¡Éxito!", "Entrada registrada correctamente.", "success");
      limpiarFormularioEntrada();
      if(typeof recargarSelectores === 'function') recargarSelectores();
    })
    .withFailureHandler(function(err) {
      Swal.fire("Error", err.message, "error");
    })
    .registrarEntradaUnica(item);
}

function agregarColaEntrada() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  if(typeof COLA_ENTRADAS !== 'undefined') {
      COLA_ENTRADAS.push(item);
      renderizarColaEntrada();
  }
  
  // Bloquear botón directo
  var btnDir = document.getElementById("btn-entrada-directa");
  if(btnDir) { btnDir.disabled = true; btnDir.style.opacity = '0.5'; }
  
  // Limpieza parcial
  ["cantidad", "lote", "producto_search", "producto"].forEach(function(id) { 
      var e = document.getElementById(id); if(e) e.value = ""; 
  });
  
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  mostrarToast("Agregado a la lista de ingreso", "success");
}

function eliminarEnt(index) {
  COLA_ENTRADAS.splice(index, 1);
  renderizarColaEntrada();
  
  // Desbloquear si está vacío
  if(COLA_ENTRADAS.length === 0) {
      var btnDir = document.getElementById("btn-entrada-directa");
      if(btnDir) { btnDir.disabled = false; btnDir.style.opacity = '1'; }
  }
}

function construirObjetoEntrada() {
  var calculo = calcularTotalEntrada();
  if (!(calculo.total > 0)) { mostrarToast("Cantidad inválida", "error"); return null; }
  
  var elLote = document.getElementById("lote");
  var lote = elLote ? elLote.value.trim() : "";
  if (!lote) { mostrarToast("Falta el Lote", "error"); if(elLote) elLote.focus(); return null; }
  
var pId = document.getElementById("producto").value;
  var pName = document.getElementById("producto_search").value;
  if (!pId) { mostrarToast("Selecciona un producto válido", "warning"); return null; }
  
  // --- INICIO DEL CAMBIO ---
  var fabRaw = document.getElementById("elaboracion") ? document.getElementById("elaboracion").value : "";
  var fab = fabRaw;
  
  // Si el input manda "YYYY-MM" (ej. 2026-02), le agregamos "-01" para que el backend lo entienda como "2026-02-01"
  if (fabRaw && fabRaw.length === 7) {
      fab = fabRaw + "-01"; 
  }
  // --- FIN DEL CAMBIO ---

  return {
    producto_id: pId,
    nombre_producto: pName,
    presentacion_id: document.getElementById("presentacion").value,
    nombre_presentacion: getTextoSelect("presentacion"),
    ubicacion_id: document.getElementById("ubicacion").value,
    nombre_ubicacion: getTextoSelect("ubicacion"),
    volumen_L: calculo.total,
    unidad_medida: calculo.unidad,
    piezas: document.getElementById("cantidad").value,
    lote: lote,
    proveedor: document.getElementById("proveedor").value,
    fecha_elaboracion: fab, // <--- Aquí mandará "2026-02-01"
    fecha_caducidad: "" 
  };
}

function limpiarFormularioEntrada() {
  ["cantidad", "lote", "proveedor", "elaboracion", "producto", "producto_search", "presentacion", "ubicacion"].forEach(id => { 
      var e = document.getElementById(id); if(e) e.value = ""; 
  });
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  var btnDir = document.getElementById("btn-entrada-directa");
  if(btnDir) { btnDir.disabled = false; btnDir.style.opacity = '1'; }

  // --- NUEVO: Ocultar el recuadro contextual al limpiar ---
  var infoDiv = document.getElementById("info-contextual-entrada");
  if (infoDiv) infoDiv.style.display = "none";
}

function procesarEntradas() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  var lbl = document.getElementById("lblCantMasiva");
  if(lbl) lbl.innerText = COLA_ENTRADAS.length + " partidas";
  abrirModalGenerico("modalConfirmarMasivo");
}

function renderizarColaEntrada() {
  if(typeof COLA_ENTRADAS !== 'undefined' && typeof renderColaGenerica === 'function') {
      renderColaGenerica(COLA_ENTRADAS, "area-cola-entradas", "tablaColaEntradaBody", "contadorColaEnt", "ent");
  }
}

function ejecutarGuardadoMasivo() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  cerrarModalGenerico("modalConfirmarMasivo");

  Swal.fire({ title: 'Procesando...', text: 'Ingresando lotes al almacén...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});

  google.script.run
    .withSuccessHandler(function() {
       COLA_ENTRADAS = []; 
       renderizarColaEntrada();
       limpiarFormularioEntrada();
       Swal.fire("¡Éxito!", "Ingreso Masivo completado.", "success");
       if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
       if(typeof recargarSelectores === 'function') recargarSelectores();
    })
    .withFailureHandler(function(err) {
       Swal.fire("Error", err.message, "error");
       abrirModalGenerico("modalConfirmarMasivo");
    })
    .registrarEntradaMasiva(COLA_ENTRADAS);
}