function calcularTotalEntrada() {
  const total = calcTotalGenerico("presentacion", "cantidad");
  const el = document.getElementById("infoTotal");
  if(el) el.innerText = total + " L";
  return total;
}

function guardarEntradaDirecta() {
  const item = construirObjetoEntrada();
  if (!item) return;
  const btn = event.target;
  const txt = btn.innerText;
  btn.disabled = true;
  btn.innerText = "Guardando...";
  
  api.registrarEntradaUnica(item, 
    function() {
      mostrarToast("Entrada Directa Guardada ⚡", "success");
      limpiarFormularioEntrada();
      recargarSelectores();
      btn.disabled = false;
      btn.innerText = txt;
    },
    function(err) {
      mostrarError(err);
      btn.disabled = false;
      btn.innerText = txt;
    }
  );
}

function agregarColaEntrada() {
  const item = construirObjetoEntrada();
  if (!item) return;
  
  if(typeof COLA_ENTRADAS !== 'undefined') {
      COLA_ENTRADAS.push(item);
      renderizarColaEntrada();
  }
  
  const els = ["cantidad", "lote"];
  els.forEach(id => { const e = document.getElementById(id); if(e) e.value = ""; });
  
  const info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  const lot = document.getElementById("lote");
  if(lot) lot.focus();
  
  mostrarToast("Agregado a la lista", "success");
}

function construirObjetoEntrada() {
  const vol = calcularTotalEntrada();

  // --- CORRECCIÓN ---
  // Usamos "!(vol > 0)" para evitar escribir el símbolo "<" 
  // que el navegador está confundiendo con HTML.
  if (!(vol > 0)) { 
    mostrarToast("Cantidad inválida (debe ser mayor a 0)", "error");
    return null;
  }
  
  const elLote = document.getElementById("lote");
  const lote = elLote ? elLote.value.trim() : "";
  
  if (!lote) {
    mostrarToast("Falta Lote", "error");
    if(elLote) elLote.focus();
    return null;
  }
  
  let fc = new Date();
  fc.setFullYear(fc.getFullYear() + 2);
  
  const elElab = document.getElementById("elaboracion");
  let fab = (elElab && elElab.value) ? elElab.value : new Date().toISOString().split("T")[0];
  
  return {
    producto_id: document.getElementById("producto").value,
    nombre_producto: getTextoSelect("producto"),
    presentacion_id: document.getElementById("presentacion").value,
    nombre_presentacion: getTextoSelect("presentacion"),
    ubicacion_id: document.getElementById("ubicacion").value,
    volumen_L: vol,
    piezas: document.getElementById("cantidad").value,
    lote: lote,
    proveedor: document.getElementById("proveedor").value,
    fecha_elaboracion: fab,
    fecha_caducidad: fc.toISOString().split("T")[0],
  };
}

function limpiarFormularioEntrada() {
  const ids = ["cantidad", "lote", "proveedor", "elaboracion", "producto", "presentacion", "ubicacion"];
  ids.forEach(id => { const e = document.getElementById(id); if(e) e.value = ""; });
  const info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
}

function procesarEntradas() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  TIPO_ACCION_MASIVA = "ENTRADA";
  document.getElementById("lblCantMasiva").innerText = COLA_ENTRADAS.length + " partidas (Entrada)";
  abrirModalGenerico("modalConfirmarMasivo");
}

function renderizarColaEntrada() {
  if(typeof COLA_ENTRADAS !== 'undefined') {
      renderColaGenerica(COLA_ENTRADAS, "area-cola-entradas", "tablaColaEntradaBody", "contadorColaEnt", "ent");
  }
}