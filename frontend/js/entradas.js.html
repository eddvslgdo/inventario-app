// ==========================================
// LÃ“GICA DE ENTRADAS (PRO)
// ==========================================

function calcularTotalEntrada() {
  var total = (typeof calcTotalGenerico === 'function')
    ? calcTotalGenerico("presentacion", "cantidad")
    : 0;
    
  
  // Buscar unidad real (L, Kg o Pza)
  var unidad = "L";
  var prodId = document.getElementById("producto").value;
  if(window.CACHE_CATALOGOS && prodId) {
      var prodData = window.CACHE_CATALOGOS.productos.find(x => x.id === prodId);
      if(prodData && prodData.unidad) {
          let uLow = prodData.unidad.toLowerCase();
          if (uLow.includes("unid") || uLow.includes("pza") || uLow.includes("pieza")) unidad = "Pza";
          else if (uLow.includes("kg") || uLow.includes("kilo")) unidad = "Kg";
      }
  }
  
  var el = document.getElementById("infoTotal");
  if(el) {
      if (unidad === 'Pza') {
         el.innerText = Math.round(total) + " " + unidad;
      } else {
         el.innerText = total.toFixed(2) + " " + unidad;
      }
  }
  return { total: total, unidad: unidad };
}

function guardarEntradaDirecta() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  Swal.fire({ title: 'Procesando...', text: 'Registrando entrada en almacÃ©n...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
  
  google.script.run
    .withSuccessHandler(function() {
      Swal.fire("Â¡Ã‰xito!", "Entrada registrada correctamente.", "success");
      limpiarFormularioEntrada();
      if(typeof recargarSelectores === 'function') recargarSelectores();
      if(typeof cargarHistorialEntradas === 'function') cargarHistorialEntradas();
    })
    .withFailureHandler(function(err) {
      Swal.fire("Error", err.message, "error");
    })
    .registrarEntradaUnica(item);
}

function agregarColaEntrada() {
  var item = construirObjetoEntrada();
  if (!item) return;
  
  if(typeof COLA_ENTRADAS !== 'undefined') {
      COLA_ENTRADAS.push(item);
      renderizarColaEntrada();
  }
  
  // Bloquear botÃ³n directo
  var btnDir = document.getElementById("btn-entrada-directa");
  if(btnDir) { btnDir.disabled = true; btnDir.style.opacity = '0.5'; }
  
  // Limpieza parcial
  ["cantidad", "lote", "producto_search", "producto"].forEach(function(id) { 
      var e = document.getElementById(id); if(e) e.value = ""; 
  });
  
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  mostrarToast("Agregado a la lista de ingreso", "success");
}

function eliminarEnt(index) {
  COLA_ENTRADAS.splice(index, 1);
  renderizarColaEntrada();
  
  // Desbloquear si estÃ¡ vacÃ­o
  if(COLA_ENTRADAS.length === 0) {
      var btnDir = document.getElementById("btn-entrada-directa");
      if(btnDir) { btnDir.disabled = false; btnDir.style.opacity = '1'; }
  }
}

function construirObjetoEntrada() {
  var calculo = calcularTotalEntrada();
  if (!(calculo.total > 0)) { mostrarToast("Cantidad invÃ¡lida", "error"); return null; }
  
  var elLote = document.getElementById("lote");
  var lote = elLote ? elLote.value.trim() : "";
  if (!lote) { mostrarToast("Falta el Lote", "error"); if(elLote) elLote.focus(); return null; }
  
var pId = document.getElementById("producto").value;
  var pName = document.getElementById("producto_search").value;
  if (!pId) { mostrarToast("Selecciona un producto vÃ¡lido", "warning"); return null; }
  
  // --- INICIO DEL CAMBIO ---
  var fabRaw = document.getElementById("elaboracion") ? document.getElementById("elaboracion").value : "";
  var fab = fabRaw;
  
  // Si el input manda "YYYY-MM" (ej. 2026-02), le agregamos "-01" para que el backend lo entienda como "2026-02-01"
  if (fabRaw && fabRaw.length === 7) {
      fab = fabRaw + "-01"; 
  }
  // --- FIN DEL CAMBIO ---

  return {
    producto_id: pId,
    nombre_producto: pName,
    presentacion_id: document.getElementById("presentacion").value,
    nombre_presentacion: getTextoSelect("presentacion"),
    ubicacion_id: document.getElementById("ubicacion").value,
    nombre_ubicacion: getTextoSelect("ubicacion"),
    volumen_L: calculo.total,
    unidad_medida: calculo.unidad,
    piezas: document.getElementById("cantidad").value,
    lote: lote,
    proveedor: document.getElementById("proveedor").value,
    fecha_elaboracion: fab, // <--- AquÃ­ mandarÃ¡ "2026-02-01"
    fecha_caducidad: "" 
  };
}

function limpiarFormularioEntrada() {
  ["cantidad", "lote", "proveedor", "elaboracion", "producto", "producto_search", "presentacion", "ubicacion"].forEach(id => { 
      var e = document.getElementById(id); if(e) e.value = ""; 
  });
  var info = document.getElementById("infoTotal");
  if(info) info.innerText = "0 L";
  
  var btnDir = document.getElementById("btn-entrada-directa");
  if(btnDir) { btnDir.disabled = false; btnDir.style.opacity = '1'; }

  // --- NUEVO: Ocultar el recuadro contextual al limpiar ---
  var infoDiv = document.getElementById("info-contextual-entrada");
  if (infoDiv) infoDiv.style.display = "none";
}

function procesarEntradas() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  var lbl = document.getElementById("lblCantMasiva");
  if(lbl) lbl.innerText = COLA_ENTRADAS.length + " partidas";
  abrirModalGenerico("modalConfirmarMasivo");
}

function renderizarColaEntrada() {
  if(typeof COLA_ENTRADAS !== 'undefined' && typeof renderColaGenerica === 'function') {
      renderColaGenerica(COLA_ENTRADAS, "area-cola-entradas", "tablaColaEntradaBody", "contadorColaEnt", "ent");
  }
}

function ejecutarGuardadoMasivo() {
  if (typeof COLA_ENTRADAS === 'undefined' || COLA_ENTRADAS.length === 0) return;
  cerrarModalGenerico("modalConfirmarMasivo");

  Swal.fire({ title: 'Procesando...', text: 'Ingresando lotes al almacÃ©n...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});

  google.script.run
    .withSuccessHandler(function() {
      logActividad("ENTRADA MASIVA", `IngresÃ³ ${COLA_ENTRADAS.length} lotes nuevos al almacÃ©n.`);
       COLA_ENTRADAS = []; 
       renderizarColaEntrada();
       limpiarFormularioEntrada();
       Swal.fire("Â¡Ã‰xito!", "Ingreso Masivo completado.", "success");
       if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
       if(typeof recargarSelectores === 'function') recargarSelectores();
       if(typeof cargarHistorialEntradas === 'function') cargarHistorialEntradas();
    })
    .withFailureHandler(function(err) {
       Swal.fire("Error", err.message, "error");
       abrirModalGenerico("modalConfirmarMasivo");
    })
    .registrarEntradaMasiva(COLA_ENTRADAS);
}

// ==========================================
// RENDERIZADO DEL HISTORIAL DE ENTRADAS
// ==========================================
window.cargarHistorialEntradas = function() {
    const contenedor = document.getElementById("contenedor-tabla-entradas");
    if (!contenedor) return;
    
    contenedor.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #64748b;">
            <div class="modern-spinner"></div>
            <p style="margin-top: 15px;">Obteniendo registros...</p>
        </div>`;

    google.script.run
        .withSuccessHandler(data => {
            if (!data || !data.rows || data.rows.length === 0) {
                contenedor.innerHTML = `<div style="padding: 20px; text-align: center; color: #64748b; background: white; border-radius: 8px;">No hay registros de entradas recientes.</div>`;
                return;
            }
            
            // Tabla dinÃ¡mica sin desbordes
            let html = `<table class="modern-table" style="width: 100%; border-collapse: collapse; margin: 0;">`;
            
            html += `<thead style="position: sticky; top: 0; background: #f1f5f9; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.02);"><tr>`;
            data.headers.forEach(h => {
                html += `<th style="padding: 12px 15px;">${h}</th>`;
            });
            html += `</tr></thead><tbody>`;
            
            data.rows.forEach(row => {
                html += `<tr>`;
                row.forEach((celda, index) => {
                    let valor = String(celda).trim() === "" ? "<span style='color:#cbd5e1;'>---</span>" : celda;
                    let tdStyle = "padding: 12px 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle;";
                    
                    if (index === 0) tdStyle += " white-space: nowrap; font-size: 0.85rem; color: #64748b;"; 
                    else if (index === 1) { valor = `<strong style="color: #1e293b; line-height: 1.3; display: block;">${valor}</strong>`; tdStyle += " min-width: 150px;"; } 
                    else if (index === 2) tdStyle += " font-size: 0.85rem; color: #64748b;"; 
                    else if (index === 3) {
                         // Si dice "Ubic. Eliminada", la pintamos de gris para que se entienda
                         if(valor === "Ubic. Eliminada") valor = `<span style="color:#94a3b8; font-style:italic; font-size:0.8rem;">ðŸš« Eliminada</span>`;
                         tdStyle += " font-size: 0.85rem; color: #64748b;"; 
                    }
                    else if (index === 4) { valor = `<strong style="color: #007aff; font-size: 1.05rem;">${valor}</strong>`; tdStyle += " white-space: nowrap; text-align: right;"; } 
                    else if (index === 5 && valor !== "---") { valor = `<span class="id-badge" style="background:#fffbeb; color:#d97706; border:1px solid #fde68a;">${valor}</span>`; tdStyle += " white-space: nowrap;"; } 
                    
                    html += `<td style="${tdStyle}">${valor}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            contenedor.innerHTML = html;
        })
        .withFailureHandler(err => {
            contenedor.innerHTML = `<div style="color: #dc2626; padding: 20px; background: #fee2e2; border-radius: 8px; text-align: center;">Error al cargar: ${err.message}</div>`;
        })
        .obtenerHistorialEntradas();
};

// ==========================================
// FILTRO EN VIVO (Buscador a prueba de errores)
// ==========================================
// ==========================================
// RENDERIZADO DEL HISTORIAL DE ENTRADAS
// ==========================================
window.cargarHistorialEntradas = function() {
    const contenedor = document.getElementById("contenedor-tabla-entradas");
    if (!contenedor) return;
    
    contenedor.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #64748b;">
            <div class="modern-spinner"></div>
            <p style="margin-top: 15px;">Obteniendo registros...</p>
        </div>`;

    google.script.run
        .withSuccessHandler(data => {
            if (!data || !data.rows || data.rows.length === 0) {
                contenedor.innerHTML = `<div style="padding: 20px; text-align: center; color: #64748b; background: white; border-radius: 8px;">No hay registros de entradas recientes.</div>`;
                return;
            }
            
            // Tabla dinÃ¡mica sin desbordes
            let html = `<table class="modern-table" style="width: 100%; border-collapse: collapse; margin: 0;">`;
            
            html += `<thead style="position: sticky; top: 0; background: #f1f5f9; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.02);"><tr>`;
            data.headers.forEach(h => {
                html += `<th style="padding: 12px 15px; white-space: nowrap;">${h}</th>`;
            });
            html += `</tr></thead><tbody>`;
            
            data.rows.forEach(row => {
                html += `<tr>`;
                row.forEach((celda, index) => {
                    let valor = String(celda).trim() === "" ? "<span style='color:#cbd5e1;'>---</span>" : celda;
                    let tdStyle = "padding: 12px 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle;";
                    
                    if (index === 0) tdStyle += " white-space: nowrap; font-size: 0.85rem; color: #64748b;"; 
                    else if (index === 1) { valor = `<strong style="color: #1e293b; line-height: 1.3; display: block;">${valor}</strong>`; tdStyle += " min-width: 160px;"; } 
                    else if (index === 2) tdStyle += " font-size: 0.85rem; color: #64748b; white-space: nowrap;"; 
                    else if (index === 3) {
                         if(valor === "Ubic. Eliminada") valor = `<span style="color:#94a3b8; font-style:italic; font-size:0.8rem;">ðŸš« Eliminada</span>`;
                         tdStyle += " font-size: 0.85rem; color: #64748b; min-width: 120px;"; 
                    }
                    else if (index === 4) { valor = `<strong style="color: #007aff; font-size: 1.05rem;">${valor}</strong>`; tdStyle += " white-space: nowrap; text-align: right;"; } 
                    else if (index === 5 && valor !== "---") { valor = `<span class="id-badge" style="background:#fffbeb; color:#d97706; border:1px solid #fde68a;">${valor}</span>`; tdStyle += " white-space: nowrap;"; } 
                    // --- NUEVO: REGLA PARA EL PROVEEDOR ---
                    else if (index === 6) tdStyle += " font-size: 0.85rem; color: #64748b; white-space: nowrap;"; 
                    
                    html += `<td style="${tdStyle}">${valor}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            contenedor.innerHTML = html;
        })
        .withFailureHandler(err => {
            contenedor.innerHTML = `<div style="color: #dc2626; padding: 20px; background: #fee2e2; border-radius: 8px; text-align: center;">Error al cargar: ${err.message}</div>`;
        })
        .obtenerHistorialEntradas();
};