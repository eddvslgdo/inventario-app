// --- VISTA PRODUCTOS (SOLUCI√ìN DEFINITIVA) ---

// --- VISTA PRODUCTOS (SOLUCI√ìN DEFINITIVA) ---

function cargarDashboardProductos() {
  const contenedor = document.getElementById("contenedor-productos-lista");
  
  if (!contenedor) return;

  // 1. Aplicamos la clase de scroll global que creamos en el CSS
  contenedor.classList.add("list-scroll-container");

  // 2. Reemplazamos el loader antiguo por el nuevo Spinner animado
  contenedor.innerHTML = `
    <div class="loader-container">
        <div class="modern-spinner"></div>
        <div style="margin-top: 15px;">Calculando totales de inventario...</div>
    </div>`;

  google.script.run
    .withSuccessHandler((p) => {
      renderizarTablaProductos(p);
    })
    .withFailureHandler((e) => {
      console.error(e);
      if(contenedor) contenedor.innerHTML = '<div style="text-align:center; color:#d63031; padding:40px; background:white; border-radius:12px;">‚ùå Error al cargar datos.</div>';
    })
    .obtenerDatosProductos();
}
function renderizarTablaProductos(productos) {
  const contenedor = document.getElementById("contenedor-productos-lista");
  if (!contenedor) return;

  contenedor.innerHTML = "";

  const activos = productos.filter((p) => p.totalVolumen > 0.001);

  if (activos.length === 0) {
    contenedor.innerHTML = `
      <div style="text-align:center; padding:60px; color:#888; background:white; border-radius:16px; border:1px solid #eee;">
        <div style="font-size:3rem; margin-bottom:15px;">üì¶</div>
        <div style="font-weight:600; font-size:1.1rem;">Inventario Vac√≠o</div>
        <div style="font-size:0.9rem; margin-top:5px;">No hay productos con existencia.</div>
      </div>`;
    return;
  }

  activos.forEach((p, idx) => {
    
// --- SEM√ÅFORO DE STOCK (L√ìGICA BLINDADA) ---
    // Estrategia: Empezamos asumiendo que es BAJO (Naranja)
    // Usamos ">=" para evitar el s√≠mbolo "<" que te est√° dando problemas.
    
    let colorBorde = "#ff9500"; // Por defecto Naranja (Menos de 10)

    // Si es 10 o m√°s, lo cambiamos a Azul (Normal)
    if (p.totalVolumen >= 10) {
        colorBorde = "#007aff"; 
    }

    // Si es m√°s de 100, lo cambiamos a Verde (Alto)
    if (p.totalVolumen > 100) {
        colorBorde = "#34c759"; 
    }
    // --- TABLA INTERNA ---
    let filasDetalle = "";
    p.lotes.forEach(l => {
        filasDetalle += `
            <tr>
                <td style="font-weight:600; color:#333;">${l.ubicacion}</td>
                <td><span style="color:#666; font-size:0.85rem;">${l.presentacion}</span></td>
                <td><span class="col-lote">${l.lote}</span></td>
                <td style="color:#555;">${l.caducidad || "--"}</td>
                <td class="col-number">${l.volumen} L</td>
            </tr>
        `;
    });

    // --- TARJETA ---
    const card = document.createElement("div");
    card.className = "product-card";
    
    // CAMBIO DE ESTRATEGIA: Usamos un DIV real para la barra de color
    // Esto evita usar <style> dentro de JS, que es lo que causaba el error.
    card.innerHTML = `
        <div style="position:absolute; left:0; top:0; bottom:0; width:6px; background:${colorBorde};"></div>

        <div class="product-header" onclick="toggleDetalleProducto('${p.id}')">
            <div class="product-info">
                <h3>${p.nombre}</h3>
                <span>üì¶ ${p.lotes.length} Lote(s) &bull; Total: <strong>${p.totalVolumen.toFixed(2)} ${p.unidad || 'L'}</strong></span>
            </div>
            
            <div class="product-actions">
                <span class="stock-badge" style="color:${colorBorde}; background-color:${colorBorde}15; border:1px solid ${colorBorde}30;">
                    ${p.totalVolumen.toFixed(2)} ${p.unidad || 'L'}
                </span>
                <button class="btn-toggle-details">
                    Ver Detalle <span style="font-size:0.8rem; margin-left:6px; opacity:0.6;">‚ñº</span>
                </button>
            </div>
        </div>
        
        <div id="detalle-${p.id}" class="product-details">
            <table class="details-table">
                <thead>
                    <tr>
                        <th style="width:25%">Ubicaci√≥n</th>
                        <th style="width:25%">Presentaci√≥n</th>
                        <th style="width:20%">Lote</th>
                        <th style="width:15%">Caducidad</th>
                        <th style="width:15%; text-align:right">Cantidad</th>
                    </tr>
                </thead>
                <tbody>
                    ${filasDetalle}
                </tbody>
            </table>
        </div>
    `;

    contenedor.appendChild(card);
  });
}

function toggleDetalleProducto(id) {
  const el = document.getElementById("detalle-" + id);
  if (el) {
      if (el.style.display === "block") {
          el.style.display = "none";
      } else {
          el.style.display = "block";
      }
  }
}

function filtrarProductos() {
  const txt = document.getElementById("buscadorProductos").value.toLowerCase();
  const tarjetas = document.querySelectorAll(".product-card");
  let encontrados = 0;

  tarjetas.forEach(card => {
      const titulo = card.querySelector("h3");
      if(titulo) {
          const nombre = titulo.innerText.toLowerCase();
          if (nombre.includes(txt)) {
              card.style.display = "";
              encontrados++;
          } else {
              card.style.display = "none";
          }
      }
  });

  let msg = document.getElementById("msg-no-resultados");
  if(encontrados === 0 && txt !== "") {
     if(!msg) {
        msg = document.createElement("div");
        msg.id = "msg-no-resultados";
        msg.style.textAlign = "center"; msg.style.padding = "40px"; msg.style.color="#888";
        msg.innerHTML = "No se encontraron productos con ese nombre.";
        document.getElementById("contenedor-productos-lista").appendChild(msg);
     }
  } else {
     if(msg) msg.remove();
  }
}

// --- MODALES (NO CAMBIAN) ---

function guardarProducto() {
  // 1. Tomamos el valor y lo estandarizamos: May√∫sculas y sin espacios dobles
  let nombreRaw = document.getElementById("nuevoNombre").value;
  const nombreLimpio = nombreRaw.trim().replace(/\s+/g, ' ').toUpperCase();
  const desc = document.getElementById("nuevaDescripcion").value;
  const unidad = document.getElementById("nuevaUnidad").value;

  if (!nombreLimpio) return mostrarToast("Falta el nombre del producto", "warning");

  // 2. Cerramos la ventana del formulario
  if(typeof cerrarModal === 'function') cerrarModal();
  if(typeof cerrarModalGenerico === 'function') cerrarModalGenerico('modalProducto'); 

  // 3. Mostramos el Loader elegante de "Procesando..."
  Swal.fire({
    title: 'Procesando...',
    text: 'Validando y registrando producto...',
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });

  google.script.run
    .withSuccessHandler(function() {
      Swal.fire("¬°√âxito!", `El producto ${nombreLimpio} ha sido registrado.`, "success");
      document.getElementById("nuevoNombre").value = "";
      document.getElementById("nuevaDescripcion").value = "";
      
      if(typeof recargarSelectores === 'function') recargarSelectores();
      if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
    })
    .withFailureHandler(function(err) {
      // Si el servidor detecta un duplicado, mostrar√° el error aqu√≠
      Swal.fire("No se pudo registrar", err.message, "error");
      
      // Volvemos a abrir el modal para que el usuario corrija si quiere
      if(typeof abrirModalGenerico === 'function') abrirModalGenerico('modalProducto'); 
    })
    .registrarNuevoProducto({ nombre: nombreLimpio, descripcion: desc, unidad: unidad });
}

function guardarPresentacion() {
  const desc = document.getElementById("nuevaPresDesc").value;
  if (!desc) return mostrarToast("Falta descripci√≥n", "error");

  const btn = event.target;
  const textoOriginal = btn.innerText;
  btn.disabled = true;
  btn.innerText = "Guardando...";

  google.script.run
    .withSuccessHandler(function() {
      mostrarToast("Presentaci√≥n creada ‚úÖ", "success");
      document.getElementById("nuevaPresDesc").value = "";
      recargarSelectores();
      if(typeof cerrarModalGenerico === 'function') cerrarModalGenerico('modalPresentacion');
      btn.disabled = false;
      btn.innerText = textoOriginal;
    })
    .withFailureHandler(function(err) {
      mostrarError(err);
      btn.disabled = false;
      btn.innerText = textoOriginal;
    })
    .registrarNuevaPresentacion(desc);
}