// --- VISTA PRODUCTOS (NIVEL DIOS: FILTROS + CADUCIDAD + EXPORTACI√ìN) ---

let PRODUCTOS_CACHE = [];
let FILTRO_BAJO_STOCK = false;
let FILTRO_PROX_CADUCAR = false;

function cargarDashboardProductos() {
  const contenedor = document.getElementById("contenedor-productos-lista");
  if (!contenedor) return;

  contenedor.classList.add("list-scroll-container");
  contenedor.innerHTML = `
    <div class="loader-container" style="padding: 60px 0;">
        <div class="modern-spinner"></div>
    </div>`;

  google.script.run
    .withSuccessHandler((p) => {
      PRODUCTOS_CACHE = p; 
      renderizarTablaProductos(p);
    })
    .withFailureHandler((e) => {
      console.error(e);
      if(contenedor) contenedor.innerHTML = '<div style="text-align:center; color:#dc2626; padding:40px; background:white; border-radius:8px; border:1px solid #fecaca;">‚ùå Error al cargar datos.</div>';
    })
    .obtenerDatosProductos();
}

function parseFechaCaducidad(str) {
    if(!str || typeof str !== 'string' || str === "---" || str.includes("SIN-FECHA")) return null;
    try {
        let partes = str.split('/');
        if(partes.length === 3) return new Date(partes[2], partes[1]-1, partes[0]);
        if(str.includes('-')) {
            let p2 = str.split('-');
            if(p2.length === 3 && p2[0].length === 4) return new Date(p2[0], p2[1]-1, p2[2]); 
        }
    } catch(e) { return null; }
    return null;
}

function renderizarTablaProductos(productos) {
  const contenedor = document.getElementById("contenedor-productos-lista");
  if (!contenedor) return;
  contenedor.innerHTML = "";

  const activos = productos.filter((p) => p.totalVolumen > 0.001);

  if (activos.length === 0) {
    contenedor.innerHTML = `
      <div style="text-align:center; padding:60px; color:#64748b; background:white; border-radius:12px; border:1px solid #e2e8f0;">
        <div style="font-size:2.5rem; margin-bottom:15px; opacity:0.5;">üì¶</div>
        <div style="font-weight:600; font-size:1.1rem;">Inventario Vac√≠o</div>
      </div>`;
    return;
  }

  const hoy = new Date();
  hoy.setHours(0,0,0,0);
  const limiteTresMeses = new Date();
  limiteTresMeses.setMonth(hoy.getMonth() + 3);

  const grupos = {
      'L': { titulo: 'VOLUMEN (L√çQUIDOS)', icon: 'üíß', color: '#0284c7', bg: '#f0f9ff', total: 0, items: [] },
      'Kg': { titulo: 'MASA (S√ìLIDOS)', icon: '‚öñÔ∏è', color: '#d97706', bg: '#fffbeb', total: 0, items: [] },
      'Pza': { titulo: 'PIEZAS (INDIVISIBLES)', icon: 'üì¶', color: '#7e22ce', bg: '#faf5ff', total: 0, items: [] }
  };

  activos.forEach(p => {
      let u = p.unidad || 'L';
      if (!grupos[u]) u = 'L'; 
      grupos[u].items.push(p);
      grupos[u].total += p.totalVolumen;
  });

  ['L', 'Kg', 'Pza'].forEach(key => {
      const grupo = grupos[key];
      if (grupo.items.length === 0) return;

      let displayTotalGrupo = (key === 'Pza') ? Math.round(grupo.total) : grupo.total.toFixed(2);
      const groupId = `grupo-content-${key}`;

      const groupWrapper = document.createElement("div");
      groupWrapper.className = "inventory-group";

      const headerGrupo = document.createElement("div");
      headerGrupo.className = "group-accordion-header";
      headerGrupo.style.borderLeftColor = grupo.color;
      headerGrupo.style.backgroundColor = grupo.bg;
      headerGrupo.onclick = () => toggleGrupo(groupId);
      headerGrupo.innerHTML = `
        <div class="group-title-area">
            <span id="icon-${groupId}" class="group-chevron">‚ñ∂</span>
            <span style="color:${grupo.color}; font-weight:700; font-size:0.9rem; letter-spacing:0.5px;">${grupo.icon} ${grupo.titulo}</span>
        </div>
        <div class="group-total-badge" style="color:${grupo.color}; border-color:${grupo.color}40;">
            Total: <strong>${displayTotalGrupo} ${key}</strong>
        </div>`;

      const contentGrupo = document.createElement("div");
      contentGrupo.id = groupId;
      contentGrupo.className = "group-accordion-content";
      contentGrupo.style.display = "none";

      grupo.items.sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(p => {
          
          let colorIndicador = "#f59e0b"; 
          if (p.totalVolumen >= 10) colorIndicador = "#3b82f6"; 
          if (p.totalVolumen > 100) colorIndicador = "#10b981"; 

          let filasDetalle = "";
          let productoExpiraPronto = false; 

         p.lotes.forEach(l => {
              let aliasTag = (l.alias && l.alias.trim() !== "") ? `<span class="alias-tag">Variante: ${l.alias}</span>` : "";
              
              let fCad = parseFechaCaducidad(l.caducidad);
              let cadAlertaHtml = l.caducidad || "--";
              let rowBg = "";

              if (fCad) {
                  let fCadTime = fCad.getTime();
                  let hoyTime = hoy.getTime();
                  let limiteTime = limiteTresMeses.getTime();

                  if (hoyTime > fCadTime) { 
                      cadAlertaHtml = `<span style="color:#dc2626; font-weight:bold;">${l.caducidad} (Vencido)</span>`;
                      rowBg = "background:#fef2f2;";
                      productoExpiraPronto = true;
                  } else if (limiteTime >= fCadTime) { 
                      cadAlertaHtml = `<span style="color:#ea580c; font-weight:bold;">${l.caducidad} (Pr√≥ximo)</span>`;
                      rowBg = "background:#fffbeb;";
                      productoExpiraPronto = true;
                  }
              }

              // NUEVO: Bot√≥n de Transformaci√≥n directo en el listado
              let btnTransf = `<button class="btn-action btn-transf" style="width:28px; height:28px; font-size:0.8rem; margin-left:12px; box-shadow:0 1px 2px rgba(0,0,0,0.1);" title="Transformar Lote" onclick="abrirTransformacion('${p.id}', '${p.nombre}', '${l.lote}', ${l.volumen}, '${l.ubicacion_id}', '${l.presentacion_id}', ${l.volumen_nominal}, '${p.unidad}')">üõ†Ô∏è</button>`;

              filasDetalle += `
                  <tr style="${rowBg}">
                      <td class="td-ubic">${l.ubicacion}</td>
                      <td><div class="td-pres">${l.presentacion}</div>${aliasTag}</td>
                      <td><span class="lote-tag">${l.lote}</span></td>
                      <td class="td-cad">${cadAlertaHtml}</td>
                      <td class="td-cant">
                         <div style="display:flex; justify-content:flex-end; align-items:center;">
                            <span>${l.volumen} <span style="font-size:0.75rem; color:#888;">${p.unidad}</span></span>
                            ${btnTransf}
                         </div>
                      </td>
                  </tr>
              `;
          });

          let displayTotalProd = (key === 'Pza') ? Math.round(p.totalVolumen) : p.totalVolumen.toFixed(2);
          
          let badgeCaducidad = productoExpiraPronto 
            ? `<span style="background:#ffedd5; color:#c2410c; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold; margin-left:10px; border:1px solid #fed7aa;">‚è≥ Alerta Caducidad</span>` 
            : "";

          const card = document.createElement("div");
          card.className = "product-card-compact";
          card.setAttribute("data-stock", p.totalVolumen);
          card.setAttribute("data-expira", productoExpiraPronto ? "true" : "false");

          card.innerHTML = `
              <div class="card-indicator" style="background:${colorIndicador};"></div>
              <div class="card-header-compact" onclick="toggleDetalleProducto('${p.id}')">
                  <div class="info-main">
                      <h3 class="prod-title">${p.nombre} ${badgeCaducidad}</h3>
                      <span class="prod-meta">${p.lotes.length} lote(s) registrados</span>
                  </div>
                  <div class="info-actions">
                      <div class="prod-stock">${displayTotalProd} <span>${p.unidad}</span></div>
                      <button class="btn-detalles-compact">Ver <span>‚ñº</span></button>
                  </div>
              </div>
              <div id="detalle-${p.id}" class="card-body-compact" style="display:none;">
                  <table class="table-compact">
                      <thead>
                          <tr><th>Ubicaci√≥n</th><th>Presentaci√≥n</th><th>Lote</th><th>Caducidad</th><th style="text-align:right;">Stock</th></tr>
                      </thead>
                      <tbody>${filasDetalle}</tbody>
                  </table>
              </div>
          `;
          contentGrupo.appendChild(card);
      });

      groupWrapper.appendChild(headerGrupo);
      groupWrapper.appendChild(contentGrupo);
      contenedor.appendChild(groupWrapper);
  });
}

// --- LOGICA DE BOTONES SWITCH (FILTROS) ---
window.toggleFiltroStock = function() {
    FILTRO_BAJO_STOCK = !FILTRO_BAJO_STOCK;
    document.getElementById("btnFiltroStock").classList.toggle("active", FILTRO_BAJO_STOCK);
    filtrarProductos();
};

window.toggleFiltroCaducidad = function() {
    FILTRO_PROX_CADUCAR = !FILTRO_PROX_CADUCAR;
    document.getElementById("btnFiltroCaducidad").classList.toggle("active", FILTRO_PROX_CADUCAR);
    filtrarProductos();
};

// --- EL S√öPER BUSCADOR Y FILTRADOR ---
window.filtrarProductos = function() {
  const txt = document.getElementById("buscadorProductos").value.toLowerCase();
  const grupos = document.querySelectorAll(".inventory-group");
  let encontradosGlobal = 0;

  grupos.forEach(grupo => {
      const content = grupo.querySelector(".group-accordion-content");
      const cards = content.querySelectorAll(".product-card-compact");
      const icon = grupo.querySelector(".group-chevron");
      let encontradosGrupo = 0;

      cards.forEach(card => {
          // --- MAGIA: Ahora lee todo el texto de la tarjeta (t√≠tulo, lote, variante, etc.) ---
          const textoTarjeta = card.innerText.toLowerCase(); 
          const stock = parseFloat(card.getAttribute("data-stock")) || 0;
          const expira = card.getAttribute("data-expira") === "true";
          
          let pasaTexto = textoTarjeta.includes(txt);
          let pasaStock = FILTRO_BAJO_STOCK ? (10 > stock) : true; 
          let pasaCaducidad = FILTRO_PROX_CADUCAR ? expira : true;

          if (pasaTexto && pasaStock && pasaCaducidad) {
              card.style.display = "";
              encontradosGrupo++;
              encontradosGlobal++;
          } else {
              card.style.display = "none";
          }
      });

      if (txt !== "" || FILTRO_BAJO_STOCK || FILTRO_PROX_CADUCAR) {
          if (encontradosGrupo > 0) {
              grupo.style.display = "";
              content.style.display = "block"; 
              if(icon) icon.style.transform = 'rotate(90deg)';
          } else {
              grupo.style.display = "none"; 
          }
      } else {
          grupo.style.display = "";
          content.style.display = "none"; 
          if(icon) icon.style.transform = 'rotate(0deg)';
      }
  });

  let msg = document.getElementById("msg-no-resultados");
  if(encontradosGlobal === 0) {
     if(!msg) {
        msg = document.createElement("div");
        msg.id = "msg-no-resultados";
        msg.style.cssText = "text-align:center; padding:40px; color:#64748b; font-size:0.95rem; background:white; border-radius:8px; border:1px solid #e2e8f0; margin-top:15px;";
        msg.innerHTML = "No se encontraron productos, variantes ni lotes que coincidan con la b√∫squeda.";
        document.getElementById("contenedor-productos-lista").appendChild(msg);
     }
  } else if (msg) {
     msg.remove();
  }
};

// --- EXPORTAR A EXCEL (CSV) NATIVO ---
window.exportarInventarioCSV = function() {
    if(!PRODUCTOS_CACHE || PRODUCTOS_CACHE.length === 0) {
        return Swal.fire('Sin Datos', 'No hay inventario para exportar.', 'info');
    }
    
    let csv = "Producto,Variante_Alias,Presentacion,Ubicacion,Lote,Caducidad,Volumen,Unidad\n";

    PRODUCTOS_CACHE.forEach(p => {
        if(p.lotes && p.lotes.length > 0) {
            p.lotes.forEach(l => {
                let nombre = `"${(p.nombre || "").replace(/"/g, '""')}"`;
                let alias = `"${(l.alias || "").replace(/"/g, '""')}"`;
                let pres = `"${(l.presentacion || "").replace(/"/g, '""')}"`;
                let ubic = `"${(l.ubicacion || "").replace(/"/g, '""')}"`;
                let lote = `"${(l.lote || "").replace(/"/g, '""')}"`;
                let cad = `"${l.caducidad || ""}"`;
                let vol = l.volumen || 0;
                let uni = `"${p.unidad || ""}"`;
                
                csv += `${nombre},${alias},${pres},${ubic},${lote},${cad},${vol},${uni}\n`;
            });
        }
    });

    const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); 
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement("a");
    link.href = url;
    link.download = `Inventario_Global_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    if (typeof mostrarToast === 'function') mostrarToast("Descarga iniciada ‚úÖ", "success");
};

// --- UTILIDADES ---
window.toggleGrupo = function(id) {
    const el = document.getElementById(id);
    const icon = document.getElementById('icon-' + id);
    if (!el) return;
    if (el.style.display === 'none') {
        el.style.display = 'block';
        if(icon) icon.style.transform = 'rotate(90deg)';
    } else {
        el.style.display = 'none';
        if(icon) icon.style.transform = 'rotate(0deg)';
    }
};

window.toggleDetalleProducto = function(id) {
  const el = document.getElementById("detalle-" + id);
  if (el) el.style.display = (el.style.display === "block") ? "none" : "block";
};

// --- MODALES (GUARDAR PRODUCTO) ---
function guardarProducto() { 
  let nombreRaw = document.getElementById("nuevoNombre").value;
  const nombreLimpio = nombreRaw.trim().replace(/\s+/g, ' ').toUpperCase();
  const desc = document.getElementById("nuevaDescripcion").value;
  const unidad = document.getElementById("nuevaUnidad").value;
  if (!nombreLimpio) return mostrarToast("Falta el nombre", "warning");

  if(typeof cerrarModal === 'function') cerrarModal();
  if(typeof cerrarModalGenerico === 'function') cerrarModalGenerico('modalProducto'); 
  Swal.fire({ title: 'Procesando...', text: 'Registrando producto...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});

  google.script.run.withSuccessHandler(function() {
      Swal.fire("¬°√âxito!", `El producto ha sido registrado.`, "success");
      document.getElementById("nuevoNombre").value = "";
      document.getElementById("nuevaDescripcion").value = "";
      if(typeof recargarSelectores === 'function') recargarSelectores();
      if(typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
  }).withFailureHandler(function(err) {
      Swal.fire("No se pudo registrar", err.message, "error");
      if(typeof abrirModalGenerico === 'function') abrirModalGenerico('modalProducto'); 
  }).registrarNuevoProducto({ nombre: nombreLimpio, descripcion: desc, unidad: unidad });
}