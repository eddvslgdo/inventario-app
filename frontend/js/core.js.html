// core.js.html - Versión con Limpieza Total de Tablas y Carritos

window.cambiarVista = function (vistaId) {
  // 1. Ocultar vistas
  document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // 2. Mostrar vista seleccionada
  const vista = document.getElementById(vistaId);
  if (vista) vista.style.display = 'flex';

  // 3. Resaltar botón
  document.querySelectorAll('.nav-btn').forEach(btn => {
    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(vistaId)) {
      btn.classList.add('active');
    }
  });

  // --- 4. LÓGICA DE CARGA Y LIMPIEZA POR PESTAÑA ---

  if (vistaId === 'vista-operacion') {
      // Limpieza total de ENTRADAS (Borra tabla, carrito y formulario)
      if (typeof COLA_ENTRADAS !== 'undefined') {
          COLA_ENTRADAS = [];
          if (typeof renderizarColaEntrada === 'function') renderizarColaEntrada();
      }
      if (typeof limpiarFormularioEntrada === 'function') limpiarFormularioEntrada();
  }

  if (vistaId === 'vista-salidas') {
      if (typeof recargarSelectores === 'function') recargarSelectores();
      // LIMPIEZA TOTAL DE SALIDAS (Borra carrito, tabla de disponibilidad y campos)
      if (typeof iniciarVistaSalidas === 'function') iniciarVistaSalidas(); 
  }

  if (vistaId === 'vista-bajas') {
      // LIMPIEZA TOTAL DE BAJAS (Vaciamos la cola y renderizamos en blanco)
      if (typeof COLA_BAJAS !== 'undefined') {
          COLA_BAJAS = [];
          if (typeof renderColaBajas === 'function') renderColaBajas();
      }
      if (typeof cargarCaducados === 'function') cargarCaducados();
  }

  if (vistaId === 'vista-ubicaciones' && typeof cargarDashboardUbicaciones === 'function') cargarDashboardUbicaciones();
  if (vistaId === 'vista-productos' && typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
  if (vistaId === 'vista-pedidos' && typeof cargarDashboardPedidos === 'function') cargarDashboardPedidos();
};

function recargarSelectores() {
  mostrarCargando("Actualizando catálogos..."); 

  if(typeof api !== 'undefined') api.obtenerCatalogos(function(data){
      llenarSelects(data);
  });
  
  if(typeof api !== 'undefined') {
      google.script.run.withSuccessHandler((c) => {
        LISTA_CLIENTES = c;
        if(typeof llenarSelectClientes === 'function') llenarSelectClientes();
        ocultarCargando(); 
      }).obtenerListaClientes();
  }
}

function llenarSelects(data) {
  // 1. Entradas: Muestra TODOS los productos
  poblarSelect("producto", data.productos);
  poblarSelect("ubicacion", data.ubicaciones);

  var fnEntrada = (typeof calcularTotalEntrada === 'function') ? calcularTotalEntrada : function(){ console.warn("Fn Entrada no cargada"); return 0; };
  setupPresentacion("presentacion", data.presentaciones, fnEntrada);

  // 2. Salidas: FILTRAMOS PARA MOSTRAR SOLO LOS QUE TIENEN STOCK (> 0)
  const productosConStock = data.productos.filter(p => p.stockTotal > 0.001);
  poblarSelect("sal_producto", productosConStock);
  
  poblarSelect("sal_ubicacion", data.ubicaciones);

  var fnSalida = (typeof calcularTotalSalida === 'function') ? calcularTotalSalida : function(){ console.warn("Fn Salida no cargada"); return 0; };
  setupPresentacion("sal_presentacion", data.presentaciones, fnSalida);

  // 3. Transformaciones: Muestra TODOS los productos 
  if (document.getElementById("selTransfNuevoProd"))
    poblarSelect("selTransfNuevoProd", data.productos);
  if (document.getElementById("selTransfNuevaPres"))
    setupPresentacion("selTransfNuevaPres", data.presentaciones, null);

  // Reactivar eventos
  const selProdSalida = document.getElementById("sal_producto");
  if (selProdSalida) {
    const nuevoSel = selProdSalida.cloneNode(true);
    selProdSalida.parentNode.replaceChild(nuevoSel, selProdSalida);
    if (typeof aplicarFIFO === 'function') {
        nuevoSel.addEventListener("change", aplicarFIFO);
    }
  }
}

function llenarSelectClientes() {
  const sel = document.getElementById("log_cliente_select");
  if (!sel) return;
  
  sel.innerHTML = '<option value="">-- Nuevo / Manual --</option>';
  
  if(typeof LISTA_CLIENTES !== 'undefined'){
      LISTA_CLIENTES.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c.id;
        
        let nombre = c.nombre || "Sin Nombre";
        let empresa = (c.empresa && c.empresa.trim() !== "") ? `[${c.empresa}]` : "";
        let dirCorta = c.direccion || "Sin dirección";
        
        if (dirCorta.length > 35) {
            dirCorta = dirCorta.substring(0, 35) + "...";
        }
        
        let textoFinal = nombre;
        if (empresa !== "") textoFinal += ` ${empresa}`;
        textoFinal += ` - ${dirCorta}`;
        
        opt.text = textoFinal;
        
        sel.appendChild(opt);
      });
  }
}

function poblarSelect(id, lista) {
  const select = document.getElementById(id);
  if (!select) return;
  select.innerHTML = '<option value="">Selecciona...</option>';
  if(lista){
      lista.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.text = item.nombre;
        select.appendChild(option);
      });
  }
}

function setupPresentacion(idSelect, lista, funcionCalculo) {
  const select = document.getElementById(idSelect);
  if (!select) return;
  const newSelect = select.cloneNode(false);
  select.parentNode.replaceChild(newSelect, select);
  newSelect.id = idSelect;
  newSelect.className = "input-modern";
  newSelect.innerHTML = '<option value="">Selecciona...</option>';
  
  if (typeof funcionCalculo === 'function') {
      newSelect.addEventListener("change", funcionCalculo);
  }
  
  if(lista){
      lista.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.text = item.nombre;
        option.setAttribute("data-volumen", item.volumen || 0);
        newSelect.appendChild(option);
      });
  }
}

function getTextoSelect(id) {
  const s = document.getElementById(id);
  return s && s.options.length > 0 && s.selectedIndex >= 0
    ? s.options[s.selectedIndex].text
    : "";
}