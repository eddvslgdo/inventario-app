// core.js.html - Versión Blindada
window.cambiarVista = function (vistaId) {
  document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  const vista = document.getElementById(vistaId);
  if (vista) vista.style.display = 'block';

  document.querySelectorAll('.nav-btn').forEach(btn => {
    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(vistaId)) {
      btn.classList.add('active');
    }
  });

  if (vistaId === 'vista-ubicaciones' && typeof cargarDashboardUbicaciones === 'function') cargarDashboardUbicaciones();
  if (vistaId === 'vista-productos' && typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
  if (vistaId === 'vista-salidas' && typeof recargarSelectores === 'function') recargarSelectores();
  if (vistaId === 'vista-pedidos' && typeof cargarDashboardPedidos === 'function') cargarDashboardPedidos();
};

function recargarSelectores() {
  if(typeof api !== 'undefined') api.obtenerCatalogos(llenarSelects);
  if(typeof api !== 'undefined') {
      google.script.run.withSuccessHandler((c) => {
        LISTA_CLIENTES = c;
        if(typeof llenarSelectClientes === 'function') llenarSelectClientes();
      }).obtenerListaClientes();
  }
}

function llenarSelects(data) {
  poblarSelect("producto", data.productos);
  poblarSelect("ubicacion", data.ubicaciones);

  // --- SEGURIDAD AQUÍ ---
  // Si calcularTotalEntrada no existe, usamos una función vacía para que no rompa
  var fnEntrada = (typeof calcularTotalEntrada === 'function') ? calcularTotalEntrada : function(){ console.warn("Fn Entrada no cargada"); return 0; };
  setupPresentacion("presentacion", data.presentaciones, fnEntrada);

  poblarSelect("sal_producto", data.productos);
  poblarSelect("sal_ubicacion", data.ubicaciones);

  var fnSalida = (typeof calcularTotalSalida === 'function') ? calcularTotalSalida : function(){ console.warn("Fn Salida no cargada"); return 0; };
  setupPresentacion("sal_presentacion", data.presentaciones, fnSalida);

  if (document.getElementById("selTransfNuevoProd"))
    poblarSelect("selTransfNuevoProd", data.productos);
  if (document.getElementById("selTransfNuevaPres"))
    setupPresentacion("selTransfNuevaPres", data.presentaciones, null);

  const selProdSalida = document.getElementById("sal_producto");
  if (selProdSalida) {
    const nuevoSel = selProdSalida.cloneNode(true);
    selProdSalida.parentNode.replaceChild(nuevoSel, selProdSalida);
    if (typeof aplicarFIFO === 'function') {
        nuevoSel.addEventListener("change", aplicarFIFO);
    }
  }
}

function llenarSelectClientes() {
  const sel = document.getElementById("log_cliente_select");
  if (!sel) return;
  sel.innerHTML = '<option value="">-- Nuevo / Manual --</option>';
  if(typeof LISTA_CLIENTES !== 'undefined'){
      LISTA_CLIENTES.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.text = c.nombre;
        sel.appendChild(opt);
      });
  }
}

function poblarSelect(id, lista) {
  const select = document.getElementById(id);
  if (!select) return;
  select.innerHTML = '<option value="">Selecciona...</option>';
  if(lista){
      lista.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.text = item.nombre;
        select.appendChild(option);
      });
  }
}

function setupPresentacion(idSelect, lista, funcionCalculo) {
  const select = document.getElementById(idSelect);
  if (!select) return;
  const newSelect = select.cloneNode(false);
  select.parentNode.replaceChild(newSelect, select);
  newSelect.id = idSelect;
  newSelect.className = "input-modern";
  newSelect.innerHTML = '<option value="">Selecciona...</option>';
  
  if (typeof funcionCalculo === 'function') {
      newSelect.addEventListener("change", funcionCalculo);
  }
  
  if(lista){
      lista.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.text = item.nombre;
        option.setAttribute("data-volumen", item.volumen || 0);
        newSelect.appendChild(option);
      });
  }
}

function getTextoSelect(id) {
  const s = document.getElementById(id);
  return s && s.options.length > 0 && s.selectedIndex >= 0
    ? s.options[s.selectedIndex].text
    : "";
}