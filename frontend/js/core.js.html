// core.js.html - Versión con Limpieza Total de Tablas y Carritos

window.cambiarVista = function (vistaId) {
  // 1. Ocultar vistas
  document.querySelectorAll('.vista').forEach(v => v.style.display = 'none');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // 2. Mostrar vista seleccionada
  const vista = document.getElementById(vistaId);
  if (vista) vista.style.display = 'flex';

  // 3. Resaltar botón
  document.querySelectorAll('.nav-btn').forEach(btn => {
    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(vistaId)) {
      btn.classList.add('active');
    }
  });

  // --- 4. LÓGICA DE CARGA Y LIMPIEZA POR PESTAÑA ---

if (vistaId === 'vista-operacion') {
      if (typeof recargarSelectores === 'function') recargarSelectores(); // <--- Auto actualiza al entrar
      if (typeof COLA_ENTRADAS !== 'undefined') {
          COLA_ENTRADAS = [];
          if (typeof renderizarColaEntrada === 'function') renderizarColaEntrada();
      }
      if (typeof limpiarFormularioEntrada === 'function') limpiarFormularioEntrada();
  }

  if (vistaId === 'vista-salidas') {
      if (typeof recargarSelectores === 'function') recargarSelectores();
      // LIMPIEZA TOTAL DE SALIDAS (Borra carrito, tabla de disponibilidad y campos)
      if (typeof iniciarVistaSalidas === 'function') iniciarVistaSalidas(); 
  }

  if (vistaId === 'vista-bajas') {
      // LIMPIEZA TOTAL DE BAJAS (Vaciamos la cola y renderizamos en blanco)
      if (typeof COLA_BAJAS !== 'undefined') {
          COLA_BAJAS = [];
          if (typeof renderColaBajas === 'function') renderColaBajas();
      }
      if (typeof cargarCaducados === 'function') cargarCaducados();
  }

  if (vistaId === 'vista-ubicaciones' && typeof cargarDashboardUbicaciones === 'function') cargarDashboardUbicaciones();
  if (vistaId === 'vista-productos' && typeof cargarDashboardProductos === 'function') cargarDashboardProductos();
  if (vistaId === 'vista-pedidos' && typeof cargarDashboardPedidos === 'function') cargarDashboardPedidos();
};

function recargarSelectores() {
  mostrarCargando("Actualizando catálogos..."); 

  if(typeof api !== 'undefined') api.obtenerCatalogos(function(data){
      llenarSelects(data);
  });
  
  if(typeof api !== 'undefined') {
      google.script.run.withSuccessHandler((c) => {
        LISTA_CLIENTES = c;
        if(typeof llenarSelectClientes === 'function') llenarSelectClientes();
        ocultarCargando(); 
      }).obtenerListaClientes();
  }
}
function llenarSelects(data) {
  window.CACHE_CATALOGOS = data; 

  // 1. Llenar Autocomplete de ENTRADAS (Todos los productos)
  let dlEnt = document.getElementById("lista-productos-datalist");
  if(dlEnt) {
     dlEnt.innerHTML = "";
     data.productos.forEach(p => {
         let opt = document.createElement("option");
         opt.value = p.nombre;
         dlEnt.appendChild(opt);
     });
  }

  // 2. Llenar Autocomplete de SALIDAS (SOLO LOS QUE TIENEN STOCK > 0)
  let dlSal = document.getElementById("lista-productos-salida-datalist");
  if(dlSal) {
     dlSal.innerHTML = "";
     const productosConStock = data.productos.filter(p => p.stockTotal > 0.001);
     productosConStock.forEach(p => {
         let opt = document.createElement("option");
         opt.value = p.nombre;
         dlSal.appendChild(opt);
     });
  }
  // 1. Entradas: Muestra TODOS los productos
  poblarSelect("producto", data.productos);
  poblarSelect("ubicacion", data.ubicaciones);

  var fnEntrada = (typeof calcularTotalEntrada === 'function') ? calcularTotalEntrada : function(){ console.warn("Fn Entrada no cargada"); return 0; };
  setupPresentacion("presentacion", data.presentaciones, fnEntrada);

  // 2. Salidas: FILTRAMOS PARA MOSTRAR SOLO LOS QUE TIENEN STOCK (> 0)
  const productosConStock = data.productos.filter(p => p.stockTotal > 0.001);
  poblarSelect("sal_producto", productosConStock);
  
  poblarSelect("sal_ubicacion", data.ubicaciones);

  var fnSalida = (typeof calcularTotalSalida === 'function') ? calcularTotalSalida : function(){ console.warn("Fn Salida no cargada"); return 0; };
  setupPresentacion("sal_presentacion", data.presentaciones, fnSalida);

  // 3. Transformaciones: Muestra TODOS los productos 
  if (document.getElementById("selTransfNuevoProd"))
    poblarSelect("selTransfNuevoProd", data.productos);
  if (document.getElementById("selTransfNuevaPres"))
    setupPresentacion("selTransfNuevaPres", data.presentaciones, null);

  // Reactivar eventos
  const selProdSalida = document.getElementById("sal_producto");
  if (selProdSalida) {
    const nuevoSel = selProdSalida.cloneNode(true);
    selProdSalida.parentNode.replaceChild(nuevoSel, selProdSalida);
    if (typeof aplicarFIFO === 'function') {
        nuevoSel.addEventListener("change", aplicarFIFO);
    }
  }
}

function llenarSelectClientes() {
  const sel = document.getElementById("log_cliente_select");
  if (!sel) return;
  
  sel.innerHTML = '<option value="">-- Nuevo / Manual --</option>';
  
  if(typeof LISTA_CLIENTES !== 'undefined'){
      LISTA_CLIENTES.forEach((c) => {
        const opt = document.createElement("option");
        opt.value = c.id;
        
        let nombre = c.nombre || "Sin Nombre";
        let empresa = (c.empresa && c.empresa.trim() !== "") ? `[${c.empresa}]` : "";
        let dirCorta = c.direccion || "Sin dirección";
        
        if (dirCorta.length > 35) {
            dirCorta = dirCorta.substring(0, 35) + "...";
        }
        
        let textoFinal = nombre;
        if (empresa !== "") textoFinal += ` ${empresa}`;
        textoFinal += ` - ${dirCorta}`;
        
        opt.text = textoFinal;
        
        sel.appendChild(opt);
      });
  }
}

function poblarSelect(id, lista) {
  const select = document.getElementById(id);
  if (!select) return;
  select.innerHTML = '<option value="">Selecciona...</option>';
  if(lista){
      lista.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.text = item.nombre;
        select.appendChild(option);
      });
  }
}

function setupPresentacion(idSelect, lista, funcionCalculo) {
  const select = document.getElementById(idSelect);
  if (!select) return;
  const newSelect = select.cloneNode(false);
  select.parentNode.replaceChild(newSelect, select);
  newSelect.id = idSelect;
  newSelect.className = "input-modern";
  newSelect.innerHTML = '<option value="">Selecciona...</option>';
  
  if (typeof funcionCalculo === 'function') {
      newSelect.addEventListener("change", funcionCalculo);
  }
  
  if(lista){
      lista.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.text = item.nombre;
        option.setAttribute("data-volumen", item.volumen || 0);
        newSelect.appendChild(option);
      });
  }
}

function getTextoSelect(id) {
  const s = document.getElementById(id);
  return s && s.options.length > 0 && s.selectedIndex >= 0
    ? s.options[s.selectedIndex].text
    : "";
}

// --- 1. BUSCADOR INTELIGENTE ACTUALIZADO ---
function seleccionarProductoDesdeBusqueda() {
    let searchVal = document.getElementById('producto_search').value.trim();
    let hiddenId = document.getElementById('producto');
    
    // Si el usuario borra el texto, limpiamos la memoria y restauramos TODAS las presentaciones
    if(searchVal === "") {
        hiddenId.value = "";
        filtrarPresentacionesPorUnidad(""); // Restaura la lista completa
        if(typeof calcularTotalEntrada === 'function') calcularTotalEntrada();
        return;
    }

    if(!window.CACHE_CATALOGOS) return;
    
    let prod = window.CACHE_CATALOGOS.productos.find(p => p.nombre.toUpperCase() === searchVal.toUpperCase());
    
    if(prod) {
        hiddenId.value = prod.id; 
        document.getElementById('producto_search').value = prod.nombre; 
        
        // MAGIA: Filtramos la lista de presentaciones basándonos en la unidad del producto
        filtrarPresentacionesPorUnidad(prod.unidad);

        if(typeof calcularTotalEntrada === 'function') calcularTotalEntrada(); 
    } else {
        hiddenId.value = "";
        Swal.fire({
            title: 'Producto no encontrado',
            text: `El producto "${searchVal}" no existe. ¿Deseas registrarlo?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#007aff',
            confirmButtonText: 'Sí, crear nuevo'
        }).then((res) => {
            if(res.isConfirmed) {
                document.getElementById("nuevoNombre").value = searchVal.toUpperCase();
                abrirModalGenerico('modalProducto'); 
            }
        });
        filtrarPresentacionesPorUnidad(""); // Restaura lista
        if(typeof calcularTotalEntrada === 'function') calcularTotalEntrada();
    }
}

// --- 2. NUEVO: FILTRO DINÁMICO DE PRESENTACIONES ---
function filtrarPresentacionesPorUnidad(unidad) {
    const select = document.getElementById("presentacion");
    if (!select || !window.CACHE_CATALOGOS) return;

    // Limpiamos el menú desplegable
    select.innerHTML = '<option value="">Selecciona...</option>';
    let presCache = window.CACHE_CATALOGOS.presentaciones;

    // Si no hay unidad (ej. borraron el texto), mostramos todas
    if (!unidad || unidad === "") {
        presCache.forEach(p => {
            let opt = document.createElement("option");
            opt.value = p.id; opt.text = p.nombre; opt.setAttribute("data-volumen", p.volumen || 0);
            select.appendChild(opt);
        });
        return;
    }

    let uniStr = String(unidad).toLowerCase().trim();
    let compatibles = [];

    // Escaneamos cada presentación para ver si coincide con L, Kg o Piezas
    presCache.forEach(p => {
        let n = p.nombre.toLowerCase();
        let pasaFiltro = false;

        if (uniStr === 'kg' || uniStr === 'kilogramos') {
            if (n.includes('kg') || n.includes('kilo') || n.includes('gramo') || n.includes('saco')) pasaFiltro = true;
        } 
        else if (uniStr === 'l' || uniStr === 'litros') {
            // Busca 'l' sola, '1l', 'ml', 'litro', 'galon', 'tambo'
            if (/\bl\b/.test(n) || /[0-9]l\b/.test(n) || n.includes('ml') || n.includes('litro') || n.includes('galón') || n.includes('tambo')) pasaFiltro = true;
        } 
        else if (uniStr === 'unid' || uniStr === 'pza' || uniStr === 'unidad') {
            if (n.includes('pza') || n.includes('pieza') || n.includes('caja') || n.includes('unid')) pasaFiltro = true;
        } 
        else {
            pasaFiltro = true; // Si es una unidad extraña, mostramos todo para no bloquear
        }

        if (pasaFiltro) compatibles.push(p);
    });

    // SISTEMA ANTI-BLOQUEO: Si el filtro fue tan estricto que borró absolutamente todo, 
    // mejor mostramos la lista completa para permitirle al usuario trabajar.
    let listaMostrar = compatibles.length > 0 ? compatibles : presCache;

    // Inyectamos las opciones sobrevivientes
    listaMostrar.forEach(item => {
        let opt = document.createElement("option");
        opt.value = item.id;
        opt.text = item.nombre;
        opt.setAttribute("data-volumen", item.volumen || 0);
        select.appendChild(opt);
    });
}

// --- LOGICA DEL BUSCADOR DE SALIDAS ---
function seleccionarProductoSalidaDesdeBusqueda() {
    let searchVal = document.getElementById('sal_producto_search').value.trim();
    let hiddenId = document.getElementById('sal_producto');
    let divDisp = document.getElementById("div-disponibilidad");
    
    // Si borran el texto, escondemos la tabla de sugerencias
    if(searchVal === "") {
        hiddenId.value = "";
        if (typeof limpiarCamposSalidaParcial === 'function') limpiarCamposSalidaParcial();
        if (divDisp) { divDisp.innerHTML = ""; divDisp.style.display = "none"; }
        return;
    }

    if(!window.CACHE_CATALOGOS) return;
    
    // Buscamos validando que de verdad tenga stock
    let prod = window.CACHE_CATALOGOS.productos.find(p => p.nombre.toUpperCase() === searchVal.toUpperCase() && p.stockTotal > 0.001);
    
    if(prod) {
        hiddenId.value = prod.id; 
        document.getElementById('sal_producto_search').value = prod.nombre; 
        
        // ¡Si existe y tiene stock, mandamos a dibujar la tabla FIFO!
        if(typeof aplicarFIFO === 'function') aplicarFIFO(); 
    } else {
        // Si escribe algo raro o sin stock, bloqueamos
        hiddenId.value = "";
        Swal.fire("Atención", "Este producto no existe o actualmente no tiene stock en el almacén.", "warning");
        document.getElementById('sal_producto_search').value = "";
        
        if (typeof limpiarCamposSalidaParcial === 'function') limpiarCamposSalidaParcial();
        if (divDisp) { divDisp.innerHTML = ""; divDisp.style.display = "none"; }
    }
}