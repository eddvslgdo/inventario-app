function verDetallePedido(idPedido) {
  // 1. PROTECCI√ìN: Si el ID no es v√°lido, detenemos todo para no causar errores
  if (!idPedido || idPedido === "undefined" || idPedido === "null") {
    return Swal.fire("Error", "Este pedido tiene datos corruptos (ID inv√°lido).", "error");
  }

  PEDIDO_ACTUAL_ID = idPedido;
  document.getElementById("tituloDetallePedido").innerText = "Cargando...";
  abrirModalGenerico("modalDetallePedido");

  // Limpiamos los campos antes de cargar para que no se vean datos viejos
  document.getElementById("det_fecha_est").value = "";
  document.getElementById("det_fecha_real").value = "";
  document.getElementById("tablaItemsPedido").innerHTML = "";

  google.script.run
    .withSuccessHandler((data) => {
      // 2. PROTECCI√ìN: Si no hay cabecera, salimos
      if (!data || !data.cabecera) {
          document.getElementById("tituloDetallePedido").innerText = "Error de datos";
          return;
      }

      const cab = data.cabecera;
      document.getElementById("tituloDetallePedido").innerText = "Pedido: " + (cab.id || "---");
      document.getElementById("det_cliente").innerText = cab.cliente || "Sin cliente";
      document.getElementById("det_direccion").innerText = cab.direccion || "";
      document.getElementById("det_guia").innerText = 
        `${cab.paqueteria || ""} - ${cab.guia || ""}`;

      // 3. SOLUCI√ìN DEL ERROR DE FECHA:
      // Usamos || "" para asegurar que si es undefined, se ponga cadena vac√≠a
      document.getElementById("det_fecha_est").value = cab.fechaEst || "";
      document.getElementById("det_fecha_real").value = cab.fechaReal || "";
      
      document.getElementById("det_estatus").value = cab.estatus || "Pendiente";

      // Tabla Items
      const tbody = document.getElementById("tablaItemsPedido");
      tbody.innerHTML = "";
      
      if (data.items && data.items.length > 0) {
          data.items.forEach((item) => {
            tbody.innerHTML += `
                <tr style="border-bottom:1px solid #eee;">
                  <td style="padding:8px;">${item.producto}<br><small style="color:#888">${item.presentacion}</small></td>
                  <td style="padding:8px; font-family:monospace; color:#d63031;">${item.lote}</td>
                  <td style="padding:8px; text-align:right;"><strong>${item.volumen} L</strong><br><small>(${item.cantidad} pzs)</small></td>
                </tr>`;
          });
      } else {
          tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:10px;'>Sin items</td></tr>";
      }
    })
    .obtenerDetallePedidoCompleto(idPedido);
}

function guardarActualizacionPedido() {
  if (!PEDIDO_ACTUAL_ID) return;

  const fEst = document.getElementById("det_fecha_est").value;
  const fReal = document.getElementById("det_fecha_real").value;
  const st = document.getElementById("det_estatus").value;

  const btn = event.target;
  const txtOriginal = btn.innerText;
  btn.disabled = true;
  btn.innerText = "Guardando...";

  google.script.run
    .withSuccessHandler(() => {
      mostrarToast("Pedido actualizado ‚úÖ", "success");
      cerrarModalGenerico("modalDetallePedido");
      cargarDashboardPedidos(); // Refrescar lista
      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    .actualizarPedido(PEDIDO_ACTUAL_ID, fEst, fReal, st);
}

function cargarDashboardPedidos() {
  const tbody = document.getElementById("tablaPedidosBody");
  tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Cargando...</td></tr>';

  google.script.run
    .withSuccessHandler((lista) => {
      tbody.innerHTML = "";
      if (!lista || lista.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Sin env√≠os registrados.</td></tr>';
        return;
      }

      lista.forEach((p) => {
        // 4. FILTRO DE SEGURIDAD:
        // Si el pedido no tiene ID (fila vac√≠a), no lo dibujamos
        if (!p.id) return;

        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid #eee";

        let statusColor = "#95a5a6"; // Gris por defecto
        if (p.estatus === "Pendiente") statusColor = "#f1c40f"; // Amarillo
        if (p.estatus === "En Camino") statusColor = "#3498db"; // Azul
        if (p.estatus === "Entregado") statusColor = "#2ecc71"; // Verde
        if (p.estatus === "Cancelado") statusColor = "#e74c3c"; // Rojo

        tr.innerHTML = `
           <td style="padding:12px;">
             <div style="font-weight:bold; color:#007aff; font-size:0.9rem;">${p.id}</div>
             <div style="font-size:0.75rem; color:#888;">${p.fecha}</div>
           </td>
           <td style="padding:12px;">
             <div style="font-weight:500;">${p.cliente || "---"}</div>
             <div style="font-size:0.75rem; color:#888;">${p.destino ? p.destino.substring(0, 20) + "..." : "-"}</div>
           </td>
           <td style="padding:12px; text-align:center;">
             <span style="background:${statusColor}; color:white; padding:4px 8px; border-radius:12px; font-size:0.75rem; font-weight:bold;">${p.estatus}</span>
           </td>
           <td style="padding:12px; text-align:right;">
             <button onclick="verDetallePedido('${p.id}')" class="btn-field" style="width:auto; padding:0 12px; height:32px; font-size:0.8rem; background:#f1f3f5; color:#333; border:none;">üëÅÔ∏è Ver</button>
           </td>
         `;
        tbody.appendChild(tr);
      });
    })
    .obtenerHistorialPedidos();
}

function confirmarPedidoCompleto() {
  const nombre = document.getElementById("log_nombre").value.trim();
  if (!nombre) return mostrarToast("Falta nombre", "error");

  const btn = event.target;
  const txtOriginal = btn.innerText; // Guardamos el texto original
  btn.disabled = true;
  btn.innerText = "Procesando...";

  const datosLogistica = {
    idCliente: document.getElementById("log_cliente_select").value || "nuevo",
    nombreCliente: nombre,
    empresa: document.getElementById("log_empresa").value,
    direccion: document.getElementById("log_direccion").value,
    telefono: document.getElementById("log_telefono").value,
    email: document.getElementById("log_email").value,
    tipoEnvio: document.getElementById("log_tipo_envio").value,
    paqueteria: document.getElementById("log_paqueteria").value,
    guia: document.getElementById("log_guia").value,
    costoEnvio: document.getElementById("log_costo").value || 0,
  };
  const guardarCli = document.getElementById("log_guardar_cliente").checked;

  google.script.run
    .withSuccessHandler((res) => {
      // Manejo seguro de la respuesta por si viene como string
      let respObj = res;
      if (typeof res === 'string') { try { respObj = JSON.parse(res); } catch(e){} }

      if (respObj && respObj.success) {
          mostrarToast(`Pedido Generado: ${respObj.idPedido} üöÄ`, "success");
          
          // Limpieza
          if(typeof COLA_SALIDAS !== 'undefined') COLA_SALIDAS = [];
          if(typeof renderizarColaSalida === 'function') renderizarColaSalida();
          if(typeof limpiarFormularioSalidaTotal === 'function') limpiarFormularioSalidaTotal();
          
          cerrarModalGenerico("modalLogistica");
          
          if(typeof recargarSelectores === 'function') recargarSelectores(); 
      } else {
          mostrarToast("Error: " + (respObj.error || "Desconocido"), "error");
      }

      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    .withFailureHandler((err) => {
      mostrarError(err);
      btn.disabled = false;
      btn.innerText = txtOriginal;
    })
    .procesarPedidoCompleto(datosLogistica, (typeof COLA_SALIDAS !== 'undefined' ? COLA_SALIDAS : []), guardarCli);
}