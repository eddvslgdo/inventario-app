// --- GESTION DE ENVIOS (V8: INTEGRADO Y SEGURO) ---

var PEDIDO_ESTATUS_ACTUAL = "";
// --- GESTION DE ENVIOS (V14: DISE√ëO PREMIUM) ---
var LISTA_PEDIDOS_CACHE = []; 
var TAB_ACTIVA = 'activos'; 

// CSS MEJORADO
var ESTILOS = `
<style>
  /* Layout */
  .main-layout {
    background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
    height: 85vh; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }
  
  /* Header */
  .header { padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 12px 12px 0 0; }
  .title { font-size: 1.25rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 8px; }
  
  /* Tabs */
  .tabs { background: #f1f5f9; padding: 4px; border-radius: 8px; display:flex; gap:4px; }
  .tab { padding: 6px 16px; border:none; background:transparent; font-weight:600; color:#64748b; cursor:pointer; border-radius:6px; transition: all 0.2s; }
  .tab.active { background:white; color:#2563eb; box-shadow:0 1px 3px rgba(0,0,0,0.1); }

  /* Toolbar */
  .toolbar { padding: 12px 24px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display:flex; gap:12px; align-items:center; }
  
  .search-box {
    flex: 1; position: relative; max-width: 450px;
  }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }
  
  /* INPUT CON BORDE FUERTE */
  .input-field {
    width: 100%; padding: 10px 12px 10px 36px;
    border: 1px solid #cbd5e1 !important;
    border-radius: 8px; background: white;
    font-size: 0.95rem; outline: none; transition: border-color 0.2s;
  }
  .input-field:focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

  /* Tabla */
  .table-container { flex: 1; overflow-y: auto; background: white; }
  .table { width: 100%; border-collapse: collapse; }
  .table th { position:sticky; top:0; background:#f8fafc; padding:12px 24px; text-align:left; font-size:0.75rem; font-weight:700; color:#64748b; text-transform:uppercase; border-bottom:1px solid #e2e8f0; z-index:10; }
  .table td { padding:16px 24px; border-bottom:1px solid #f1f5f9; vertical-align:middle; color:#334155; font-size:0.9rem; }
  .table tr:hover { background-color: #f8fafc; }

  /* Estilos Texto */
  .txt-id { color: #2563eb; font-family: monospace; font-weight: 700; background: #eff6ff; padding: 2px 6px; border-radius: 4px; font-size: 0.85rem; }
  .txt-main { font-weight: 600; color: #0f172a; display:block; }
  .txt-sub { font-size: 0.85rem; color: #64748b; display:block; margin-top:2px; }
  
  /* Badges */
  .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform:uppercase; display:inline-block; }
  .bg-pend { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
  .bg-blue { background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe; }
  .bg-green { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

  .btn-action { background: white; border: 1px solid #cbd5e1; color: #334155; padding: 6px 14px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; }
  .btn-action:hover { border-color: #3b82f6; color: #2563eb; background: #eff6ff; }

  /* MODAL */
  .modal-head-new { padding: 20px 24px; background: #1e293b; color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #3b82f6; }
  .card-info { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .card-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
  .row-data { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; font-size: 0.9rem; color: #334155; }
  .icon-small { color: #94a3b8; width: 16px; text-align: center; }
</style>
`;

function cargarDashboardPedidos() {
  var c = document.getElementById("vista-pedidos");
  if (!c) return;

  c.innerHTML = ESTILOS + `
    <div class="main-layout">
       <div class="header">
          <div class="title">üì¶ Gesti√≥n de Env√≠os</div>
          <div class="tabs">
             <button class="tab active" onclick="chTab('activos', this)">En Curso</button>
             <button class="tab" onclick="chTab('historial', this)">Historial</button>
          </div>
       </div>
       <div class="toolbar">
          <div class="search-box">
             <span class="search-icon">üîç</span>
             <input type="text" id="filtro_t" class="input-field" placeholder="Buscar cliente, ID, producto..." onkeyup="apFiltro()">
          </div>
          <button onclick="limpiar()" style="color:#ef4444; border:none; background:none; cursor:pointer; font-weight:600;">Limpiar</button>
       </div>
       <div class="table-container">
          <table class="table">
             <thead>
                <tr>
                   <th style="width:15%">ID / Fecha</th>
                   <th style="width:25%">Cliente</th>
                   <th style="width:30%">Resumen Productos</th>
                   <th style="width:15%; text-align:center;">Estatus</th>
                   <th style="width:15%; text-align:right;">Acci√≥n</th>
                </tr>
             </thead>
             <tbody id="tbl-body">
                <tr><td colspan="5" style="text-align:center; padding:50px; color:#94a3b8;">Cargando...</td></tr>
             </tbody>
          </table>
       </div>
    </div>
  `;

  google.script.run.withSuccessHandler(res => { LISTA_PEDIDOS_CACHE = res; apFiltro(); }).obtenerHistorialPedidos();
}

function chTab(modo, btn) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  TAB_ACTIVA = modo;
  apFiltro();
}

function apFiltro() {
  var txt = document.getElementById("filtro_t").value.toLowerCase();
  var tbody = document.getElementById("tbl-body");
  tbody.innerHTML = "";

  if (!LISTA_PEDIDOS_CACHE.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px;">Sin datos</td></tr>'; return; }

  var filtrados = LISTA_PEDIDOS_CACHE.filter(p => {
      var st = p.estatus.toLowerCase();
      var esActivo = (st === "pendiente" || st === "en camino");
      if (TAB_ACTIVA === 'activos' && !esActivo) return false;
      if (TAB_ACTIVA === 'historial' && esActivo) return false;
      
      var todo = (p.id + " " + p.cliente + " " + p.empresa + " " + p.resumenProductos).toLowerCase();
      return !txt || todo.includes(txt);
  });

  if (filtrados.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px;">Sin resultados</td></tr>'; return; }

  filtrados.forEach(p => {
      var badge = "bg-pend";
      if (p.estatus.toLowerCase() === "en camino") badge = "bg-blue";
      if (p.estatus.toLowerCase() === "entregado") badge = "bg-green";

      var tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="txt-id">${p.id}</span><span class="txt-sub">${p.fecha}</span></td>
        <td><span class="txt-main">${p.cliente}</span><span class="txt-sub">${p.empresa||""}</span></td>
        <td><span style="color:#334155;">${p.resumenProductos}</span><div class="txt-sub">${p.paqueteria||""}</div></td>
        <td style="text-align:center;"><span class="badge ${badge}">${p.estatus}</span></td>
        <td style="text-align:right;"><button class="btn-action" onclick="ver('${p.id}')">Gestionar</button></td>
      `;
      tbody.appendChild(tr);
  });
}

function limpiar() { document.getElementById("filtro_t").value = ""; apFiltro(); }

function ver(id) {
  PEDIDO_ACTUAL_ID = id;
  abrirModalGenerico("modalDetallePedido");
  var c = document.getElementById("contenido-modal-pedido");
  c.innerHTML = '<div style="padding:50px; text-align:center;">Cargando...</div>';
  google.script.run.withSuccessHandler(renderModal).obtenerDetallePedidoCompleto(id);
}

function renderModal(data) {
  var c = document.getElementById("contenido-modal-pedido");
  var cab = data.cabecera;
  var items = data.items.map(i => 
    `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #e2e8f0;">
       <div><b>${i.producto}</b> <span style="color:#64748b; font-size:0.85rem;">(${i.presentacion})</span></div>
       <div><b>${i.volumen} L</b></div>
     </div>`
  ).join("");

  var esFin = cab.estatus === "Entregado";
  var lock = esFin ? "disabled style='background:#f1f5f9; color:#94a3b8;'" : "";

  c.innerHTML = ESTILOS + `
    <div class="modal-head-new">
       <div><small style="opacity:0.7; font-weight:700;">PEDIDO</small><div style="font-size:1.4rem; font-weight:800;">${cab.id}</div></div>
       <div style="text-align:right;"><small style="opacity:0.7; font-weight:700;">COSTO</small><div style="font-size:1.4rem; font-weight:800; color:#4ade80;">$${Number(cab.costoEnvio).toFixed(2)}</div></div>
    </div>
    
    <div style="padding:24px; background:#f8fafc; max-height:75vh; overflow-y:auto;">
       
       <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="card-info">
             <div class="card-label">üë§ CLIENTE</div>
             <div class="txt-main" style="font-size:1.1rem; margin-bottom:4px;">${cab.cliente}</div>
             <div class="row-data"><span class="icon-small">üìû</span> ${cab.telefono||"--"}</div>
             <div class="row-data"><span class="icon-small">‚úâÔ∏è</span> ${cab.email||"--"}</div>
          </div>
          <div class="card-info">
             <div class="card-label">üöö LOG√çSTICA</div>
             <div class="txt-main" style="font-size:1.1rem; margin-bottom:4px;">${cab.paqueteria}</div>
             <span style="background:#eff6ff; color:#1d4ed8; padding:2px 6px; border-radius:4px; font-family:monospace; font-weight:600; font-size:0.85rem;">${cab.guia||"S/G"}</span>
             <div class="row-data" style="margin-top:8px;"><span class="icon-small">üìç</span> ${cab.direccion}</div>
          </div>
       </div>

       <div class="card-info">
          <div class="card-label">üì¶ CONTENIDO</div>
          ${items || "<div style='color:#94a3b8; font-style:italic;'>Datos de productos no disponibles para este pedido antiguo.</div>"}
       </div>

       <div style="background:${esFin?'#f0fdf4':'#eff6ff'}; border:1px solid ${esFin?'#bbf7d0':'#bfdbfe'}; border-radius:8px; padding:20px;">
          <div class="card-label" style="color:#0f172a;">üìÖ SEGUIMIENTO</div>
          
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
             <div>
                <label style="font-size:0.75rem; font-weight:700; color:#64748b;">F. ESTIMADA</label>
                <input type="date" id="fe" value="${cab.fechaEst}" ${lock} class="input-field" style="margin-top:4px;">
             </div>
             <div>
                <label style="font-size:0.75rem; font-weight:700; color:#64748b;">F. REAL</label>
                <input type="date" id="fr" value="${cab.fechaReal}" ${lock} class="input-field" style="margin-top:4px;">
             </div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center;">
             <div style="font-weight:700; color:#334155;">${cab.estatus}</div>
             ${!esFin ? 
               `<button onclick="guardar()" style="background:#2563eb; color:white; padding:10px 24px; border:none; border-radius:6px; font-weight:600; cursor:pointer; box-shadow:0 4px 6px -1px rgba(37,99,235,0.2);">GUARDAR CAMBIOS</button>` : 
               `<div style="color:#15803d; font-weight:700; display:flex; align-items:center; gap:6px;"><span>‚úÖ</span> FINALIZADO</div>`}
          </div>
       </div>
    </div>
  `;
}

function guardar() {
   var fe = document.getElementById("fe").value;
   var fr = document.getElementById("fr").value;
   var st = fe ? "En Camino" : "Pendiente";
   if (fr) st = "Entregado";

   var btn = document.querySelector("button[onclick='guardar()']");
   if(btn) { btn.innerText = "..."; btn.disabled = true; }

   google.script.run.withSuccessHandler(() => {
        mostrarToast("Actualizado", "success");
        cerrarModalGenerico("modalDetallePedido");
        cargarDashboardPedidos();
   }).actualizarPedido(PEDIDO_ACTUAL_ID, fe, fr, st);
}