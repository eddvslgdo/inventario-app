<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <?!= include('frontend/css'); ?>
  
  <style>
    /* --- ESTILOS GENERALES Y TOAST --- */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f2f2f7; margin: 0; padding: 10px; }
    
    #toast-container {
      visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center; border-radius: 12px; padding: 16px 24px; position: fixed; z-index: 9999; right: 20px; top: 20px; font-size: 15px; font-weight: 500; box-shadow: 0px 5px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); transition: all 0.4s ease-in-out;
    }
    #toast-container.show { visibility: visible; opacity: 1; transform: translateY(0); }
    #toast-container.success { background-color: #2ecc71; border-left: 6px solid #27ae60; }
    #toast-container.error { background-color: #e74c3c; border-left: 6px solid #c0392b; }
    #toast-container.info { background-color: #3498db; border-left: 6px solid #2980b9; }

    /* ESTILOS DE FORMULARIO HOMOGÃ‰NEOS (NUEVO) */
    .input-modern { 
      width: 100%; 
      height: 45px; /* Altura FIJA para todos */
      padding: 0 12px; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      font-size: 1rem; 
      box-sizing: border-box; 
      background-color: white;
      appearance: none; /* Limpieza nativa */
      margin-bottom: 0; /* Controlamos margen con el contenedor */
    }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9rem; }
    
    /* Botones de formulario (Guardar, Cancelar, Acciones) */
    .btn-field { 
      height: 45px; 
      cursor: pointer; 
      border-radius: 8px; 
      font-weight: bold; 
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 15px;
    }

    /* ESTILOS BOTONES TABLA (PequeÃ±os) */
    .btn-action {
      border: none; border-radius: 6px; cursor: pointer; padding: 6px 8px;
      font-size: 1.1rem; transition: transform 0.1s, box-shadow 0.2s;
      display: inline-flex; align-items: center; justify-content: center;
      width: 36px; height: 36px;
    }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-move { background: #e3f2fd; color: #007aff; }
    .btn-transf { background: #f3e5f5; color: #9b59b6; }

    /* LAYOUT GENERAL */
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin: 0 auto; max-width: 600px; }
    .vista { display: none; padding-bottom: 80px; }
    
    /* NAV BAR */
    .nav-bar { 
      display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; 
      background: white; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .nav-btn {
      padding: 10px 20px; border: none; background: transparent; cursor: pointer;
      font-weight: 600; color: #666; border-radius: 8px; transition: all 0.2s;
    }
    .nav-btn.active { background-color: #007aff; color: white; }

    /* =========================================
       ESTILOS MOBILE (iPHONE / ANDROID)
       ========================================= */
    @media only screen and (max-width: 768px) {
      body { padding: 10px; }
      .card { padding: 15px; border-radius: 16px; width: 100%; box-sizing: border-box; }
      
      /* MODALES */
      .modal-content { width: 90% !important; max-width: 400px !important; margin: 5vh auto !important; border-radius: 16px; }
      .input-modern, select, input { font-size: 16px !important; } /* Evita zoom iOS */

      /* NAV */
      .nav-bar { justify-content: flex-start; overflow-x: auto; padding-bottom: 5px; gap: 5px; }
      .nav-btn { flex: 0 0 auto; font-size: 0.9rem; padding: 8px 15px; }

      /* VISTA PRODUCTOS (TARJETAS VERTICALES) */
      #vista-productos thead { display: none; }
      #vista-productos table, #vista-productos tbody, #vista-productos td { display: block !important; width: 100% !important; box-sizing: border-box; }

      /* Tarjetas Principales */
      #tablaProductosBody > tr:not([id^="detalle-"]) {
        display: flex !important; flex-direction: column;
        background: white; margin-bottom: 15px; border: 1px solid #e5e5ea;
        border-radius: 12px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      }
      #tablaProductosBody > tr:not([id^="detalle-"]) > td { padding: 0 !important; margin-bottom: 8px; text-align: left !important; border: none !important; }
      #tablaProductosBody > tr > td:nth-child(1) strong { font-size: 1.3rem; color: #007aff; display: block; margin-bottom: 4px; }
      #tablaProductosBody > tr > td:nth-child(2) { background: #f2f2f7; padding: 12px !important; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
      #tablaProductosBody > tr > td:nth-child(2)::before { content: "STOCK TOTAL:"; font-size: 0.8rem; font-weight: 700; color: #8e8e93; }
      #tablaProductosBody > tr > td button { width: 100%; padding: 12px; background-color: white !important; color: #007aff !important; border: 1px solid #007aff !important; font-weight: 600; border-radius: 8px; }

      /* Detalle Desplegable */
      #tablaProductosBody tr[id^="detalle-"] { margin-top: -10px; margin-bottom: 20px; background: transparent; border: none; padding: 0; }
      #tablaProductosBody tr[id^="detalle-"][style*="display: table-row"],
      #tablaProductosBody tr[id^="detalle-"][style*="display:table-row"] { display: block !important; }
      #tablaProductosBody tr[id^="detalle-"] > td { padding: 0 !important; }

      /* Tarjetas Internas (Lotes) */
      #tablaProductosBody tr[id^="detalle-"] table thead { display: none; }
      #tablaProductosBody tr[id^="detalle-"] table tbody tr {
        display: grid; grid-template-columns: 1fr 1fr; gap: 5px 10px;
        background: #fff; border-left: 4px solid #5856d6; margin-bottom: 8px;
        padding: 12px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      #tablaProductosBody tr[id^="detalle-"] table td { display: block; width: auto !important; padding: 0 !important; font-size: 0.9rem; color: #333; border: none !important; }
      #tablaProductosBody tr[id^="detalle-"] table td:nth-child(1) { grid-column: 1 / -1; font-weight: bold; font-size: 1rem; border-bottom: 1px solid #eee !important; padding-bottom: 8px !important; margin-bottom: 8px; }
      #tablaProductosBody tr[id^="detalle-"] table td:nth-child(1)::before { content: "ğŸ“ "; }
      #tablaProductosBody tr[id^="detalle-"] table td:nth-child(3) { text-align: right !important; font-family: monospace; color: #d63031; }
      #tablaProductosBody tr[id^="detalle-"] table td:nth-child(4)::before { content: "Cad: "; color:#888; }
      #tablaProductosBody tr[id^="detalle-"] table td:nth-child(5) { text-align: right !important; font-weight: bold; color: #007aff !important; font-size: 1.1rem; }
    }
  </style>
</head>

<body>

  <div class="nav-bar">
    <button class="nav-btn active" onclick="cambiarVista('vista-operacion')">ğŸ“¦ Entradas</button>
    <button class="nav-btn" onclick="cambiarVista('vista-salidas')">ğŸšš Salidas</button>
    <button class="nav-btn" onclick="cambiarVista('vista-ubicaciones')">ğŸ“ Ubicaciones</button>
    <button class="nav-btn" onclick="cambiarVista('vista-productos')">ğŸ“Š Productos</button>
    <button class="nav-btn" onclick="cambiarVista('vista-pedidos')">ğŸ“¦ EnvÃ­os</button>
  </div>

  <div id="vista-operacion" class="vista">
    <div class="card">
      <div style="background:#e3f2fd; padding:10px; border-radius:8px; margin-bottom:15px; border-left:5px solid #007aff;">
        <h2 style="margin:0; color:#007aff;">Registro de Entradas</h2>
        <small style="color:#555;">RecepciÃ³n de mercancÃ­a a almacÃ©n</small>
      </div>

      <div class="form-group">
        <label>Producto</label>
        <div style="display: flex; gap: 10px;">
          <select id="producto" class="input-modern"><option>Cargando...</option></select>
          <button type="button" onclick="abrirModal()" class="btn-field" style="width:50px; background:#007aff; color:white; border:none; font-size:1.5rem;">+</button>
        </div>
      </div>

      <div class="form-group">
        <label>PresentaciÃ³n</label>
        <div style="display: flex; gap: 10px;">
          <select id="presentacion" class="input-modern"><option>Cargando...</option></select>
          <button type="button" onclick="abrirModalGenerico('modalPresentacion')" class="btn-field" style="width:50px; background:#5856d6; color:white; border:none; font-size:1.5rem;">+</button>
        </div>
      </div>

      <div class="form-group">
        <label>Cantidad (Piezas)</label>
        <div style="display: flex; gap: 10px;">
          <input type="number" id="cantidad" min="1" step="1" placeholder="Ej: 5" class="input-modern" oninput="calcularTotalEntrada()">
          <div id="infoTotal" style="background:#eef1f6; border:1px solid #ddd; border-radius:8px; min-width:80px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#555; height:45px;">0 L</div>
        </div>
      </div>

      <div class="form-group">
        <label>Lote *</label>
        <input type="text" id="lote" class="input-modern">
      </div>

      <div class="form-group">
        <label>Proveedor</label>
        <input type="text" id="proveedor" class="input-modern">
      </div>

      <div class="form-group">
        <label>Fecha FabricaciÃ³n</label>
        <input type="date" id="elaboracion" class="input-modern">
      </div>

      <div class="form-group">
        <label>UbicaciÃ³n Destino</label>
        <div style="display: flex; gap: 10px;">
          <select id="ubicacion" class="input-modern"><option>Cargando...</option></select>
          <button type="button" onclick="abrirModalGenerico('modalUbicacion')" class="btn-field" style="width:50px; background:#ff9500; color:white; border:none; font-size:1.5rem;">+</button>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button onclick="guardarEntradaDirecta()" class="btn-field" style="flex: 1; background: #007aff; color: white; border: none;">
          âš¡ Entrada Directa
        </button>
        <button onclick="agregarColaEntrada()" class="btn-field" style="flex: 1; background: #fff; color: #007aff; border: 2px solid #007aff;">
          â¬‡ï¸ Agregar a Lista
        </button>
      </div>

      <div id="area-cola-entradas" style="margin-top: 20px; display: none; border-top: 2px dashed #ddd; padding-top:15px;">
        <h4 style="margin-bottom: 10px; color: #333;">ğŸ“¦ Lista de Ingreso (<span id="contadorColaEnt">0</span>)</h4>
        <div style="overflow-x:auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <tbody id="tablaColaEntradaBody"></tbody>
          </table>
        </div>
        <button onclick="procesarEntradas()" class="btn-field" style="width: 100%; background: #2ecc71; color: white; border: none; margin-top: 15px;">
          ğŸ’¾ GUARDAR TODO
        </button>
      </div>
    </div>
  </div>

<div id="vista-salidas" class="vista" style="display: none;">
    <div class="card">
      <div style="background:#ffebee; padding:15px; border-radius:8px; margin-bottom:20px; border-left:5px solid #d63031; display:flex; justify-content:space-between; align-items:center;">
        <div><h2 style="margin:0; color:#d63031;">Salidas</h2><small style="color:#555;">Selecciona un lote de la lista ğŸ‘‡</small></div>
        <div style="font-size:2rem;">ğŸšš</div>
      </div>

      <div class="form-group">
        <label>Producto a Enviar</label>
        <select id="sal_producto" class="input-modern"><option>Selecciona...</option></select>
      </div>

      <div id="div-disponibilidad" style="display:none; margin-bottom: 20px;"></div> 

      <div style="display:flex; gap:15px;">
        <div class="form-group" style="flex:1;">
          <label>PresentaciÃ³n</label>
          <select id="sal_presentacion" class="input-modern"></select>
        </div>
        <div class="form-group" style="flex:1;">
          <label>UbicaciÃ³n</label>
          <select id="sal_ubicacion" class="input-modern"></select>
        </div>
      </div>

      <div class="form-group">
        <label>Lote Seleccionado</label>
        <input type="text" id="sal_lote" class="input-modern" style="font-family:monospace; color:#d63031; font-weight:bold; background:#fff5f5;">
      </div>

      <div class="form-group">
        <label>Cantidad (Piezas)</label>
        <div style="display: flex; gap: 10px;">
          <input type="number" id="sal_cantidad" class="input-modern" placeholder="0" oninput="calcularTotalSalida()">
          <div id="sal_infoTotal" style="background:#f5f5f5; border:1px solid #ddd; border-radius:8px; min-width:90px; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#d63031; height:45px;">0 L</div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button onclick="guardarSalidaDirecta()" class="btn-field" style="flex: 1; background: #d63031; color: white; border: none; box-shadow: 0 4px 6px rgba(214, 48, 49, 0.2);">âš¡ Salida RÃ¡pida</button>
        <button onclick="agregarColaSalida()" class="btn-field" style="flex: 1; background: white; color: #d63031; border: 2px solid #d63031;">â• Agregar a Pedido</button>
      </div>

      <div id="area-cola-salidas" style="margin-top: 25px; display: none; background:#fff5f5; padding:15px; border-radius:12px; border:1px solid #ffcccc;">
        <h4 style="margin:0 0 10px 0; color: #c0392b;">ğŸ“‹ Pedido Actual (<span id="contadorColaSal">0</span>)</h4>
        <div style="overflow-x:auto; margin-bottom:15px;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;"><tbody id="tablaColaSalidaBody"></tbody></table>
        </div>
        <button onclick="procesarSalidas()" class="btn-field" style="width: 100%; background: #333; color: white; border: none;">ğŸš€ FINALIZAR PEDIDO</button>
      </div>
    </div>
  </div>

  <div id="vista-ubicaciones" class="vista" style="display: none;">
    <div class="card" style="max-width: 800px;"> 
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0">Mapa de AlmacÃ©n</h2>
        <button onclick="abrirModalGenerico('modalUbicacion')" class="btn-field" style="width: auto; padding: 0 20px; margin: 0; background: #ff9500; color:white; border:none;">+ Nueva UbicaciÃ³n</button>
      </div>
      <div id="loading-ubicaciones" style="text-align: center; margin: 20px; color: #666;">Cargando inventario...</div>
      <div id="grid-ubicaciones" class="grid-layout"></div>
    </div>
  </div>

  <div id="vista-productos" class="vista" style="display: none;">
    <div class="card" style="max-width: 900px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2 style="margin: 0;">Inventario Global</h2>
        <input type="text" id="buscadorProductos" placeholder="ğŸ” Buscar producto..." class="input-modern" style="max-width: 300px; margin: 0;" onkeyup="filtrarProductos()">
      </div>
      <div id="loading-productos" style="text-align: center; margin: 20px; color: #666;">Calculando totales...</div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #333; color: white; text-align: left;">
              <th style="padding: 12px; border-radius: 8px 0 0 0;">Producto</th>
              <th style="padding: 12px; text-align: right;">Total Stock (L)</th>
              <th style="padding: 12px; border-radius: 0 8px 0 0; text-align: center;">Detalle</th>
            </tr>
          </thead>
          <tbody id="tablaProductosBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="vista-pedidos" class="vista" style="display: none;">
    <div class="card" style="max-width: 900px;">
      <h2 style="margin-bottom:20px;">Historial de EnvÃ­os</h2>
      <div id="loading-pedidos" style="text-align:center; color:#666;">Cargando...</div>
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
          <thead>
            <tr style="background:#f1f3f5; text-align:left; color:#555;">
              <th style="padding:10px;">ID / Fecha</th>
              <th style="padding:10px;">Cliente</th>
              <th style="padding:10px;">LogÃ­stica</th>
              <th style="padding:10px;">Estatus</th>
            </tr>
          </thead>
          <tbody id="tablaPedidosBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="modalProducto" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Nuevo Producto</h3>
      <div class="form-group"><label>Nombre *</label> <input type="text" id="nuevoNombre" class="input-modern"></div>
      <div class="form-group"><label>DescripciÃ³n</label> <input type="text" id="nuevaDescripcion" class="input-modern"></div>
      <div class="form-group"><label>Unidad *</label>
      <select id="nuevaUnidad" class="input-modern">
        <option value="L">Litros (L)</option><option value="Kg">Kilogramos (Kg)</option><option value="Unid">Unidad (Pza)</option>
      </select></div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="cerrarModal()" class="btn-field" style="flex:1; background:#e5e5ea; border:none; color:#333;">Cancelar</button>
        <button onclick="guardarProducto()" class="btn-field" style="flex:1; background:#007aff; color:white; border:none;">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalPresentacion" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Nueva PresentaciÃ³n</h3>
      <div class="form-group"><label>DescripciÃ³n</label> <input type="text" id="nuevaPresDesc" class="input-modern" placeholder="Ej: Saco 25kg"></div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="cerrarModalGenerico('modalPresentacion')" class="btn-field" style="flex:1; background:#e5e5ea; border:none; color:#333;">Cancelar</button>
        <button onclick="guardarPresentacion()" class="btn-field" style="flex:1; background:#5856d6; color:white; border:none;">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalUbicacion" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Nueva UbicaciÃ³n</h3>
      <div class="form-group"><label>Nombre</label> <input type="text" id="nuevaUbicNombre" class="input-modern" placeholder="Ej: Estante B"></div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="cerrarModalGenerico('modalUbicacion')" class="btn-field" style="flex:1; background:#e5e5ea; border:none; color:#333;">Cancelar</button>
        <button onclick="guardarUbicacion()" class="btn-field" style="flex:1; background:#ff9500; color:white; border:none;">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalEditarUbicacion" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px; padding-top: 0; overflow: hidden;">
      <div style="background: #007aff; padding: 15px; margin: 0 -20px 20px -20px; text-align: center;">
        <h3 style="margin:0; color: white;">Editar Nombre</h3>
      </div>
      <div class="form-group"><label>Nuevo Nombre:</label> <input type="text" id="inputEditarNombre" class="input-modern"></div>
      <div style="display: flex; gap: 10px;">
        <button onclick="cerrarModalGenerico('modalEditarUbicacion')" class="btn-field" style="flex: 1; background:#e5e5ea; border:none;">Cancelar</button>
        <button onclick="guardarEdicionUbicacion()" class="btn-field" style="flex: 1; background:#007aff; color:white; border:none;">Guardar</button>
      </div>
    </div>
  </div>

  <div id="modalDetalleUbicacion" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px; width: 95%; padding-top: 0; overflow: hidden;"> 
      <div style="background: #f9f9f9; padding: 20px 20px 10px 20px; border-bottom: 1px solid #eee; margin: 0 -20px 15px -20px;">
        <h3 id="tituloDetalle" style="margin:0; color:#333;">Detalle UbicaciÃ³n</h3>
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
          <thead>
            <tr style="background: #fff; text-align: left; border-bottom: 2px solid #007aff;">
              <th style="padding: 10px; color:#007aff;">Producto</th>
              <th style="padding: 10px; color:#007aff;">Lote</th>
              <th style="padding: 10px; color:#007aff;">Caducidad</th>
              <th style="padding: 10px; text-align: right; color:#007aff;">Stock</th>
              <th style="padding: 10px; text-align: center; color:#007aff;">AcciÃ³n</th>
            </tr>
          </thead>
          <tbody id="tablaDetalleBody"></tbody>
        </table>
      </div>
      <div style="margin-top: 25px; text-align: right; border-top: 1px solid #eee; padding-top: 15px;">
        <button onclick="cerrarModalGenerico('modalDetalleUbicacion')" class="btn-field" style="background: #e5e5ea; color: #333; width:auto; display:inline-flex;">Cerrar Detalle</button>
      </div>
    </div>
  </div>

  <div id="modalReubicacion" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <span style="font-size: 3rem;">ğŸšš</span>
        <h3>UbicaciÃ³n con Existencias</h3>
        <p style="color: #666;">Para eliminar, primero mueve el contenido.</p>
      </div>
      <div class="form-group"><label>Mover todo a:</label> <select id="selectDestinoReubicacion" class="input-modern"></select></div>
      <div style="display: flex; gap: 10px;">
        <button onclick="cerrarModalGenerico('modalReubicacion')" class="btn-field" style="flex: 1; background:#e5e5ea; border:none;">Cancelar</button>
        <button onclick="confirmarReubicacion()" class="btn-field" style="flex: 1; background:#ff3b30; color:white; border:none;">Mover y Eliminar</button>
      </div>
    </div>
  </div>

  <div id="modalTransferencia" class="modal-overlay" style="display: none; z-index: 1001;">
    <div class="modal-content" style="max-width: 450px; border-radius: 12px; padding: 0; overflow: hidden;">
      <div style="background: #007aff; padding: 15px 20px;">
        <h3 style="margin:0; color: white; font-size: 1.1rem; text-align:center;">Transferir MercancÃ­a</h3>
      </div>
      <div style="padding: 25px;">
        <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #cce5ff;">
          <strong id="txtProductoTransf" style="display:block; font-size: 1rem; margin-bottom: 4px; color:#004085;">Producto</strong>
          <span id="txtLoteTransf" style="color: #666; font-size: 0.9rem;">Lote: ---</span>
        </div>
        <div class="form-group">
          <label>Â¿CuÃ¡ntas piezas vas a mover?</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="number" id="cantTransferir" placeholder="0" min="1" step="1" class="input-modern" oninput="calcularSimulacionTransferencia()">
            <span style="font-weight: bold; color: #555; font-size:1.1rem;">Pzas.</span>
          </div>
        </div>
        <div style="font-size: 0.85rem; color: #666; margin-bottom: 25px; display: flex; justify-content: space-between; padding: 0 5px;">
           <span>Equivale a: <strong id="lblEquivalencia" style="color:#007aff;">0 L</strong></span>
           <span>QuedarÃ¡n: <strong id="lblRestante">---</strong></span>
        </div>
        <div class="form-group"><label>Destino:</label>
        <select id="selDestinoTransf" class="input-modern"></select></div>
        <div style="display: flex; gap: 12px;">
          <button onclick="cerrarModalGenerico('modalTransferencia')" class="btn-field" style="flex:1; background:#f1f3f5; border:none;">CANCELAR</button>
          <button onclick="confirmarTransferencia()" class="btn-field" style="flex:1; background:#007aff; color:white; border:none;">CONFIRMAR â¡ï¸</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalTransformacion" class="modal-overlay" style="display: none; z-index: 1002;">
    <div class="modal-content" style="max-width: 500px; padding: 0; overflow: hidden;">
      <div style="background: #9b59b6; padding: 15px 20px;">
        <h3 style="margin:0; color: white; text-align:center;">ğŸ› ï¸ Transformar / Reetiquetar</h3>
      </div>
      <div style="padding: 20px;">
        <div style="background: #f3e5f5; padding: 10px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9b59b6;">
          <small style="color:#8e24aa; font-weight:bold; text-transform:uppercase;">Origen:</small>
          <div id="lblTransfOrigen" style="font-weight:600; color:#333;">Producto A</div>
          <div id="lblTransfLote" style="font-size:0.85rem; color:#666;">Lote: ---</div>
        </div>
        <div style="display:flex; gap:15px; margin-bottom:15px;">
           <div style="flex:1">
             <label style="font-weight:bold; display:block; margin-bottom:5px;">A tomar (Piezas):</label>
             <input type="number" id="cantTransfPiezas" placeholder="0" class="input-modern" oninput="calcTransf()">
           </div>
           <div style="flex:1; padding-top:28px;">
             <span style="color:#666;">= </span><strong id="lblTransfLitros" style="color:#9b59b6;">0.00 L</strong>
           </div>
        </div>
        <hr style="border:0; border-top:1px dashed #ccc; margin: 15px 0;">
        <h4 style="margin:0 0 10px 0; color:#333;">Â¿En quÃ© se convierte?</h4>
        
        <div class="form-group"><label>Nuevo Producto:</label>
        <div style="display: flex; gap: 8px; align-items: center;">
          <select id="selTransfNuevoProd" class="input-modern"></select>
          <button onclick="abrirModalDesdeTransf()" class="btn-field" style="width:45px; height:45px; background:#007aff; color:white; border:none; font-size:1.5rem;">+</button>
        </div></div>

        <div class="form-group"><label>Nueva PresentaciÃ³n:</label>
        <select id="selTransfNuevaPres" class="input-modern" onchange="calcTransf()"></select></div>

        <div class="form-group"><label>Nuevo Lote (Opcional):</label>
        <input type="text" id="inputTransfNuevoLote" class="input-modern" placeholder="Deja vacÃ­o para conservar el mismo lote"></div>

        <div style="margin-top:15px; text-align:right; font-size:0.9rem; color:#555;">
           Resultado estimado: <strong id="lblTransfResultado" style="color:#2ecc71;">0 Piezas nuevas</strong>
        </div>

        <div style="display: flex; gap: 10px; margin-top:20px;">
          <button onclick="cerrarModalGenerico('modalTransformacion')" class="btn-field" style="flex:1; background:#f1f3f5; border:none;">Cancelar</button>
          <button onclick="confirmarTransformacion()" class="btn-field" style="flex:1; background:#9b59b6; color:white; border:none;">ğŸ› ï¸ Transformar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalConfirmarMasivo" class="modal-overlay" style="display: none; z-index: 1005;">
    <div class="modal-content" style="max-width: 350px; text-align: center; padding: 25px;">
      <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ’¾</div>
      <h3 style="margin: 0 0 10px 0; color: #333;">Â¿Guardar Cambios?</h3>
      <p style="color: #666; margin-bottom: 20px;">
        Vas a procesar <strong id="lblCantMasiva" style="color:#007aff; font-size:1.2rem;">0</strong> partidas.
      </p>
      <div style="display: flex; gap: 10px;">
        <button onclick="cerrarModalGenerico('modalConfirmarMasivo')" class="btn-field" style="flex:1; background:#f1f3f5; border:none; color:#555;">Cancelar</button>
        <button onclick="ejecutarGuardadoMasivo()" class="btn-field" style="flex:1; background:#2ecc71; border:none; color:white;">SÃ­, Guardar</button>
      </div>
    </div>
  </div>

<div id="modalLogistica" class="modal-overlay" style="display: none; z-index: 2000;">
    <div class="modal-content" style="max-width: 700px; padding: 0;">
      <div style="background: #333; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color: white;">ğŸ“¦ Checkout / EnvÃ­o</h3>
        <button onclick="cerrarModalGenerico('modalLogistica')" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>

      <div style="padding: 20px; max-height: 80vh; overflow-y: auto;">
        
        <h4 style="margin-top:0; color:#007aff; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ‘¤ Destinatario</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
          
          <div style="grid-column: 1 / -1;">
            <label style="font-size:0.85rem; font-weight:bold;">Buscar Cliente:</label>
            <select id="log_cliente_select" class="input-modern" onchange="alSeleccionarCliente()" style="background:#eef1f6;">
               <option value="">-- Nuevo Cliente --</option>
            </select>
          </div>

          <div><input type="text" id="log_nombre" class="input-modern" placeholder="Nombre Contacto *"></div>
          <div><input type="text" id="log_empresa" class="input-modern" placeholder="Empresa"></div>
          <div style="grid-column: 1 / -1;"><input type="text" id="log_direccion" class="input-modern" placeholder="DirecciÃ³n Completa *"></div>
          <div><input type="text" id="log_telefono" class="input-modern" placeholder="TelÃ©fono"></div>
          <div><input type="text" id="log_email" class="input-modern" placeholder="Email"></div>
          
          <div style="grid-column: 1 / -1; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="log_guardar_cliente">
            <label for="log_guardar_cliente" style="font-size:0.85rem; color:#666;">Guardar en agenda</label>
          </div>
        </div>

        <h4 style="margin-top:0; color:#d63031; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸšš PaqueterÃ­a</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
          
          <div>
            <label style="font-size:0.8rem;">Tipo</label>
            <select id="log_tipo_envio" class="input-modern">
              <option value="Nacional">Nacional</option><option value="Internacional">Internacional</option>
            </select>
          </div>
          <div><label style="font-size:0.8rem;">PaqueterÃ­a</label><input type="text" id="log_paqueteria" class="input-modern" placeholder="DHL/Fedex"></div>
          <div><label style="font-size:0.8rem;">Costo ($)</label><input type="number" id="log_costo" class="input-modern" placeholder="0.00"></div>
          
          <div style="grid-column: 1 / -1;">
            <label style="font-size:0.8rem;">GuÃ­a / Rastreo</label>
            <input type="text" id="log_guia" class="input-modern" placeholder="NÃºmero de guÃ­a" style="font-family:monospace; font-weight:bold;">
          </div>
        </div>

        <div style="margin-top: 20px; text-align:right;">
          <button onclick="confirmarPedidoCompleto()" class="btn-field" style="width:100%; background:#2ecc71; color:white; border:none; font-size:1.1rem;">âœ… FINALIZAR ORDEN</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalDetallePedido" class="modal-overlay" style="display: none; z-index: 2001;">
    <div class="modal-content" style="max-width: 650px; padding:0;">
      <div style="background: #007aff; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color: white;" id="tituloDetallePedido">Pedido #...</h3>
        <button onclick="cerrarModalGenerico('modalDetallePedido')" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
      </div>
      
      <div style="padding: 20px; max-height: 80vh; overflow-y: auto;">
        <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9rem;">
          <strong id="det_cliente">Cliente: ...</strong><br>
          <span id="det_direccion" style="color:#666;">DirecciÃ³n...</span><br>
          <span id="det_guia" style="font-family:monospace; color:#d63031;">GuÃ­a: ...</span>
        </div>

        <h4 style="margin:0 0 10px 0; color:#333;">ğŸ“¦ Contenido</h4>
        <table style="width:100%; font-size:0.85rem; border-collapse:collapse; margin-bottom:20px;">
          <thead>
            <tr style="border-bottom:2px solid #eee; text-align:left; color:#888;">
              <th style="padding:5px;">Producto</th>
              <th style="padding:5px;">Lote</th>
              <th style="padding:5px; text-align:right;">Cant.</th>
            </tr>
          </thead>
          <tbody id="tablaItemsPedido"></tbody>
        </table>

        <hr style="border:0; border-top:1px dashed #ccc; margin: 15px 0;">

        <h4 style="margin:0 0 10px 0; color:#333;">ğŸ“… Seguimiento</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div>
            <label style="font-size:0.8rem; font-weight:bold;">Fecha Estimada:</label>
            <input type="date" id="det_fecha_est" class="input-modern">
          </div>
          <div>
            <label style="font-size:0.8rem; font-weight:bold;">Fecha REAL Entrega:</label>
            <input type="date" id="det_fecha_real" class="input-modern">
          </div>
          <div style="grid-column: 1 / -1;">
            <label style="font-size:0.8rem; font-weight:bold;">Estatus:</label>
            <select id="det_estatus" class="input-modern">
              <option value="Pendiente">ğŸŸ¡ Pendiente</option>
              <option value="En Camino">ğŸ”µ En Camino</option>
              <option value="Entregado">ğŸŸ¢ Entregado</option>
              <option value="Cancelado">ğŸ”´ Cancelado</option>
            </select>
          </div>
        </div>

        <button onclick="guardarActualizacionPedido()" class="btn-field" style="width:100%; margin-top:20px; background:#007aff; color:white; border:none;">ğŸ’¾ Actualizar Seguimiento</button>
      </div>
    </div>
  </div>


  
  <div id="toast-container"></div>
  <?!= include('frontend/js'); ?>
</body>
</html>